
<!-- saved from url=(0067)https://www.cse.unsw.edu.au/~cs3311/19s1/lectures/05cont/notes.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<title>Programming with Databases</title>
<link href="./Week 05 Lecture (cont)_files/notes.css" rel="stylesheet" type="text/css">
<script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B&#31449;&#19979;&#36733;&#21161;&#25163;"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili &#21716;&#21737;&#21716;&#21737; B&#31449; &#19979;&#36733;&#21161;&#25163; &#24110;&#20320;&#19979;&#36733;&#29256;&#26435;&#21463;&#38480;&#65288;&#33021;&#30475;&#19981;&#33021;&#32531;&#23384;&#65289;&#30340; &#30058;&#21095; &#35270;&#39057;","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili&#21716;&#21737;&#21716;&#21737;&#19979;&#36733;&#21161;&#25163;","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"&#33719;&#21462;&#19979;&#36733;&#22320;&#22336;&#22833;&#36133;&#65292;&#21487;&#33021;&#26159;&#20020;&#26102;&#24615;&#30340;&#32593;&#32476;&#38382;&#39064;&#65292;&#21487;&#20197;&#23581;&#35797;&#28165;&#38500;&#27983;&#35272;&#22120;cookies&#21644;&#32531;&#23384;&#21518;&#37325;&#35797;&#65292;&#22914;&#22810;&#27425;&#37325;&#35797;&#20173;&#28982;&#25253;&#38169;&#65292;&#35831;&#36890;&#36807;&#37038;&#31665;&#25110;&#32773;QQ&#32676;&#21453;&#39304;&#32473;&#25105;&#65292;&#35874;&#35874;"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="&#35813;&#35270;&#39057;&#21482;&#33021;&#30331;&#38470;&#22823;&#20250;&#21592;&#36134;&#21495;&#20043;&#21518;&#19979;&#36733;&#65292;&#22914;&#30331;&#24405;&#21518;&#20173;&#28982;&#25253;&#38169;&#65292;&#21487;&#20197;&#23581;&#35797;&#28165;&#38500;&#27983;&#35272;&#22120;cookies&#21644;&#32531;&#23384;&#21518;&#37325;&#35797;",e):void 0!==e.code?e:{code:-2,message:"&#35813;&#35270;&#39057;&#26242;&#26102;&#19981;&#25903;&#25345;&#19979;&#36733;&#65292;&#21487;&#20197;&#23581;&#35797;&#28165;&#38500;&#27983;&#35272;&#22120;cookies&#21644;&#32531;&#23384;&#21518;&#37325;&#35797;&#65292;&#22914;&#22810;&#27425;&#37325;&#35797;&#20173;&#28982;&#25253;&#38169;&#65292;&#35831;&#36890;&#36807;&#37038;&#31665;&#25110;&#32773;QQ&#32676;&#21453;&#39304;&#32473;&#25105;&#65292;&#35874;&#35874;"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"&#39640;&#28165;1080P+",80:"&#39640;&#28165;1080P",74:"&#39640;&#28165;720P60",64:"&#39640;&#28165;720P",48:"&#39640;&#28165;720P",32:"&#28165;&#26224;480P",16:"&#27969;&#30021;360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> &#30340;&#19979;&#36733;&#22320;&#22336;(&#20849;${t.length}&#20010;&#20998;&#27573;)&#65306;`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_&#20998;&#27573;${n+1}" download href="${e.url}">&#20998;&#27573;${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_&#20998;&#27573;${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">&#20998;&#27573;${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">&#21512;&#24182;&#19979;&#36733;</a><span class="size">(&#20849;${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"&#21152;&#36733;&#20013;"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO &#25903;&#25345;&#21306;&#22495;</div>--\x3e\n            <div class="donate">\n              <p>&#24494;&#20449;&#25195;&#19968;&#25195;&#36190;&#36175;&#20316;&#32773;(&#25195;&#19981;&#20986;&#26469;&#35831;&#28857;&#20987;&#22270;&#29255;&#21518;&#25195;&#22823;&#22270;)&#65306;</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="&#28857;&#20987;&#26597;&#30475;&#22823;&#22270;" alt="&#28857;&#20987;&#26597;&#30475;&#22823;&#22270;" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B&#31449;&#19979;&#36733;&#21161;&#25163;</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">&#28165;&#26224;&#24230;&#65306;</span>\n                <span>&#35831;&#22312;&#39029;&#38754;&#20013;B&#31449;&#33258;&#24049;&#30340;&#25773;&#25918;&#22120;&#20869;&#20999;&#25442;&#28165;&#26224;&#24230;</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">&#19979;&#36733;&#27169;&#24335;&#65306;</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> &#39640;&#32423;</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> &#20860;&#23481;</label>\n                <p class="desc">&#39640;&#32423;&#27169;&#24335;&#25903;&#25345;&#33258;&#21160;&#37325;&#21629;&#21517;&#21644;&#21512;&#24182;&#19979;&#36733;&#65292;&#20294;&#20250;&#21344;&#29992;&#38750;&#24120;&#22823;&#30340;&#31995;&#32479;&#36816;&#34892;&#20869;&#23384;<br/>&#20860;&#23481;&#27169;&#24335;&#30452;&#25509;&#20351;&#29992;&#27983;&#35272;&#22120;&#30340;&#40664;&#35748;&#19979;&#36733;&#65292;&#36164;&#28304;&#21344;&#29992;&#24456;&#23567;&#65292;&#20294;&#19981;&#25903;&#25345;&#33258;&#21160;&#37325;&#21629;&#21517;&#21644;&#21512;&#24182;&#19979;&#36733;</p>\n                <p class="desc">&#24314;&#35758;&#31995;&#32479;&#36816;&#34892;&#20869;&#23384;&#23567;&#20110;16G&#30340;&#29992;&#25143;&#20351;&#29992;&#20860;&#23481;&#27169;&#24335;&#65292;&#19979;&#36733;&#21518;&#21487;&#20197;&#28857;<a href="http://csser.top/bilibili/merge.html" target="_blank">&#36825;&#37324;</a>&#23581;&#35797;&#25163;&#21160;&#21512;&#24182;</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">&#21512;&#24182;&#19979;&#36733;&#65306;</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> &#24320;</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> &#20851;</label>\n                <p class="desc">&#39640;&#32423;&#27169;&#24335;&#19979;&#36733;&#36807;&#31243;&#20013;&#35831;<strong style="color: red;">&#19981;&#35201;</strong>&#21047;&#26032;&#25110;&#20851;&#38381;&#39029;&#38754;&#65292;&#20063;<strong style="color: red;">&#19981;&#35201;</strong>&#20999;&#25442;&#20998;&#38598;&#21644;&#28165;&#26224;&#24230;</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"&#21152;&#36733;&#20013;"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                &#22914;&#26524;&#36825;&#20010;&#24037;&#20855;&#30830;&#23454;&#24110;&#21040;&#20102;&#24744;&#65292;&#28902;&#35831;&#22312;Chrome&#21830;&#24215;&#32473;&#20010;&#20116;&#26143;&#22909;&#35780;&#65292;&#35874;&#35874;&#128522;\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">&#21435;&#35780;&#20215;</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"&#25171;&#24320;B&#31449;&#19979;&#36733;&#21161;&#25163;":"&#25910;&#36215;"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="&#25910;&#36215;",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="&#25171;&#24320;B&#31449;&#19979;&#36733;&#21161;&#25163;",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` &#27491;&#22312;&#19979;&#36733; - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" &#24050;&#19979;&#36733;&#23436;&#25104;";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`&#20998;&#27573;${n+1} (${m(t)}) &#27491;&#22312;&#19979;&#36733;`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`&#20998;&#27573;${n+1} (${m(t)}) &#27491;&#22312;&#19979;&#36733; - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`&#20998;&#27573;${n+1} (${m(t)}) &#24050;&#19979;&#36733;&#23436;&#25104;&#65292;&#31561;&#24453;&#21512;&#24182;`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="&#24050;&#23436;&#25104;"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"&#33719;&#21462;&#35270;&#39057;&#20449;&#24687;&#22833;&#36133;&#65292;&#21487;&#20197;&#23581;&#35797;&#28165;&#38500;&#27983;&#35272;&#22120;cookies&#21644;&#32531;&#23384;&#21518;&#37325;&#35797;&#65292;&#22914;&#22810;&#27425;&#37325;&#35797;&#20173;&#28982;&#25253;&#38169;&#65292;&#35831;&#36890;&#36807;&#37038;&#31665;&#25110;QQ&#32676;&#21453;&#39304;&#32473;&#25105;&#65292;&#35874;&#35874;"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<p><span class="title">Programming with Databases</span></p><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading"> PHP</span></td><td align="right"><small>1/54</small></td></tr></tbody></table>
</p><p>
PHP has a reputation as a web-scripting language.
</p><p>
However, it also works as a general-purpose scripting language.
</p><p>
Later versions (since PHP5) also have a strong object model.
</p><p>
Undeserved reputation: toy, poorly-designed language.
</p><p>
Poor design may be true of some PHP libraries. <br>
The language itself, however, has many good aspects.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">...  PHP</span></td><td align="right"><small>2/54</small></td></tr></tbody></table>
</p><p>
PHP scripts consist of
</p><p></p><pre><comment>#!/usr/bin/php</comment>
&lt;?
... <i>PHP code</i> ...
?&gt;
</pre><p>
<small>(<large><code>#!</code></large> line is optional)</small>
</p><p>
Can be executed from command-line via:
</p><p></p><pre>$ php script.php
$ chmod 755 script.php
$ ./script.php
</pre><p>
<large><code>$argv[]</code></large> contains command-line parameters.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">...  PHP</span></td><td align="right"><small>3/54</small></td></tr></tbody></table>
</p><p>
Execution environment of PHP scripts:
</p><p></p><div class="center">
<img alt="[Diagram:Pic/php/php-execution-small.png]" src="./Week 05 Lecture (cont)_files/php-execution-small.png">
</div><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">...  PHP</span></td><td align="right"><small>4/54</small></td></tr></tbody></table>
</p><p>
PHP web scripts are a mixture of HTML and PHP code ...
</p><ul>
<li> stored on web server <small>(Apache)</small> under its DocumentRoot
</li><li> invoked via URL (<large><code>http://server/a/b/script.php</code></large>)
</li><li> parameters passed either via <large><code>GET</code></large> or <large><code>PUT</code></large>
</li><li> executed in an engine (Zend) inside the web server
</li><li> with environment/privileges of web server process
</li><li> having access to cookies (on client) and DBMSs (on server)
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">...  PHP</span></td><td align="right"><small>5/54</small></td></tr></tbody></table>
</p><p>
Architecture of typical Apache/PHP server:
</p><p>
</p><p></p><div class="center">
<img alt="[Diagram:Pic/php/php-arch-small.png]" src="./Week 05 Lecture (cont)_files/php-arch-small.png">
</div><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">From PHP to HTML</span></td><td align="right"><small>6/54</small></td></tr></tbody></table>
</p><p>
How the PHP engine treats a script:
</p><ul>
<li> scan the script from top to bottom; interpolate <large><code>require</code></large>d files
</li><li> any text <em>not</em> enclosed in <large><code>&lt;?...?&gt;</code></large> is copied to output
</li><li> any PHP expression enclosed in <large><code>&lt;?=</code></large><i>Expr</i><large><code>?&gt;</code></large> is evaluated, <br>
	and its string representation is copied to output
</li><li> any PHP code enclosed in <large><code>&lt;?</code></large><i>Statements;</i><large><code>?&gt;</code></large> is executed, <br>
	and any output it produces is sent to output
</li><li> first output is is preceded by HTTP header: <large><code>Content-type: text/html</code></large>
</li><li> <large><code>header()</code></large> function can be used to produce alternative HTTP header <br>
	<small>(if any output has already been sent when <large><code>header()</code></large> called, produces error)</small>
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... From PHP to HTML</span></td><td align="right"><small>7/54</small></td></tr></tbody></table>
</p><p>
Example PHP/HTML script:
</p><p></p><pre>&lt;html&gt;
&lt;? require("myDefinitions.php");
    $pageName = $_POST["name"]; $max = $_POST["max"];
?&gt;
&lt;body bgcolor='purple'&gt;
&lt;h1&gt;This is &lt;?=$pageName?&gt;&lt;/h1&gt;
&lt;? if ($max &lt;= 0) { ?&gt;
   &lt;b&gt;There are no numbers to display&lt;/b&gt;
&lt;? }
else {
    for ($i = 0; $i &lt;= $max; $i++)
        echo "$i&lt;br&gt;\n";
}
?&gt;
&lt;/body&gt;
&lt;/html&gt;
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... From PHP to HTML</span></td><td align="right"><small>8/54</small></td></tr></tbody></table>
</p><p>
Nowadays, most PHP usage in web application frameworks*
</p><ul>
<li> using MVC design pattern
</li><li> providing overarching control of web app <small>(C=control)</small>
</li><li> template-based HTML rendering <small>(V=view)</small>
</li><li> providing DBMS-independent DB access <small>(M=model)</small>
<ul>
<li> often via Active Record pattern
</li><li> and also providing SQL constructing functions
</li></ul>
</li><li> and, of course, interface to JavaScript &amp; CSS libraries
</li></ul>
* e.g. CodeIgniter, Yii, Symfony, Laravel, Zend, CakePHP, .....
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The PHP Language</span></td><td align="right"><small>9/54</small></td></tr></tbody></table>
</p><p>
The PHP language has the following characteristics:
</p><ul>
<li> C-like syntax
	&nbsp; <small>(with some Perl flavour)</small>
</li><li> "loose" attitude to types
	&nbsp; <small>(determined by context)</small>
</li><li> very easy to manipulate strings
</li><li> associative arrays
	&nbsp; <small>(cf. Perl's hashes)</small>
</li><li> extensive libraries of functions
	&nbsp; <small>(2000 page manual)</small>
</li><li> supports object-orientation
	&nbsp; <small>(cf. Perl)</small>
</li><li> comments introduced via <large><code>#</code></large> or <large><code>//</code></large>
</li></ul>
Syntactically: "a simpler, more uniform version of Perl".
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... The PHP Language</span></td><td align="right"><small>10/54</small></td></tr></tbody></table>
</p><p>
When PHP programs are executed in a Web server ...
</p><p>
The HTTP request supplies the parameters. <br>
<small>(or they're available in <large><code>$argv[]</code></large> if run from the command-line)</small>
</p><p>
CGI params available in arrays <large><code>$_GET</code></large>, <large><code>$_POST</code></large>, <large><code>$_REQUEST</code></large>.
</p><p>
Example:
</p><p></p><pre>http://server/user/list.php?name=John&amp;age=21
</pre><p>
In the script, the parameters would be accessed as:
</p><p></p><pre>print "Name is $_REQUEST[name]\n";
print "Age is ".$_REQUEST['age']."\n";
print "Name: $_GET[name] Age: $_GET[age]\n";
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Variables</span></td><td align="right"><small>11/54</small></td></tr></tbody></table>
</p><p>
No variable declarations are required.
</p><p>
Variables are created by assigning a value to them.
</p><p>
All variable names are preceded by <large><code>$</code></large>
	&nbsp; <small>(note: <large><code>$i</code></large>, <large><code>$i++</code></large>, <large><code>$++i</code></large>)</small>
</p><p>
The type of a variable is that of the last assigned value.
</p><p>
Check/set variable <em>type</em> via <large><code>gettype</code></large>/<large><code>settype</code></large> functions.
</p><p>
Convert variable <em>value</em> via casting
	&nbsp; <small>(e.g. <large><code>(int)</code></large>, <large><code>(string)</code></large>, ...)</small>
</p><p>
Default value of unassigned variable is &nbsp; <large><code>null</code></large> &nbsp; <small>(distinguished constant)</small> <br>
<small>(if unset variable used, get <large><code>0</code></large> or <large><code>""</code></large> or <large><code>false</code></large>, depending on context, and error in log)</small>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Variables</span></td><td align="right"><small>12/54</small></td></tr></tbody></table>
</p><p>
<b>Examples:</b>
</p><p></p><pre>$foo = 3;          <comment># $foo is an int, value 3</comment>

$foo = "8";        <comment># $foo is now a string, value "8"</comment>

$foo = $foo + 2;   <comment># $foo is now an int, value 10</comment>

$foo = "$foo green bottles";
                   <comment># $foo is now "10 green bottles"</comment>

$foo = 3.0 * $foo; <comment># $foo is now double, value 30.0</comment>

$foo = (int)$foo;  <comment># $foo is now an int, value 30</comment>
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Variables</span></td><td align="right"><small>13/54</small></td></tr></tbody></table>
</p><p>
Lifetime of all variables is the current script.
</p><p>
Variables defined outside any function:
</p><ul>
<li> have global scope (over whole to script)
</li><li> but are not accessible within functions unless "requested":
<p></p><pre>function f() { global $max_num, $colour; .... }
</pre><p>
</p></li></ul>
"Super-global" arrays
	<small>(e.g. <large><code>$_GET</code></large>, <large><code>$_PUT</code></large>, <large><code>$_SERVER</code></large>, <large><code>$_COOKIE</code></large>, ...):</small>
<ul>
<li> contain "environment" values <small>(CGI params, server ENV, request data)</small>
</li><li> are accessible from anywhere in the script
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Constants</span></td><td align="right"><small>14/54</small></td></tr></tbody></table>
</p><p>
Constants are defined using the <large><code>define()</code></large> function
</p><ul>
<li> may only evaluate to scalar type values <small>(e.g. int,float,string)</small>
</li><li> have case-senstive names; written without dollar sign (<large><code>$</code></large>)
</li><li> are always available globally  <small>(like super-globals)</small>
</li><li> may not be redefined or undefined once they have been set
</li></ul>
<p></p><pre>define("CONSTANT", "Hello world.");
define("MaxLevel", 6);
echo CONSTANT; <comment>// outputs "Hello world."</comment>
echo Constant; <comment>// outputs "Constant" and gives error</comment>
if ($i &gt; MaxLevel) { echo "Yes"; }
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Types</span></td><td align="right"><small>15/54</small></td></tr></tbody></table>
</p><p>
Four scalar types:
</p><ul>
<li> boolean, with values <large><code>true</code></large> and <large><code>false</code></large> <small>(case-insensitive)</small>
<ul>
<li> uses C-like interpretation for <large><code>false</code></large> (i.e. <large><code>0</code></large>, <large><code>""</code></large>, ...)
</li><li> all non-zero values are treated as <large><code>true</code></large> <br>
	<small>(beware: this includes negative error status values)</small>
</li></ul>
</li><li> integer, e.g. <large><code>0</code></large>, <large><code>1</code></large>, <large><code>-999</code></large>, ...
	&nbsp; <small>(standard 32-bit int format)</small>
</li><li> float, e.g. <large><code>3.14</code></large>, <large><code>2.0e6</code></large>, ...
	&nbsp; <small>(IEEE floating point format)</small>
</li><li> string ... <small>(see next slide)</small>
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Strings</span></td><td align="right"><small>16/54</small></td></tr></tbody></table>
</p><p>
Strings: sequences of characters, similar to Perl
</p><ul>
<li> double-quoted strings (<large><code>"..."</code></large>) permit interpolation, e.g.
<p></p><pre><small>
$x = 5;  print "Value of x is <font color="#CC0000">$x</font>\n";
<comment>// prints "Value of x is 5"</comment>
</small></pre><p>
</p></li><li> single-quoted strings (<large><code>'...'</code></large>) don't do interpolation
<p></p><pre><small>
$x = 5;  print 'Value of x is $x\n';
<comment>// prints "Value of x is $x"</comment>
</small></pre><p>
</p></li><li> non-quoted "strings" (<large><code>abc</code></large>)
	&nbsp; <small>(only work in some contexts)</small>
</li></ul>
<small>
Notes: <br>
* non-quoted strings look like C/Java variables;
PHP variables look like <large><code>$abc</code></large> <br>
* non-quoted strings are actually an error;
normally used for constants; <br>
&nbsp;&nbsp; in some contexts they produce a value which is the same as their name
</small>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>17/54</small></td></tr></tbody></table>
</p><p>
Strings <small>(cont)</small>
</p><p>
"heredoc" strings available for large multi-line strings
</p><p></p><pre>print &lt;&lt;&lt;XYZ
This is a "here" document. It can contain
many lines of text, with interpolation.
Such as the value of x is <font color="#CC0000">$x</font>
With any old "quotes' the we ``like''
XYZ;

$str = &lt;&lt;&lt;aLongString
This is my "long" string.
Ok, it's not really so long
aLongString;
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>18/54</small></td></tr></tbody></table>
</p><p>
When variables are used inside a <large><code>"..."</code></large> string or heredoc
</p><ul>
<li> their value is interpolated into the string
</li><li> after being converted to a suitable string representation
</li></ul>
Example:
<p></p><pre>$a = 1;  $b = 3.5;  $c = "Hello";
$str = "a:$a,  b:$b,  c:$c";
<comment>// now $str == "a:1, b:3.5, c:Hello"</comment>
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>19/54</small></td></tr></tbody></table>
</p><p>
Rules for interpolation and escape sequences:
</p><p><table border="0" cellpadding="6">
<tbody><tr valign="top">
 <td><nobr><large><code>"..."</code></large></nobr></td>
 <td></td><td>must escape embedded <large><code>"</code></large> via <large><code>\"</code></large> <br> escape sequences work <br> variable interpolation works</td>
</tr>
<tr valign="top">
 <td><nobr><large><code>'...'</code></large></nobr></td>
 <td></td><td>no variable interpolation <br> no escape sequences work <small>(including no <large><code>\'</code></large>)</small></td>
</tr>
<tr valign="top">
 <td><nobr>heredoc's</nobr></td>
 <td></td><td>no need to escape embedded <large><code>"</code></large> <br> escape sequences work <br> variable interpolation works</td>
</tr>
</tbody></table></p><p>
PHP escape sequences are like C/Java/Perl e.g. <large><code>\n</code></large>, <large><code>\t</code></large>, ...
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>20/54</small></td></tr></tbody></table>
</p><p>
Note that interpolation does occur in &nbsp; <large><code>"This is '$it'"</code></large>
</p><p>
I.e. <large><code>&lt;? $it = 5; print "This is '$it'"; ?&gt;</code></large> &nbsp;displays&nbsp; <large><code>This is '5'</code></large>
</p><p>
This is important in producing HTML in PHP since
attribute values for HTML tags should be quoted.
</p><p>
<b>Example</b>: we want to create a text input box to collect
a new value for parameter <large><code>name</code></large>, and display its current value:
</p><p></p><pre>print "&lt;input type='text' name='qty' value='$_GET[qty]'&gt;\n";
</pre><p>
Note: If the <large><code>qty</code></large> parameter is not set, then the <large><code>$_GET["qty"]</code></large>
will have no value, and the text box will be empty.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>21/54</small></td></tr></tbody></table>
</p><p>
Other operations on strings:
</p><p>
<large><code>.</code></large> <small>(dot)</small> for string concatentation <small>(cf. Perl's <large><code>.</code></large> or Java's <large><code>+</code></large>)</small>
</p><p></p><pre>$x = 127;
print "Result is ".sqrt($x)."\n";
</pre><p>
<large><code>trim()</code></large> removes whitespace from left and right ends of string
</p><p></p><pre><small>
<comment>// $s == "  blah  blah     "</comment>
$s = trim($s);
<comment>// $s == "blah  blah"</comment>
</small></pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Strings</span></td><td align="right"><small>22/54</small></td></tr></tbody></table>
</p><p>
More operations on strings:
</p><p>
<large><code>preg_split()</code></large> partitions string into array via Perl regexp
</p><p></p><pre><small>
<comment>// $s == "  ab  cde fg"</comment>
$a = preg_split('/\s+/',$s);
<comment>// $a[0]=="" &amp;&amp; $a[1]=="ab"</comment>
<comment>// &amp;&amp; $a[2]=="cde" $a[3]=="fg"</comment>
</small></pre><p>
<large><code>join()</code></large> assembles strings from an array
</p><p></p><pre><small>
<comment>// $a[0]=="" &amp;&amp; $a[1]=="ab"</comment>
<comment>// &amp;&amp; $a[2]=="cde" $a[3]=="fg"</comment>
$s = join(":",$a);
<comment>// $s == ":ab:cde:fg";</comment>
</small></pre><p>
Plus many others ... see PHP Manual for details.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Arrays</span></td><td align="right"><small>23/54</small></td></tr></tbody></table>
</p><p>
PHP arrays = sequence of values accessible via index.
</p><p>
Indexes can be values of any scalar type, incl. strings.
</p><p>
This provides both scalar and associative arrays <small>(hash tables)</small>.
</p><p>
E.g.
</p><p></p><pre>$a[0] = "abc";  $a[1] = 'def';  $a[2] = ghi;

$b['abc'] = 0;  $b[def] = 1;    $b["ghi"] = 2;
</pre><p>
</p><p><br></p><p>
PHP arrays are like <i>ordered</i> hash-tables.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Arrays</span></td><td align="right"><small>24/54</small></td></tr></tbody></table>
</p><p>
Arrays can be initialised element-at-a-time:
</p><p></p><pre><small>
$word[0]="a";  $word[1]="the";  $word[2]="this";

$mark["ann"]=100;  $mark["bob"]=50;  $mark["col"]=9;

$vec[]=1;  $vec[]=3;  $vec[]=5;  $vec[]=7;  $vec[] = 9;
<comment>// which is equivalent to</comment>
$vec[0]=1;  $vec[1]=3;  $vec[2]=5;  $vec[3]=7; $vec[4] = 9;
</small></pre><p>
Arrays can be initialised in a single statement:
</p><p></p><pre><small>
$word = array("a", "the", "this");

$marks = array("ann"=&gt;100, "bob"=&gt;50, "col"=&gt;9);

$vec = array(0 =&gt; 1, 1 =&gt; 3, 2 =&gt; 5, 3 =&gt; 7, 4 =&gt; 9);
<comment>// which is equivalent to</comment>
$vec = array(1, 3, 5, 7, 9);
</small></pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Arrays</span></td><td align="right"><small>25/54</small></td></tr></tbody></table>
</p><p>
Multiple values can be extracted from arrays via <large><code>list()</code></large>:
</p><p></p><pre>$a = array(5, 4, 3, 2, 1);
list($x,$y,$z) = $a;
<comment># $x==5, $y==4, $z==3</comment>
</pre><p>
Multi-dimensional arrays work ok <small>(array elements can be any type)</small>
</p><p></p><pre><small>
$fruits = array ( "fruits"  =&gt; array ( "a" =&gt; "orange"
                                     , "b" =&gt; "banana"
                                     , "c" =&gt; "apple"
                                     )
                , "numbers" =&gt; array ( 1,2,3,4,5,6 )
                , "holes"   =&gt; array (      "first"
                                     , 5 =&gt; "second"
                                     ,      "third"
                                     )
                );
</small></pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Arrays</span></td><td align="right"><small>26/54</small></td></tr></tbody></table>
</p><p>
Several mechanisms are available for iteration over arrays:
</p><p></p><pre><small>
for ($i = 0; $i &lt; count($word); $i++)
   print "word[$i] = $word[$i]\n";

foreach ($words as $w) print "next word = $w\n";

for (reset($marks); $name = key($marks); next($marks))
   print "Mark for $name = $marks[$name]\n";

reset($marks);
while (list($name,$val) = each($marks))
   print "Mark for $name = $val\n";

$elem = current($vec);
while ($elem) {
   print "Next elem is $elem\n";
   $elem = next($vec);
}
</small></pre><p>
<small>
First method only works if indexes are integers; missing values returned as <large><code>null</code></large>.
</small>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Arrays</span></td><td align="right"><small>27/54</small></td></tr></tbody></table>
</p><p>
Example: iterating over an array:
</p><p></p><pre>$marks = array("Ann"=&gt;95, "John"=&gt;75, "David"=&gt;60);

foreach ($marks as $name =&gt; $mark)
	echo "$name scored $mark%\n";

echo "Whole array: $marks\n";
</pre><p>
which displays:
</p><p></p><pre>Ann scored 95%
John scored 75%
David scored 60%
Whole array: Array
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Other PHP Types</span></td><td align="right"><small>28/54</small></td></tr></tbody></table>
</p><p>
PHP has standard notion of <em>class</em>: data values plus methods
</p><p></p><pre><small>
<comment>// creating an object of class foo</comment>
$x = new foo;  $x-&gt;method(1,'a');
</small></pre><p>
Resource: special type for references to external resources
</p><ul>
<li> e.g. database connections/cursors, file handles, ...
</li></ul>
NULL: a distinguished value <large><code>NULL</code></large> <small>(or <large><code>null</code></large>, case-insensitive)</small>
<ul>
<li> used to indicate that a variable exists but has no value
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Variable Checking</span></td><td align="right"><small>29/54</small></td></tr></tbody></table>
</p><p>
Functions to test properties of a variable ...
</p><p>
<large><code>isset($v)</code></large> ... <large><code>$v</code></large> has a non-NULL value <br>
<small>(can check whether an array has a value for a given index)</small>
</p><p>
<large><code>is_null($v)</code></large> ... <large><code>$v</code></large> has the value NULL
</p><p>
<large><code>empty($v)</code></large> ... <large><code>$v</code></large> has value NULL or 0 or "" or array()
</p><p>
<large><code>unset($v)</code></large> ... effectively removes variable <large><code>$v</code></large>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Variable Variables</span></td><td align="right"><small>30/54</small></td></tr></tbody></table>
</p><p>
PHP provides a way to dynamically create variable names.
</p><p>
Example:
</p><p></p><pre>for ($i = 0; $i &lt; $MAX; $i++) {
   $varname = "myVar$i";
   $value   = ${$varname};
   print "Value of $varname = $value\n";
}
</pre><p>
Accesses variables called &nbsp; <large><code>myVar0</code></large>, &nbsp; <large><code>myVar1</code></large>, &nbsp; <large><code>myVar2</code></large>, ...
</p><p>
<small>
Note: this is <em>not</em> the same as an array
&nbsp; <large><code>myVar[0]</code></large>, &nbsp; <large><code>myVar[1]</code></large>, &nbsp; <large><code>myVar[2]</code></large>, ...
</small>
</p><p>
Useful in e.g. HTML forms, where we may have a collection of 
variables that can't be represented by an array, but we
need to iterate over them ...
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Control Structures</span></td><td align="right"><small>31/54</small></td></tr></tbody></table>
</p><p>
Control structures have similar syntax to C/Perl/Java.
</p><p></p><pre><b>{</b> <i>Statement<sub>1</sub></i><b>;</b> <i>Statement<sub>2</sub></i><b>;</b> ... <b>}</b>

<b>if (</b><i>Expression<sub>1</sub></i><b>)</b> <i>Statement<sub>1</sub></i>
[<b>elseif (</b><i>Expression<sub>2</sub></i><b>)</b> <i>Statement<sub>2</sub></i> ...]
[<b>else</b> <i>Statement<sub>n</sub></i>]

<b>switch (</b><i>Expression<sub>1</sub></i><b>) {</b>
<b>case</b> <i>Value<sub>1</sub></i><b>:</b> <i>Statement<sub>1</sub></i><b>; break;</b> ...
[<b>case</b> <i>Value<sub>2</sub></i><b>:</b> <i>Statement<sub>2</sub></i><b>; break;</b> ...]
<b>}</b>

<b>while (</b><i>Expression</i><b>)</b> <i>Statement</i>
<b>for (</b><i>Init</i><b>;</b> <i>Test</i><b>;</b> <i>Next</i><b>)</b> <i>Statement</i>
<b>foreach (</b><i>ArrayVar</i> <b>as</b> [<i>KeyVar</i> <b>=<i&gt;< i=""></i&gt;<></b>] <i>ValVar</i><b>)</b> <i>Statement</i>
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Functions</span></td><td align="right"><small>32/54</small></td></tr></tbody></table>
</p><p>
Functions are defined as:
</p><p></p><pre><b>function</b> <i>FuncName</i><b>(</b><b>$</b><i>arg<sub>1</sub></i><b>,</b> <b>$</b><i>arg<sub>2</sub></i><b>,</b> ... <b>)</b>
<b>{</b>
   <i>Statement</i><b>;</b> ...
   <b>return</b> <i>Expression</i><b>;</b>
<b>}</b>
</pre><p>
Example:
</p><p></p><pre>// return array of first n integers
function iota($n)
{
   for ($i = 1; $i &lt;= $n; $i++)
      $list[] = $i;
   return $list;
}
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Functions</span></td><td align="right"><small>33/54</small></td></tr></tbody></table>
</p><p>
Notes on function definitions:
</p><ul>
<li> don't specify argument types or return type
</li><li> can specify default values for arguments
<ul>
<li> can omit arguments from right-to-left if default values given
</li><li> if no defaults are given, missing arguments generate errors
</li></ul>
</li><li> can handle variable-length argument lists <small>(like C's printf)</small>
<ul>
<li> using special functions <large><code>func_num_args()</code></large>, <large><code>func_get_arg()</code></large>, and <large><code>func_get_args()</code></large>
</li></ul>
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Functions</span></td><td align="right"><small>34/54</small></td></tr></tbody></table>
</p><p>
Example for default parameter values:
</p><p></p><pre>function makeCoffee($type="latte", $size="big") {
    return "Making a $size cup of $type.\n";
}
echo makeCoffee();
echo makeCoffee("cappucino");
echo makeCoffee("espresso","tiny");
</pre><p>
which will display
</p><p></p><pre>Making a big cup of latte.
Making a big cup of cappucino.
Making a tiny cup of espresso.
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... Functions</span></td><td align="right"><small>35/54</small></td></tr></tbody></table>
</p><p>
Example for variable length argument lists:
</p><p></p><pre>function foo() {
    $numargs = func_num_args();
    echo "Number of args: $numargs\n";
    if ($numargs &gt;= 2)
        echo "Second arg is: ",func_get_arg(1),"\n";
    $args = func_get_args();
    for ($i = 0; $i &lt; $numargs; $i++) 
        echo "Arg$i = $args[$i]  ";
}
foo(1, 'b', 3);
</pre><p>
which will display
</p><p></p><pre>Number of args: 3
Second arg is: b
Arg0 = 1  Arg1 = b  Arg2 = 3
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">Debugging</span></td><td align="right"><small>36/54</small></td></tr></tbody></table>
</p><p>
<large><code>print_r($v)</code></large> displays representation of <large><code>$v</code></large>'s value
</p><p>
<large><code>var_dump($v)</code></large> displays more info on <large><code>$v</code></large>'s value
</p><p>
<large><code>error_reporting(</code></large><i>Level</i><large><code>)</code></large> controls how much error display
</p><p>
<large><code>@func()</code></large> executes <large><code>func()</code></large> and supresses error reporting
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">PHP and Databases</span></td><td align="right"><small>37/54</small></td></tr></tbody></table>
</p><p>
To interact with databases, PHP needs ways to:
</p><ul>
<li> establish a connection with a database <small>(authentication)</small>
</li><li> construct SQL statements from program values
</li><li> send SQL statements to the DBMS for execution
</li><li> for updates, check how many tuples affected
</li><li> for queries, iterate through the result tuples
</li><li> extract fields from returned tuples
</li></ul>
<small>
Different database libraries all handle these slightly differently.
</small>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">PHP and PostgreSQL</span></td><td align="right"><small>38/54</small></td></tr></tbody></table>
</p><p>
PHP has a library of functions for PostgreSQL interaction.
</p><p>
Follow typical PL/DBMS interaction pattern:
</p><ul>
<li> send SQL query, retrieve results one-at-a-time
</li><li> access to database and result-set metadata
</li></ul>
Obvious problem: code written using it is non-portable.
<p>
There is also a generic DB-access library called PDO.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... PHP and PostgreSQL</span></td><td align="right"><small>39/54</small></td></tr></tbody></table>
</p><p>
Most DB applications can be handled with just five functions:
</p><ul>
<li> <large><code>pg_connect()</code></large> ... connect to the database
</li><li> <large><code>pg_query()</code></large> ... send SQL statement for processing
</li><li> <large><code>pg_fetch_array()</code></large> ... retrieve the next result tuple
</li><li> <large><code>pg_num_rows()</code></large> ... count # rows in result
</li><li> <large><code>pg_affected_rows()</code></large> ... count # rows changed
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_connect</code></large> Function</span></td><td align="right"><small>40/54</small></td></tr></tbody></table>
</p><p>
<large><code>resource <b>pg_connect</b>(string</code></large> <i>ConnParams</i><large><code>)</code></large>
</p><ul>
<li> attempts to connect to database specified in <i>ConnParams</i>
</li><li> precise format of <i>ConnParams</i> depends on configuration, e.g.
<p></p><pre>$db = pg_connect("dbname=mydb");
<comment># or</comment>
$cp = "dbname=hisdb user=fred password=abc";
$db = pg_connect($cp);
</pre><p>
</p></li><li> returns a <large><code>resource</code></large>, which is used for DB interactions
</li><li> if any problems, returns 0 (illegal connection)
<ul>
<li> possible problems: invalid password, unknown DB, ...
</li></ul>
</li><li> the <large><code>pg_last_error()</code></large> function gives details of any error
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_query</code></large> Function</span></td><td align="right"><small>41/54</small></td></tr></tbody></table>
</p><p>
<large><code>resource <b>pg_query</b>(resource</code></large> <i>db</i><large><code>, string</code></large> <i>Stmt</i><large><code>)</code></large>
</p><ul>
<li> sends the SQL statement <i>Stmt</i> to the database <i>db</i>
</li><li> <i>Stmt</i> can be either a query or insert/delete/update
</li><li> returns a <large><code>resource</code></large>, which is either
<ul>
<li> a cursor on the result set for query
</li><li> nothing useful for insert/delete/update
</li></ul>
</li><li> if any problems, returns 0 (illegal cursor)
<ul>
<li> possible problems: invalid <i>db</i>, syntax errors in <i>Stmt</i>
</li></ul>
</li><li> subsequent attempts to use illegal cursor give PHP error
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... The <large><code>pg_query</code></large> Function</span></td><td align="right"><small>42/54</small></td></tr></tbody></table>
</p><p>
Example:
</p><p></p><pre>$unidb  = pg_connect("dbname=UniDB");
$query  = "select name
           from Staff where dept=2";
$result = pg_query($unidb, $query);
if (!$result)
   print "Something wrong with query!\n";
else
   // process the result set ...
</pre><p>
To find out exactly what was wrong with the query ...
</p><p></p><pre>if (!$result)
   print pg_last_error();
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_num_rows</code></large> Function</span></td><td align="right"><small>43/54</small></td></tr></tbody></table>
</p><p>
<large><code>int <b>pg_num_rows</b>(resource</code></large> <i>Result</i><large><code>)</code></large>
</p><ul>
<li> returns the number of tuples in a <large><code>pg_query</code></large> query result
</li><li> zero, if the <large><code>pg_query</code></large> statement was an update
</li></ul>
Example:
<p></p><pre>$query = "select * from Employees
          where department='Sales'";
$result = pg_query($db, $query);
if (!$result)
   print pg_last_error();
else if (pg_num_rows($result) &gt; 20)
   print "This is a very big department\n";
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_affected_rows</code></large> Function</span></td><td align="right"><small>44/54</small></td></tr></tbody></table>
</p><p>
<large><code>int <b>pg_affected_rows</b>(resource</code></large> <i>Result</i><large><code>)</code></large>
</p><ul>
<li> returns # modified tuples in a <large><code>pg_query</code></large> update
</li><li> zero, if the <large><code>pg_query</code></large> statement was a query
</li></ul>
Example:
<p></p><pre>$query = "delete from Enrolments
          where course='COMP3311'";
$result = pg_query($db, $query);
if (!$result)
   print pg_last_error();
else  {
   $nstudes = pg_affected_rows($result);
   print "Dropped $nstudes from COMP3311\n";
}
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_fetch_row</code></large> Function</span></td><td align="right"><small>45/54</small></td></tr></tbody></table>
</p><p>
<large><code>array <b>pg_fetch_row</b>(resource</code></large> <i>Res</i><large><code>, int </code></large><i>which</i><large><code>)</code></large>
</p><ul>
<li> fetches the <i>i<sup>th</sup></i> tuple in a query result set
</li><li> if no <i>which</i> argument, fetches next tuple
</li><li> returns an <large><code>array</code></large> value that can be treated as a result row
</li><li> fields are accessed by position; based on query select list
</li><li> if no more elements left, returns 0
</li></ul>
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... The <large><code>pg_fetch_row</code></large> Function</span></td><td align="right"><small>46/54</small></td></tr></tbody></table>
</p><p>
Example:
</p><p></p><pre>$query = "select id,name from Staff";
if ($result = pg_query($db, $query)) {
   $n = pg_num_rows($result);
   for ($i = 0; $i &lt; $n; $i++) {
      $item = pg_fetch_row($result,$i);
      print "Name=$item[1], StaffID=$item[0]\n";
   }
}
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">The <large><code>pg_fetch_array</code></large> Function</span></td><td align="right"><small>47/54</small></td></tr></tbody></table>
</p><p>
<large><code>array <b>pg_fetch_array</b>(resource</code></large> <i>Res</i><large><code>, int </code></large><i>which</i><large><code>)</code></large>
</p><ul>
<li> fetches the <i>i</i> th element (tuple) in a query result set
</li><li> returns an <large><code>array</code></large> value that can be treated as a result row
</li><li> array is indexed by field <i>names</i> as well as position
</li><li> if no more elements left, returns 0
</li><li> if no <i>which</i> argument, fetches next tuple
</li></ul>
<p></p><hr><p>

<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... The <large><code>pg_fetch_array</code></large> Function</span></td><td align="right"><small>48/54</small></td></tr></tbody></table>
</p><p>
Example:
</p><p></p><pre>$query = "select id,name from Staff";
if (!($result = pg_query($db, $query)))
   print "Error: ".pg_last_error();
else {
   $n = pg_num_rows($result);
   for ($i = 0; $i &lt; $n; $i++) {
      $item = pg_fetch_array($result,$i);
      $nm = $item["name"]; $id = $item["id"];
      print "Name=$nm, StaffID=$id\n";
   }
}
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="heading">COMP3311 Database Library</span></td><td align="right"><small>49/54</small></td></tr></tbody></table>
</p><p>
Problems:
</p><ul>
<li> constructing SQL statements from user-supplied data
</li><li> providing DBMS-independent interface to database
</li><li> handling transactions over multiple DB operations
</li></ul>
We define a small libary that solve the first two.
<p>
More sophisticated libraries (e.g. PDO) solve all three.
</p><p>
The third can often be solved via stored procedures.
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... COMP3311 Database Library</span></td><td align="right"><small>50/54</small></td></tr></tbody></table>
</p><p>
Functions in the COMP3311 database library:
</p><ul>
<li> accessDB(dbname): establish connection to DB
</li><li> dbQuery(db,sql): send SQL statement for execution
</li><li> dbNext(res): fetch next tuple from result set
</li><li> dbOneTuple(db,sql): run SQL to get a single tuple
</li><li> dbOneValue(db,sql): run SQL to get a single value
</li><li> dbUpdate(db,sql): send SQL insert/delete/update
</li><li> mkSQL(fmt,v1,v2,...): build an SQL statement string
</li></ul>
All functions terminate if an error occurs (debugging).
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... COMP3311 Database Library</span></td><td align="right"><small>51/54</small></td></tr></tbody></table>
</p><p>
Standard pattern for extracting data from DB:
</p><p></p><pre><font color="#009900">$db</font> = <font color="#0000CC">dbConnect</font>("dbname=<font color="#996600">myDB</font>");
...
$min = ...;
<font color="#009900">$query</font> = "<font color="#996600">select a,b,c from R where c &gt;= %d</font>";
<font color="#009900">$result</font> = <font color="#0000CC">dbQuery</font>(<font color="#009900">$db</font>, <font color="#0000CC">mkSQL</font>(<font color="#009900">$query</font>, $min));
while (<font color="#009900">$tuple</font> = <font color="#0000CC">dbNext</font>(<font color="#009900">$r</font>)) {
	list($a,$b,$c) = <font color="#009900">$tuple</font>;
	$tmp = $a - $b - $c;
	<comment># or ...</comment>
	$tmp = <font color="#009900">$tuple</font>["<font color="#996600">a</font>"] - <font color="#009900">$tuple</font>["<font color="#996600">b</font>"]
                           - <font color="#009900">$tuple</font>["<font color="#996600">c</font>"];
}
...
</pre><p>
</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... COMP3311 Database Library</span></td><td align="right"><small>52/54</small></td></tr></tbody></table>
</p><p>
My conventions for writing PHP/DB code:
</p><ul>
<li> <large><code>$q</code></large> is the SQL query template &nbsp;<small>(also for updates)</small>
</li><li> <large><code>$r</code></large> the query result handle &nbsp;<small>(a PHP <large><code>resource</code></large>)</small>
</li><li> <large><code>$t</code></large> is the current tuple &nbsp;<small>(array indexed by position and name)</small>
</li><li> invoking a query: &nbsp;<large><code>$r = dbQuery($db, mkSQL($q,</code></large><i>vars</i><large><code>));</code></large>
</li><li> extracting fields: &nbsp;<large><code>list($a,$b,$c,...) = $t;</code></large>
</li><li> will also sometimes use: &nbsp;<large><code>$a = $t["a"];</code></large> ...
</li></ul>
You don't have to follow these, but this is what examples look like.
<p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... COMP3311 Database Library</span></td><td align="right"><small>53/54</small></td></tr></tbody></table>
</p><p>
<large><code>string mkSQL(string </code></large><i>QueryTemplate</i><large><code>, any</code></large> <i>v<sub>1</sub></i><large><code>, any</code></large> <i>v<sub>2</sub></i><large><code>,</code></large> ...<large><code>)</code></large>
</p><ul>
<li> queries are often constructed by interpolating variables
</li><li> ensures that values are appropriately quoted/escaped
</li><li> uses <large><code>printf</code></large>-like mechanism for specifying interpolated values
</li></ul>
Example:
<p></p><pre><small>
$name = "O'Brien";
$tmpl = "select * from Employees".
        "where name = %s and salary &gt; %d";
$qry = mkSQL($tmpl, $name, 50000);
<comment>// which produces the query string</comment>
select * from Employees
where name = 'O''Brien' and salary &gt; 50000
</small></pre><p>

</p><p></p><hr><p>
<table width="100%" cellpadding="0">
<tbody><tr valign="top"><td align="left"><span class="cont">... COMP3311 Database Library</span></td><td align="right"><small>54/54</small></td></tr></tbody></table>
</p><p>
Example of use:
</p><p></p><pre><small>
$db = accessDB("mymyunsw");
$q = &lt;&lt;_SQL_
select s.sid, p.name
from   Students s, People p, Courses c,
       Subjects su, CourseEnrolments e, Terms t
where  s.id = p.id and e.student = s.id and
	e.course = c.id and c.subject = su.id
	and su.code = %s and c.term = t.id
	and t.year = %d and t.sess = %s
order by s.sid
_SQL_;
$sql = mkSQL($q, $subj, $year, $sess);
$r = dbQuery($db, $sql);
while ($t = dbNext($r)) echo "$t[sid] $t[name]\n";
</small></pre><p>
</p><p></p><hr><p>
<small><small>Produced: 20 Mar 2019</small></small>


</p></body></html>