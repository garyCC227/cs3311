<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0063)https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>COMP3311 19s1 - Exercises 04</title>
<link rel="stylesheet" type="text/css" href="./19s1 - Exercises 04_files/course.css"><script language="JavaScript">
function changeText(el, newText) {
  // Safari work around
  if (el.innerText)
    el.innerText = newText;
  else if (el.firstChild && el.firstChild.nodeValue)
    el.firstChild.nodeValue = newText;
}
function toggleVisible(elid) {
  el1 = document.getElementById(elid);
  el2 = document.getElementById(elid+"a");
  if (el1.style.display == "") {
     el1.style.display = "none";
     changeText(el2,"show answer");
  }
  else {
     el1.style.display = "";
     changeText(el2,"hide answer");
  }
}
</script><script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B站下载助手"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili 哔哩哔哩 B站 下载助手 帮你下载版权受限（能看不能缓存）的 番剧 视频","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili哔哩哔哩下载助手","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"加载中"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"加载中"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${m(t)}) 正在下载`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${m(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${m(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<div align="center">
<table width="100%" border="0">
<tbody><tr valign="top">
<td align="left" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">COMP3311 19s1</a></span>
</td>
<td align="center" width="50%">
  <span class="heading">Exercises 04</span><br>
  <span class="subheading">SQL Queries and Views</span>
</td>
<td align="right" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">Database Systems</a></span>
</td>
</tr></tbody></table>
</div><br>
<div class="note">
<b>Notation:</b> in the relational schemas below,
primary key attributes are shown in &nbsp; <tt><b>bold</b></tt> &nbsp; font,
foreign key attributes are shown in &nbsp; <tt><i>italic</i></tt> &nbsp; font,
and primary key attributes that are also foreign keys are
shown in &nbsp; <code><b><i>bold italic</i></b></code> &nbsp; font.
</div>
<div class="note">
<b>Note1:</b> all of these solutions have alternative
formulations. If you think you have a better solution
than the one(s) presented here, let me know.
<br>
<b>Note2:</b> a useful strategy, when developing an SQL solution
to an information request, is to express intermediate results as
views; this has been done in a few solutions here, but you might
like to consider reformulating more of them with views, for clarity.
</div>

<ol>

<li>
<p>
Consider the following relational schemas:
</p>
<pre>Suppliers(<b>sid</b>, sname, address)
Parts(<b>pid</b>, pname, colour)
Catalog(<b><i>sid</i></b>, <b><i>pid</i></b>, cost)
</pre>
Assume that the ids are integers,
that <code>cost</code> is a real number,
that all other attributes are strings,
that the <code><b><i>supplier</i></b></code> field 
is a foreign key containing a supplier id,
and
that the <code><b><i>part</i></b></code> field is a foreign key
containing a part id.
<p>
Write SQL statements to answer each of the following queries:
</p>
<ol type="a">
<li><p>
Find the <i>names</i> of suppliers who supply some red part.
</p>
<p><small>[<a id="q1a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q1&#39;)">show answer</a>]</small></p>
<div id="q1" style="color:#000099;display:none">
<pre>select S.sname
from   Suppliers S, Parts P, Catalog C
where  P.colour='red' and C.pid=P.pid and C.sid=S.sid
</pre>
or
<pre>select sname
from   Suppliers natural join Catalog natural join Parts
where  P.colour='red'
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply some red or green part.
</p>
<p><small>[<a id="q2a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q2&#39;)">show answer</a>]</small></p>
<div id="q2" style="color:#000099;display:none">
<pre>select C.sid
from   Parts P, Catalog C
where  (P.colour='red' or P.colour='green') and C.pid=P.pid
</pre>
or
<pre>select sid
from   Catalog C natural join Parts P
where  (P.colour='red' or P.colour='green')
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply some red part or
whose address is 221 Packer Street.
</p>
<p><small>[<a id="q3a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q3&#39;)">show answer</a>]</small></p>
<div id="q3" style="color:#000099;display:none">
<pre>select S.sid
from   Suppliers S
where  S.address='221 Packer Street'
       or S.sid in (select C.sid
                    from   Parts P, Catalog C
                    where  P.color='red' and P.pid=C.pid
                   )
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply some red part and some green part.
</p>
<p><small>[<a id="q4a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q4&#39;)">show answer</a>]</small></p>
<div id="q4" style="color:#000099;display:none">
<pre>select C.sid
from   Parts P, Catalog C
where  P.color='red' and P.pid=C.pid
       and exists (select P2.pid
                   from   Parts P2, Catalog C2
                   where  P2.color='green' and C2.sid=C.sid and P2.pid=C2.pid
                  )
</pre>
or
<pre>(select C.sid
 from Parts P, Catalog C
 where P.color='red' and P.pid=C.pid
)
intersect
(select C.sid
 from Parts P, Catalog C
 where P.color='green' and P.pid=C.pid
)
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply every part.
</p>
<p><small>[<a id="q5a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q5&#39;)">show answer</a>]</small></p>
<div id="q5" style="color:#000099;display:none">
<pre>select S.sid
from   Suppliers S
where  not exists((select P.pid from Parts P)
                  except
                  (select C.pid from Catalog C where C.sid=S.sid)
                 )
</pre>
or
<pre>select C.sid
from   Catalog C
where  not exists(select P.pid
                  from   Part P
                  where  not exists(select C1.sid
                                    from   Catalog C1
                                    where  C1.sid=C.sid and C1.pid=P.pid
                                   )
                 )
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply every red part.
</p>
<p><small>[<a id="q6a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q6&#39;)">show answer</a>]</small></p>
<div id="q6" style="color:#000099;display:none">
<pre>select S.sid
from   Suppliers S
where  not exists((select P.pid from Parts P where P.color='red')
                  except
                  (select C.pid from Catalog C where C.sid=S.sid)
                 )
</pre>
or
<pre>select C.sid
from   Catalog C
where  not exists(select P.pid
                  from   Part P
                  where  P.colour='red' and
                         not exists(select C1.sid
                                    from   Catalog C1
                                    where  C1.sid=C.sid and C1.pid=P.pid
                                   )
                 )
</pre>
</div>


</li><li><p>
Find the <i>sids</i> of suppliers who supply every red or green part.
</p>
<p><small>[<a id="q7a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q7&#39;)">show answer</a>]</small></p>
<div id="q7" style="color:#000099;display:none">
<pre>select S.sid
from   Suppliers S
where  not exists((select P.pid from Parts P
                   where P.color='red' or P.color='green')
                  except
                  (select C.pid from Catalog C where C.sid=S.sid)
                 )
</pre>
or
<pre>select C.sid
from   Catalog C
where  not exists(select P.pid
                  from   Part P
                  where  (P.colour='red' or P.colour='green') and
                         not exists(select C1.sid
                                    from   Catalog C1
                                    where  C1.sid=C.sid and C1.pid=P.pid
                                   )
                 )
</pre>
</div>

</li><li><p>
Find the <i>sids</i> of suppliers who supply every red part or supply every green part.
</p>
<p><small>[<a id="q8a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q8&#39;)">show answer</a>]</small></p>
<div id="q8" style="color:#000099;display:none">
<pre>(select S.sid
 from   Suppliers S
 where  not exists((select P.pid from Parts P where P.color='red')
                   except
                   (select C.pid from Catalog C where C.sid=S.sid)
                  )
)
union
(select S.sid
 from   Suppliers S
 where  not exists((select P.pid from Parts P where P.color='green')
                   except
                   (select C.pid from Catalog C where C.sid=S.sid)
                  )
)
</pre>
</div>

</li><li><p>
Find pairs of <i>sids</i> such that the supplier with the first <i>sid</i>
charges more for some part than the supplier with the second <i>sid</i>.
</p>
<p><small>[<a id="q9a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q9&#39;)">show answer</a>]</small></p>
<div id="q9" style="color:#000099;display:none">
<pre>select C1.sid, C2.sid
from   Catalog C1, Catalog C2
where  C1.pid = C2.pid and C1.sid != C2.sid and C1.cost &gt; C2.cost
</pre>
</div>

</li><li><p>
Find the <i>pids</i> of parts that are supplied by at least two
different suppliers.
</p>
<p><small>[<a id="q10a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q10&#39;)">show answer</a>]</small></p>
<div id="q10" style="color:#000099;display:none">
<pre>select C.pid
from   Catalog C
where  exists(select C1.sid
              from   Catalog C1
              where  C1.pid = C.pid and C1.sid != C.sid
             )
</pre>
</div>

</li><li><p>
Find the <i>pids</i> of the most expensive part(s) supplied by suppliers
named "Yosemite Sham".
</p>
<p><small>[<a id="q11a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q11&#39;)">show answer</a>]</small></p>
<div id="q11" style="color:#000099;display:none">
<pre>select C.pid
from   Catalog C, Suppliers S
where  S.sname='Yosemite Sham' and C.sid=S.sid and
       C.cost &gt;= all(select C2.cost
                     from   Catalog C2, Suppliers S2
                     where  S2.sname='Yosemite Sham' and C2.sid=S2.sid
                    )
</pre>
</div>

</li><li><p>
Find the <i>pids</i> of parts supplied by every supplier at a price less
than 200 dollars (if any supplier either does not supply the part or charges
more than 200 dollars for it, the part should not be selected).
</p>
<p><small>[<a id="q12a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q12&#39;)">show answer</a>]</small></p>
<div id="q12" style="color:#000099;display:none">
<pre>select C.pid
from   Catalog C
where  C.price &lt; 200.00
group by C.pid
having count(*) = (select count(*) from Suppliers);
</pre>
</div>
</li></ol>

</li><li>
<p>
Consider a schema that represents information about a University:
</p>
<pre>   Student(<b>id</b>, name, major, stage, age)
   Class(<b>name</b>, meetsAt, room, <i>lecturer</i>)
   Enrolled(<b><i>student</i></b>, <b><i>class</i></b>, mark)
   Lecturer(<b>id</b>, name, <i>department</i>)
   Department(<b>id</b>, name)
</pre>
<p>
Using this schema, write SQL queries to answer the following:
</p>

<ol type="a">
<li><p>
Find the names of all first-year (stage 1) students who are enrolled in a class
taught by Andrew Taylor.
</p>
<p><small>[<a id="q13a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q13&#39;)">show answer</a>]</small></p>
<div id="q13" style="color:#000099;display:none">
<pre>select S.name
from   Student S, Class C, Enrolled E, Lecturer L
where  S.id = E.student and E.class = C.name
       and C.lecturer = L.id and L.name = 'Andrew Taylor' and S.stage = 1;
</pre>
</div>

</li><li><p>
Find the age of the oldest student enrolled in any of John Shepherd's
classes.
</p>
<p><small>[<a id="q14a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q14&#39;)">show answer</a>]</small></p>
<div id="q14" style="color:#000099;display:none">
<pre>select max(age)
from   Student
where  id in (
          select student
          from  Class C, Enrolled E, Lecturer L
          where E.class = C.name and C.lecturer = L.id
                and L.name = 'John Shepherd'
       );
</pre>
This is done in a different style to the first query. It more closely
matches the english expression of the query but is most likely rather
less efficient.
<p>
Here is the join-based version:
</p><pre>select max(age)
from   Student S, Class C, Enrolled E, Lecturer L
where  S.id = E.student and E.class = C.name
       and C.lecturer = L.id and L.name = 'John Shepherd';
</pre>
</div>

</li><li><p>
Find the names of all classes that have more than 100 students enrolled.
</p>
<p><small>[<a id="q15a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q15&#39;)">show answer</a>]</small></p>
<div id="q15" style="color:#000099;display:none">
<pre>select   class
from     Enrolled
group by class
having   count(*) &gt; 100;
</pre>
</div>

</li><li><p>
Find the names of all students who are enrolled in two classes that
meet at the same time.
</p>
<p><small>[<a id="q16a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q16&#39;)">show answer</a>]</small></p>
<div id="q16" style="color:#000099;display:none">
<pre>select name
from   Student
where  id in (
          select e1.student
          from   Enrolled e1, Enrolled e2, Class c1, Class c2
          where  e1.student = e2.student and e1.class != e2.class
                 and e1.class = c1.name and e2.class = c2.name
                 and c1.meetsAt = c2.meetsAt
       );
</pre>
<p>
The subquery gets a list of ids for all students who are enrolled in
two classes that meet at the same time. The outer query then uses this
list to access the names from the <tt>Student</tt> relation. As before,
this expression of the query more closely matches the english version,
but is not particularly efficient.
</p>
<p>
The join-based version:
</p>
<pre>select name
from   Student S, Enrolled e1, Enrolled e2, Class c1, Class c2
where  S.id = e1.student and
       e1.student = e2.student and e1.class != e2.class
       and e1.class = c1.name and e2.class = c2.name
       and c1.meetsAt = c2.meetsAt;
</pre>
</div>

</li><li><p>
Find the names of faculty members for whom the combined enrollment
of the courses they teach is less than five.
</p>
<p><small>[<a id="q17a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q17&#39;)">show answer</a>]</small></p>
<div id="q17" style="color:#000099;display:none">
<pre>select name
from   Lecturer
where  5 &gt; (select count(id)
            from   Class, Enrolled
            where  name = class and lecturer = id);
</pre>
Alternative solution:
<pre>select l.name
from   Lecturer l, Class c, Enrolled e
where  l.id = c.lecturer and c.name = e.class
group by l.name
having count(student) &lt; 5;
</pre>
</div>

</li><li><p>
For each stage, print the stage and average age of students.
</p>
<p><small>[<a id="q18a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q18&#39;)">show answer</a>]</small></p>
<div id="q18" style="color:#000099;display:none">
<pre>select   stage, avg(age)
from     Student
group by stage;
</pre>
</div>

</li><li><p>
Find the names of students who are not enrolled in any class.
</p>
<p><small>[<a id="q19a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q19&#39;)">show answer</a>]</small></p>
<div id="q19" style="color:#000099;display:none">
<pre>select name
from   Student S
where  S.id not in (select E.student from Enrolled E);
</pre>
<small>(Note that it is not necessary to qualify the attribute
names here, so we could omit the tuple variables <tt>S</tt> and <tt>E</tt>). </small>
<p>
Alternative solution:
</p><pre>create view StudentClasses(id,name,nclasses) as
select s.id, s.name, count(class)
from   Student s left out join Enrolled e on (s.id=e.student)
group by s.id, s.name;

select name from StudentClasses where nclasses = 0;
</pre>
</div>

</li></ol>

</li><li>
<p>
Consider the following relations for keeping track of airline flights information:
</p>
<pre>   Flights(<b>flno</b>, from, to, distance, departs, arrives, price)
   Aircraft(<b>aid</b>, aname, cruisingRange)
   Certified(<b><i>employee</i></b>, <b><i>aircraft</i></b>)
   Employees(<b>eid</b>, ename, salary)
</pre>
<p>
Using this schema, write SQL queries to answer the following:
</p>

<ol type="a">
<li><p>
Find the names of aircraft such that all pilots certified to operate them earn more than 80,000.
</p>
<p><small>[<a id="q20a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q20&#39;)">show answer</a>]</small></p>
<div id="q20" style="color:#000099;display:none">
<pre>-- the set of pilots certified for this aircraft is a subset of the set
-- of pilots who earn more than 80K
select aname
from   Aircraft a
where  ((select employee from Certified where c.aircraft = a.aid)
        intersect
        (select eid from Employee where salary &gt; 80000))
        =
       (select employee from Certified where c.aircraft = a.aid)

-- there are no certified pilots for this aircraft earning less than 80K
select aname
from   Aircraft a
where  not exists(
         select eid
         from   Certified c, Employee e
         where  c.aircraft=a.id and c.employee=e.eid and e.salary&lt;=80000
       )
</pre>
</div>

</li><li><p>
For each pilot who is certified for more than 3 aircraft, find the pilot's
id and the maximum cruising range of the aircraft that he (or she) is
certified for.
</p>
<p><small>[<a id="q21a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q21&#39;)">show answer</a>]</small></p>
<div id="q21" style="color:#000099;display:none">
<pre>select   C.employee, max(A.cruisingrange)
from     Certified C, Aircraft A
where    C.aircraft = A.aid
group by C.employee
having   count(*) &gt; 3
</pre>
</div>

</li><li><p>
Find the names of pilots whose salary is less than the price of the cheapest route from Los Angeles to Honolulu.
</p>
<p><small>[<a id="q22a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q22&#39;)">show answer</a>]</small></p>
<div id="q22" style="color:#000099;display:none">
<pre>select distinct E.aname
from   Employee E
where  E.salary &lt; (select min(F.price)
                   from   Flights F
                   where  F.from = 'Los Angeles' and F.to = 'Honolulu');
</pre>
</div>

</li><li><p>
For all aircraft with cruising range over 1000km, find the manufacturer of the aircraft, and the average salary of all pilots certified for this aircraft.
</p>
<p><small>[<a id="q23a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q23&#39;)">show answer</a>]</small></p>
<div id="q23" style="color:#000099;display:none">
<pre>select A.aname as name, AVG(E.salary) as AvaSalary
from   Aircraft A, Certified C, Employees E
where  A.aid = C.aircraft and C.employee = E.eid and A.cruisingrange &gt; 1000
group  by A.aname
</pre>
</div>

</li><li><p>
Find the names of pilots certified for some <q>Boeing</q> aircraft.
</p>
<p><small>[<a id="q24a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q24&#39;)">show answer</a>]</small></p>
<div id="q24" style="color:#000099;display:none">
<pre>select distinct E.ename
from   Employees E, Certified C, Aircraft A
where  E.eid = C.employee and C.aircraft = A.aid and A.aname = 'Boeing'
</pre>
</div>

</li><li><p>
Find the id's of all aircraft that can be used on routes from Los Angeles to Chicago.
</p>
<p><small>[<a id="q25a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q25&#39;)">show answer</a>]</small></p>
<div id="q25" style="color:#000099;display:none">
<pre>select A.aid
from   Aircraft A
where  A.cruisingrange &gt; (select min(F.distance)
                          from Flights F
                          where F.from = 'Los Angeles' and F.to = 'Chicago')

</pre>
</div>

</li><li><p>
Identify the routes that can be piloted by every pilot who makes more than 100,100.
</p>
<p><small>[<a id="q26a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q26&#39;)">show answer</a>]</small></p>
<div id="q26" style="color:#000099;display:none">
<pre>select distinct F.from, F.to
from   Flights F
where  not exists (select *
                   from Employees E
                   where E.salary &gt; 100000
                         and
                         not exists (select *
                                     from   Aircraft A, Certified C
                                     where  A.cruisingrange &gt; F.distance
                                            and E.eid = C.employee
                                            and A.eid = C.aircraft
                                    )
                  )
</pre>
</div>

</li><li><p>
Print the ename's of pilots who can operate planes with cruising range greater than 3000 miles, but are not certified on any "Boeing" aircraft.
</p>
<p><small>[<a id="q27a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q27&#39;)">show answer</a>]</small></p>
<div id="q27" style="color:#000099;display:none">
<pre>select distinct E.ename
from   Employees E, Certified C, Aircraft A
where  C.employee = E.eid
       and C.aircraft=A.aid
       and A.cruisingrange &gt; 3000
       and E.eid NOT IN (select C1.eid
                         from   Certified C1, Aircraft A1
                         where  C1.aircraft = A1.aid and A1.aname ='Boeing');
</pre>
</div>

</li></ol>


</li><li>
<p>
Give SQL queries to answer the following questions on the
<a href="http://www.cse.unsw.edu.au/~cs3311/18s1/exercises/04/beers2/schema.sql">beers/bars/drinkers</a>
database that uses numeric IDs as primary keys.
Note that the queries here will not necessarily produce the same results
as the corresponding queries on the original beers/bars/drinkers database,
because the data is different.
</p>

<ol type="a">
<li><p>
What beers are made by Toohey's?
</p>
<p><small>[<a id="q28a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q28&#39;)">show answer</a>]</small></p>
<div id="q28" style="color:#000099;display:none">
<pre>select name from Beers where manf = 'Toohey''s';
</pre>
</div>

</li><li><p>
Show beers with headings <q>Beer</q>, <q>Brewer</q>.
</p>
<p><small>[<a id="q29a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q29&#39;)">show answer</a>]</small></p>
<div id="q29" style="color:#000099;display:none">
<pre>select name as "Beer", manf as "Brewer"
from   Beers;
</pre>
</div>

</li><li><p>
Find the brewers whose beers John likes.
</p>
<p><small>[<a id="q30a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q30&#39;)">show answer</a>]</small></p>
<div id="q30" style="color:#000099;display:none">
<pre>select distinct b.manf
from   Beers b
	join Likes L on (b.id = L.beer)
	join Drinkers d on (L.drinker = d.id)
where  d.name = 'John';

-- alternatively

select distinct b.manf
from   Beers b, Likes L, Drinkers d
where  d.name = 'John' and d.id = L.drinker
	and L.beer = b.id;
</pre>
</div>

</li><li><p>
Find pairs of beers by the same manufacturer.
</p>
<p><small>[<a id="q31a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q31&#39;)">show answer</a>]</small></p>
<div id="q31" style="color:#000099;display:none">
<pre>select b1.name, b2.name
from   Beers b1, Beers b2
where  b1.manf = b2.manf and b1.name &lt; b2.name;
</pre>
</div>

</li><li><p>
Find beers that are the only one by their brewer.
</p>
<p><small>[<a id="q32a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q32&#39;)">show answer</a>]</small></p>
<div id="q32" style="color:#000099;display:none">
<pre>select name, manf
from   Beers b
where  not exists (select * from Beers
                   where  manf = b.manf and name != b.name);

-- alternatively

select name, manf
from   Beers
where  manf in (select manf from Beers
                group by manf having count(name) = 1);
</pre>
</div>

</li><li><p>
Find the beers sold at bars where John drinks.
</p>
<p><small>[<a id="q33a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q33&#39;)">show answer</a>]</small></p>
<div id="q33" style="color:#000099;display:none">
<pre>select distinct b.name
from   Beers b, Sells s, Frequents f, Drinkers d
where  d.name = 'John' and d.id = f.drinker
        and f.bar = s.bar and s.beer = b.id;
</pre>
</div>

</li><li><p>
How many different beers are there?
</p>
<p><small>[<a id="q34a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q34&#39;)">show answer</a>]</small></p>
<div id="q34" style="color:#000099;display:none">
<pre>select count(*) from Beers;
</pre>
</div>

</li><li><p>
How many different brewers are there?
</p>
<p><small>[<a id="q35a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q35&#39;)">show answer</a>]</small></p>
<div id="q35" style="color:#000099;display:none">
<pre>select count(distinct manf) from Beers;
</pre>
</div>

</li><li><p>
How many beers does each brewer make?
</p>
<p><small>[<a id="q36a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q36&#39;)">show answer</a>]</small></p>
<div id="q36" style="color:#000099;display:none">
<pre>select manf,count(*) from Beers group by manf;
</pre>
</div>

</li><li><p>
Which brewer makes the most beers?
</p>
<p><small>[<a id="q37a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q37&#39;)">show answer</a>]</small></p>
<div id="q37" style="color:#000099;display:none">
<pre>create view NumBeers as
   select manf as brewer, count(*) as nbeers
   from   Beers
   group  by manf;

select brewer
from   NumBeers
where  nbeers = (select max(nbeers) from NumBeers);
</pre>
</div>

</li><li><p>
Bars where either Gernot or John drink.
</p>
<p><small>[<a id="q38a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q38&#39;)">show answer</a>]</small></p>
<div id="q38" style="color:#000099;display:none">
<pre>select distinct b.name
from   Bars b join Frequents f on (b.id = f.bar)
	join Drinkers d on (f.drinker=d.id)
where  d.name = 'John' or d.name = 'Gernot';

-- or

create view JohnsBars as
select distinct b.name as bar
from   Bars b join Frequents f on (b.id = f.bar)
	join Drinkers d on (f.drinker=d.id)
where  d.name = 'John';

create view GernotsBars(bar) as
select distinct b.name
from   Bars b join Frequents f on (b.id = f.bar)
	join Drinkers d on (f.drinker=d.id)
where  d.name = 'Gernot';

(select bar from JohnsBars)
union
(select bar from GernotsBars)
</pre>
</div>

</li><li><p>
Bars where both Gernot and John drink.
</p>
<p><small>[<a id="q39a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q39&#39;)">show answer</a>]</small></p>
<div id="q39" style="color:#000099;display:none">
<pre>-- cannot use something like the first solution to the previous question

-- however, a variant of the second solution works just fine

(select bar from JohnsBars)
intersect
(select bar from GernotsBars);

-- alternatively, but less efficiently

select b.name as bar
from   Bars b
	join Frequents f on (b.id = f.bar)
	join Drinkers d on (d.id = f.drinker)
where  d.name = 'John' and
       exists (select *
		from Frequents ff
			join Drinkers d on (ff.drinker = d.id)
		where ff.bar = f.bar and d.name = 'Gernot');
</pre>
</div>

</li><li><p>
Find bars that serve New at the same price
     as the Coogee Bay Hotel charges for VB.
</p>
<p><small>[<a id="q40a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q40&#39;)">show answer</a>]</small></p>
<div id="q40" style="color:#000099;display:none">
<pre>create view CBHpriceForVB as
select s.price
from   Sells s
	join Beers b on (s.beer = b.id)
	join Bars r on (s.bar = r.id)
where  b.name = 'Victoria Bitter'
	and r.name = 'Coogee Bay Hotel';

select r.name
from   Sells s
	join Beers b on (s.beer = b.id)
	join Bars r on (s.bar = r.id)
where  b.name = 'New' and
       s.price = (select price from CBHpriceForVB);
</pre>
</div>

</li><li><p>
Find the average price of common beers
(where "common" means those that are served in more than two hotels).
</p>
<p><small>[<a id="q41a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q41&#39;)">show answer</a>]</small></p>
<div id="q41" style="color:#000099;display:none">
<pre>select b.name,avg(s.price)
from   Sells s
	join Beers b on (s.beer = b.id)
group  by b.name
having count(s.bar) &gt; 2;
</pre>
</div>

</li><li><p>
Which bar sells 'New' cheapest?
</p>
<p><small>[<a id="q42a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q42&#39;)">show answer</a>]</small></p>
<div id="q42" style="color:#000099;display:none">
<p>
By now, we're sick of typing the join on Bars-Sells-Beers
so we use a view to re-create the table from the original
beers database.
</p>
<pre>create view BeerSales(beer,bar,price)
as
select b.name, r.name, s.price
from   Beers b join Sells s on (b.id=s.beer)
        join Bars r on (s.bar=r.id);

select bar
from   BeerSales
where  beer = 'New' and
       price = (select min(price) from BeerSales where beer='New');
</pre>
</div>

</li><li><p>
Which bar is the most popular? (i.e. most drinkers)
</p>
<p><small>[<a id="q43a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q43&#39;)">show answer</a>]</small></p>
<div id="q43" style="color:#000099;display:none">
<pre>create view NumDrinkers(bar,nDrinkers)
as
select b.name, count(*)
from   Frequents f join Bars b on (f.bar=b.id)
group by b.name;

select bar
from   NumDrinkers
where  nDrinkers = (select max(nDrinkers) from NumDrinkers);
</pre>
</div>

</li><li><p>
Which bar is the most expensive? (i.e. highest average price)
</p>
<p><small>[<a id="q44a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q44&#39;)">show answer</a>]</small></p>
<div id="q44" style="color:#000099;display:none">
<pre>create view AveragePrices(bar,avgPrice)
as
select b.name, avg(price)
from   Sells s join Bars b on (s.bar = b.id)
group by b.name;

select bar
from   AveragePrices
where  avgPrice = (select max(avgPrice) from AveragePrices);
</pre>
</div>

</li><li><p>
Which beers are sold at all bars?
</p>
<p><small>[<a id="q45a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q45&#39;)">show answer</a>]</small></p>
<div id="q45" style="color:#000099;display:none">
This uses the SQL version of the relational algebra division operator
<pre>select distinct b.name as beer
from   Sells s join Beers b on (s.beer = b.id)
where  not exists (
        (select id as bar from Bars)
        except
        (select bar from Sells where beer = s.beer)
       );
</pre>
</div>

</li><li><p>
What is the price of the cheapest beer at each bar?
</p>
<p><small>[<a id="q46a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q46&#39;)">show answer</a>]</small></p>
<div id="q46" style="color:#000099;display:none">
<pre>select bar,min(price) from BeerSales group by bar;

-- or, without using the BeerSales view

select b.name as bar, min(price)
from   Sells s join Bars b on (s.bar = b.id)
group  by b.name;
</pre>
</div>

</li><li><p>
What is the name of the cheapest beer at each bar?
</p>
<p><small>[<a id="q47a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q47&#39;)">show answer</a>]</small></p>
<div id="q47" style="color:#000099;display:none">
<pre>create view Bargains as
   select bar,min(price) as cheapest from BeerSales group by bar;

select s.bar,s.beer
from   BeerSales s
where  s.price = (select cheapest from Bargains where bar=s.bar)
order by bar;

-- alternatively

select s.bar,s.beer,s.price
from   BeerSales s, Bargains p
where  s.bar=p.bar and s.price=p.min;
</pre>
</div>

</li><li><p>
How many drinkers are there in each suburb?
</p>
<p><small>[<a id="q48a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q48&#39;)">show answer</a>]</small></p>
<div id="q48" style="color:#000099;display:none">
<pre>select address,count(*) from Drinkers group by address;
</pre>
</div>

</li><li><p>
How many bars are there in suburbs where drinkers live? <br>
     <small>(Must include suburbs where there are no bars)</small>
</p>
<p><small>[<a id="q49a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q49&#39;)">show answer</a>]</small></p>
<div id="q49" style="color:#000099;display:none">
<pre>select d.addr, count(b.name)
from   Drinkers d left outer join Bars b using (addr)
group  by d.addr;
</pre>
</div>

</li></ol>

</li><li>
<p>
Give SQL queries to answer the following questions on the
<a href="http://www.cse.unsw.edu.au/~cs3311/18s1/exercises/04/weblog/schema.sql">web server log</a>
database:
</p>

<ol type="a">

<li><p>
How many sessions are there?
</p>
<p><small>[<a id="q50a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q50&#39;)">show answer</a>]</small></p>
<div id="q50" style="color:#000099;display:none">
<pre>select count(*) from session;
</pre>
</div>

</li><li><p>
How many page accesses are there?
</p>
<p><small>[<a id="q51a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q51&#39;)">show answer</a>]</small></p>
<div id="q51" style="color:#000099;display:none">
<pre>select count(*) from access;
</pre>
</div>

</li><li><p>
What is the average number of accesses per session?
</p>
<p><small>[<a id="q52a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q52&#39;)">show answer</a>]</small></p>
<div id="q52" style="color:#000099;display:none">
<pre>create view sessLength as
select session, count(*) as length from Access group by session;

select avg(length) from sessLength;
</pre>
</div>

</li><li><p>
What are the most common session lengths?
</p>
<p><small>[<a id="q53a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q53&#39;)">show answer</a>]</small></p>
<div id="q53" style="color:#000099;display:none">
<pre>create view sessLengthFreqs as
select length, count(*) as freq from sessLength group by length;

select length
from   sessLengthFreqs
where  freq = (select max(freq) from sessLengthFreqs);
</pre>
</div>

</li><li><p>
What is the longest session?
</p>
<p><small>[<a id="q54a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q54&#39;)">show answer</a>]</small></p>
<div id="q54" style="color:#000099;display:none">
<pre>select session
from   sessLength
where  length = (select max(length) from sessLength);
</pre>
</div>

</li><li><p>
How long was the longest session?
</p>
<p><small>[<a id="q55a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q55&#39;)">show answer</a>]</small></p>
<div id="q55" style="color:#000099;display:none">
<pre>select max(length) from sessLength;
</pre>
</div>

</li><li><p>
What is the most common first page in a session?
</p>
<p><small>[<a id="q56a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q56&#39;)">show answer</a>]</small></p>
<div id="q56" style="color:#000099;display:none">
<pre>create view firstPages as
select page, count(*) as nAccesses from Access where seq=1 group by page;

select page
from   firstPages
where  nAccesses = (select max(nAccesses) from firstPages);
</pre>
</div>

</li><li><p>
What is the most common first page after the 3-page startup?
</p>
<p><small>[<a id="q57a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q57&#39;)">show answer</a>]</small></p>
<div id="q57" style="color:#000099;display:none">
<pre>-- Assumes that all sessions start with 3-page initial sequence
create view fourthPages as
select page, count(*) as nAccesses from Access where seq=4 group by page;

select page
from   fourthPages
where  nAccesses = (select max(nAccesses) from fourthPages);
</pre>
</div>

</li><li><p>
What is the most frequently accessed page?
</p>
<p><small>[<a id="q58a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q58&#39;)">show answer</a>]</small></p>
<div id="q58" style="color:#000099;display:none">
<pre>create view pageFreq as
select page, count(*) as freq from Access group by page;

select page
from   PageFreq
where  freq = (select max(freq) from pageFreq);
</pre>
</div>

</li><li><p>
What is the most frequently accessed module?
</p>
<p><small>[<a id="q59a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q59&#39;)">show answer</a>]</small></p>
<div id="q59" style="color:#000099;display:none">
<pre>create view ModuleAccess as
select session, seq, substring(page from '^[^/]+') as module from access;

create view ModuleFreq as
select module, count(*) as freq from Access group by module;

select module
from   ModuleFreq
where  freq = (select max(freq) from ModuleFreq);
</pre>
</div>

</li></ol>

</li><li>
<p>
Consider the following relational schema. An employee can work in more than one department; the pct_time field of the Works relation shows the percentage of time that a given employee works in a given department.
</p><pre>   Emp(<b>eid</b>, emane, age, salary)
   Works(<b><i>eid</i></b>, <b><i>did</i></b>, pct_time)
   Dept(<b>did</b>, budget, managerid)
</pre>
<p>
Write SQL queries to answer the following:
</p>

<ol type="a">
<li><p>
Print the names and ages of each employee who works in both the Hardware
and Software department.
</p>
<p><small>[<a id="q60a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q60&#39;)">show answer</a>]</small></p>
<div id="q60" style="color:#000099;display:none">
<pre>select e.ename, e.age
from   Emp e, Works w1, Works w2
where  e.eid = w1.eid and w1.did = 'Hardware'
       and e.eid = w2.eid and w2.did = 'Software' 
</pre>
</div>

</li><li><p>
For each department with more than 20 full-time-equivalent employees
(i.e., where the part-time and full-time employees add up to at least
that many full-time employees), print the department id together with
the number of employees that work in that department.
</p>
<p><small>[<a id="q61a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q61&#39;)">show answer</a>]</small></p>
<div id="q61" style="color:#000099;display:none">
<pre>select w.did, count(w.eid)
from   Works w
group by w.did
having 20 &lt; (select sum(w1.pic_time)
             from   Works w1
             where  w1.did = w.did);
</pre>
</div>

</li><li><p>
Print the names of each employee whose salary exceeds the budget of all
of the departments that he/she works in.
</p>
<p><small>[<a id="q62a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q62&#39;)">show answer</a>]</small></p>
<div id="q62" style="color:#000099;display:none">
<pre>select e.ename
from   Emp e
where  e.salary &gt; all (select d.budget
                       from   Dept d, Works w
                       where  e.eid=w.eid and d.did = w.did);
</pre>
</div>

</li><li><p>
Find the managerids of managers who only manage departments with budgets
over $1,000,000.
</p>
<p><small>[<a id="q63a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q63&#39;)">show answer</a>]</small></p>
<div id="q63" style="color:#000099;display:none">
<pre>select distinct d.managerid
from   Dept d
where  1000000 &lt; all (select d2.budget 
                      from   Dept d2
                      where  d2.managerid = d.managerid)
</pre>
Note the correlated sub-query.
</div>

</li><li><p>
Find the names of the manager(s) who manage the department(s) with the
largest budget.
</p>
<p><small>[<a id="q64a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q64&#39;)">show answer</a>]</small></p>
<div id="q64" style="color:#000099;display:none">
<pre>select E.ename
from   Emp E, Dept D
where  E.eid = D.managerid
       and D.budget = (select max(D2.budget) from Dept D2))
</pre>
</div>

</li><li><p>
If a manager manages more than one department, he/she is said to <q>control</q>
the sum of all the budgets for those departments. Find the managerids of
managers who control more than 5,000,000.
</p>
<p><small>[<a id="q65a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q65&#39;)">show answer</a>]</small></p>
<div id="q65" style="color:#000099;display:none">
<pre>select d.managerid
from   Dept d
where  5000000 &lt; (select sum(d2.budget))
                  from Dept d2
                  where d2.managerid = d.managerid) 
</pre>
Alternative solution (using a view):
<pre>create view ManagerBudget(managerid,totBudget) as
	select distinct d.managerid, sum(d.budget)
	from   Dept d
	group by d.managerid;

select managerid
from   ManagerBudgets
where  totBudget &gt; 5000000;
</pre>
</div>

</li><li><p>
Find the managerids of managers who "control" the largest amount.
</p>
<p><small>[<a id="q66a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q66&#39;)">show answer</a>]</small></p>
<div id="q66" style="color:#000099;display:none">
<pre>-- assuming the ManagerBudget view from the previous question

select managerid
from   ManagerBudget
where  totBudget = (select max(totBudget) from ManagerBudget);
</pre>
</div>

</li></ol>

</li><li>
<p>
<small>(Based on [E&amp;N 8.18])</small>
Define views for the following in SQL:
</p>
<ol type="a">
<li><p>
A view called <code>DeptManagers</code>
that has department name, manager name and manager salary
for each department.
</p>
<p><small>[<a id="q67a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q67&#39;)">show answer</a>]</small></p>
<div id="q67" style="color:#000099;display:none">
<pre>CREATE VIEW DeptManagers AS
   SELECT d.dname, e.ename, e.salary
   FROM   Dept d, Emp e 
   WHERE  d.manager = e.eid;
</pre>
</div>
</li><li><p>
A view called <code>EmpManagers</code>
that has the employee name, manager name for each employee.
</p>
<p><small>[<a id="q68a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q68&#39;)">show answer</a>]</small></p>
<div id="q68" style="color:#000099;display:none">
<pre>CREATE VIEW EmpManagers AS
   SELECT e.ename as employee, m.ename as manager
   FROM   Emp e, WorksIn w, Dept d, Emp m
   WHERE  e.eid = w.eid AND w.did = d.did
          and d.manager = m.eid AND m.eid != e.eid
   ORDER BY e.ename;
</pre>
</div>
</li><li><p>
A view called <code>DeptEmployees</code>
that has the department name, the employee name, the
fraction of time that the employee works for that department,
and the amount of their salary that is contributed by that
department (assume each department contributes precisely
according to the proportion of time that the employee works
in the department).
</p>
<p><small>[<a id="q69a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q69&#39;)">show answer</a>]</small></p>
<div id="q69" style="color:#000099;display:none">
<pre>CREATE VIEW DeptEmployees AS
   SELECT e.ename as employee, d.dname as department,
          w.pct_time as percent, e.salary*w.pct_time as salary
   FROM   Emp e, WorksIn w, Dept d
   WHERE  e.eid = w.eid AND w.did = d.did
   ORDER BY e.ename;
</pre>
</div>
</li></ol>

</li><li>
<p>
<small>(Based on [E&amp;N 8.19])</small>
Consider the following view on the above database (which uses a 
more simplistic view of salaries than the last part of the
previous question):
</p>
<pre>CREATE VIEW DeptSummary(did,nemps,totsal,avgsal) AS
   SELECT did,count(*),sum(salary),avg(salary)
   FROM   Emp e, Works w
   WHERE  w.eid = e.eid
   GROUP BY w.did;
</pre>
<p>
State which of the following queries and updates would be allowed
on the view. If a query or update would be allowed, show what the
corresponding query or update on the tables above would look like:
</p>
<ol type="a">
<p></p><li><pre>select * from DeptSummary;
</pre>
<p><small>[<a id="q70a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q70&#39;)">show answer</a>]</small></p>
<div id="q70" style="color:#000099;display:none">
<pre> did | nemps | totsal | avgsal 
-----+-------+--------+--------
   1 |     2 |  90000 |  45000
   2 |     3 | 135000 |  45000
   3 |     2 | 125000 |  62500
</pre>
</div>
<p></p></li><li><pre>select did,nemps from DeptSummary;
</pre>
<p><small>[<a id="q71a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q71&#39;)">show answer</a>]</small></p>
<div id="q71" style="color:#000099;display:none">
<pre> did | nemps 
-----+-------
   1 |     2
   2 |     3
   3 |     2
</pre>
</div>
<p></p></li><li><pre>select did,avgsal
from   DeptSummary
where  nemps &gt; (select nemps from DeptSummary where did=1);
</pre>
<p><small>[<a id="q72a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q72&#39;)">show answer</a>]</small></p>
<div id="q72" style="color:#000099;display:none">
<pre> did | avgsal 
-----+--------
   2 |  45000
</pre>
</div>
<p></p></li><li><pre>update DeptSummary set did=4 where did=3;
</pre>
<p><small>[<a id="q73a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q73&#39;)">show answer</a>]</small></p>
<div id="q73" style="color:#000099;display:none">
<p>
In principle, this update would not lose any tuples from the
view. However, it involves changing the primary key for the
<code>Departments</code> table, which could have flow-on
effects in referential integrity constraints (e.g., foreign
keys in the <code>Employees</code> and <code>WorksIn</code>
tables). Presumably, these kinds of issues could be resolved
in an implementation, but it would take some considerable
effort, so real DBMS's would probably disallow it.
For example, PostgreSQL says:
</p>
<pre>ERROR:  Cannot update a view
	You need an unconditional ON UPDATE DO INSTEAD rule
</pre>
<p>
In other words, if you want to do updates on views in PosgreSQL,
you need to specify explicitly how you want all of the cascaded 
updates done.
</p>
</div>
<p></p></li><li><pre>delete from DeptSummary where did&gt;2;
</pre>
<p><small>[<a id="q74a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q74&#39;)">show answer</a>]</small></p>
<div id="q74" style="color:#000099;display:none">
<p>
Similarly to the previous question, this does not create any
problems in principle for the view, but practical problems may
prevent many DBMS's from implementing it automatically.
PostgreSQL says:
</p>
<pre>ERROR:  Cannot delete from a view
	You need an unconditional ON DELETE DO INSTEAD rule
</pre>
<p>
In other words, you need to implement the semantics of delete
yourself.
</p>
</div>
</li></ol>

</li><li>
<p>
Suppose you have a view <tt>SeniorEmp</tt> defined as follows: 
</p>
<pre>CREATE VIEW SeniorEmp (ename, age, alary) AS
   SELECT E.ename, E.age, E.salary
   FROM   Emp E
   WHERE  E.age &gt; 50
</pre>
<p>
Explain how a database system would process the following query:
</p>
<pre>SELECT S.ename
FROM   SeniorEmp S
WHERE  S.salary &gt; 100000
</pre>
<p><small>[<a id="q75a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q75&#39;)">show answer</a>]</small></p>
<div id="q75" style="color:#000099;display:none">
<p>
The database system will transform the query into something like
the following:
</p>
<pre>SELECT S.ename
FROM   (SELECT E.ename, E.age, E.salary
        FROM   Emp E
        WHERE  E.age &gt; 50) AS S
WHERE S.salary &gt; 100000
</pre>
or 
<pre>SELECT E.ename
FROM   Emp E
WHERE  E.salary &gt; 100000 AND E.age &gt; 50;
</pre>
<p>
The latter would be based on mapping the SQL to relational
algebra and then transforming via various algebraic equivalences, e.g.
</p>
<pre>   SeniorEmp = proj[ename,age,salary]( sel[age&gt;50]( Emp ) )

   Query
   = proj[ename]( sel[salary&gt;10000]( SeniorEmp ) )
     <font color="#999999"><i>(expand definition of SeniorEmp)</i></font>
   = proj[ename]( sel[salary&gt;10000]( proj[ename,age,salary]( sel[age&gt;50]( Emp ) ) ) )
     <font color="#999999"><i>(swap selection and projection)</i></font>
   = proj[ename]( proj[ename,age,salary]( sel[salary&gt;10000]( sel[age&gt;50]( Emp ) ) ) )
     <font color="#999999"><i>(drop redundant projection)</i></font>
   = proj[ename]( sel[salary&gt;10000]( sel[age&gt;50]( Emp ) ) )
     <font color="#999999"><i>(convert nested selection to conjunction)</i></font>
   = proj[ename]( sel[salary&gt;10000 &amp; age&gt;50]( Emp ) ) )
     <font color="#999999"><i>(which is the same as the SQL query ...)</i></font>
   = SELECT ename FROM Emp WHERE salary&gt;100000 AND age&gt;50
</pre>
</div>

</li><li>
<p>
Give an example of an updatable view on the <tt>Employees</tt> relation
(i.e. a view such that if we perform an update on the view, the
<code>Employees</code> relation will be updated appropriately,
and the new tuple will appear next time the view is used).
</p>
<p><small>[<a id="q76a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q76&#39;)">show answer</a>]</small></p>
<div id="q76" style="color:#000099;display:none">
<p>
The following view can be updated, because each update on the view
produces a well-defined update on the base table:
</p>
<pre>CREATE VIEW SeniorEmp (eid, name, age, salary) AS
   SELECT E.eid, E.ename, E.age, E.salary
   FROM   Employees E
   WHERE  E.age&gt;50
</pre>
<p>
Consider updates such as:
</p>
<pre>insert into SeniorEmp values (6,'Jack Black',55,125000)
update SeniorEmp set age=age+1 where eid=3
</pre>
<p>
On the other hand, consider an update such as
</p>
<pre>insert into SeniorEmp values (7,'Joe Blow',45,35000)
</pre>
<p>
It is easy to define the corresponding <code>INSERT</code>
operation on the base table, but when the tuple is added,
it will not appear in the view (because Joe Blow is not
older than 50). The SQL standard allows you to specify that
you want this kind of thing to be checked for and have such
updates rejected by adding a <code>WTIH CHECK OPTION</code>
clause to the view definition.
</p>
</div>

</li><li>
<p>
Give an example of a view on the <tt>Employees</tt> relation
that is not updatable.
Explain why your example presents the update problem that it does.
</p>
<p><small>[<a id="q77a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/04/index.php##" onclick="toggleVisible(&#39;q77&#39;)">show answer</a>]</small></p>
<div id="q77" style="color:#000099;display:none">
<p>
This view cannot be updated because any view update does not
lead to a single well-defined update on the base table:
</p>
<pre>CREATE VIEW AveSalaryByAge (age, avgSalary) AS
   SELECT E.age, AVG(E.salary)
   FROM   Employees E
   GROUP BY  E.age
</pre>
<p>
For example, an update such as
</p>
<pre>UPDATE AveSalaryByAge
SET    avgSalary=60000
WHERE  age=30
</pre>
<p>
could be achieved in many ways (e.g., increasing employee A's
salary and decreasing employee B's salary, or increasing A's
salary and decreasing B's salary, etc.)
</p>
<p>
Any query that does not satisfy the following conditions is
not updatable:
</p>
<ul>
<li> the <code>FROM</code> clause contains only a single table
</li><li> neither <code>GROUP BY</code> nor <code>HAVING</code> clauses are used
</li><li> the <code>DISTINCT</code> qualifier is not used
</li><li> the <code>WHERE</code> clause does not contain any sub-selects
</li><li> all result attributes are derived from single attribute values <br>
     (i.e. no aggregates or computed values)
</li></ul>
<p>
This is different to the set of conditions given in lecture notes.
Other alternative definitions exist, depending on the author's
interpretation of <q>updatable view</q>.
As noted above, many RDBMS's avoid the issue and don't allow any
views to be updated, or require the user to specify explicitly
how the updates on the base tables should be done.
</p>
</div>

</li></ol>


</body></html>