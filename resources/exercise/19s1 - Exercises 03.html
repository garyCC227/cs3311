<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0063)https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>COMP3311 19s1 - Exercises 03</title>
<link rel="stylesheet" type="text/css" href="./19s1 - Exercises 03_files/course.css"><script language="JavaScript">
function changeText(el, newText) {
  // Safari work around
  if (el.innerText)
    el.innerText = newText;
  else if (el.firstChild && el.firstChild.nodeValue)
    el.firstChild.nodeValue = newText;
}
function toggleVisible(elid) {
  el1 = document.getElementById(elid);
  el2 = document.getElementById(elid+"a");
  if (el1.style.display == "") {
     el1.style.display = "none";
     changeText(el2,"show answer");
  }
  else {
     el1.style.display = "";
     changeText(el2,"hide answer");
  }
}
</script><script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B站下载助手"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili 哔哩哔哩 B站 下载助手 帮你下载版权受限（能看不能缓存）的 番剧 视频","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili哔哩哔哩下载助手","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"加载中"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"加载中"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${m(t)}) 正在下载`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${m(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${m(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<div align="center">
<table width="100%" border="0">
<tbody><tr valign="top">
<td align="left" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">COMP3311 19s1</a></span>
</td>
<td align="center" width="50%">
  <span class="heading">Exercises 03</span><br>
  <span class="subheading">Constraints and Data Modification</span>
</td>
<td align="right" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">Database Systems</a></span>
</td>
</tr></tbody></table>
</div><p style="text-align:center;font-size:75%"><a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php?view=qo">[Show with no answers]</a> &nbsp; <a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php?view=all">[Show with all answers]</a>

</p><p>
Consider the following data model for a
a business organisation and its employees:
</p><p>
</p><center><img src="./19s1 - Exercises 03_files/schema.png"></center>
<p></p>
Employees are uniquely indentified by an id (<tt>eid</tt>), and other
obvious information (name,age,...) is recorded about each employee.
An employee may work in several departments, with the percentage of
time spent in each department being recorded in the <tt>WorksIn</tt>
relation.
The percentages for a given employee may not sum to one if the employee
only works part-time in the organisation.
Departments are also uniquely identified by an id (<tt>did</tt>),
along with other relevant information, including the id of the
employee who manages the department.
<p>
Based on the ER design and the above considerations, here is a
relational schema to represent this scenario:
</p><pre>create table Employees (
      eid       integer,
      ename     varchar(30),
      age       integer,
      salary    real,
      primary key (eid)
);
create table Departments (
      did       integer,
      dname     varchar(20),
      budget    real,
      manager   integer,
      primary key (did),
      foreign key (manager) references Employees(eid)
);
create table WorksIn (
      eid       integer,
      did       integer,
      pct_time  real,
      primary key (eid,did),
      foreign key (eid) references Employees(eid),
      foreign key (did) references Departments(did)
);
</pre>
<p>
Answer each of the following questions for this schema:
</p>
<ol>

<li>
<p>
Does the order of table declarations above matter?
</p>
<p><small>[<a id="q1a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q1&#39;)">show answer</a>]</small></p>
<div id="q1" style="color:#000099;display:none">
<p>
Yes table declarations order in the schema above matters. We can not insert a Department tuple until there is an Employee tuple available to be the manager of the department.
We cannot also insert any WorksIn tuple until you have both the Employee tuple and the Department tuple where the employee works.
</p>
</div><p></p>

</li><li>
<p>
A new government initiative to get more young people into work
cuts the salary levels of all workers under 25 by 20%.
Write an SQL statement to implement this policy change.
</p>
<p><small>[<a id="q2a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q2&#39;)">show answer</a>]</small></p>
<div id="q2" style="color:#000099;display:none">
<p>
SQL statement to reduce pay for people under 25 by 20%:
</p>
<pre>update Employees
set    salary = salary * 0.8
where  age &lt; 25;
</pre>
<p>
A straightforward applicatiom of the SQL <tt>UPDATE</tt> statement.
</p>
</div><p></p>

</li><li>
<p>
The company has several years of growth and high profits, and
considers that the Sales department is primarily responsible for this.
Write an SQL statement to give all employees in the Sales department
a 10% pay rise.
</p>
<p><small>[<a id="q3a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q3&#39;)">show answer</a>]</small></p>
<div id="q3" style="color:#000099;display:none">
<p>
SQL statement to give Sales employees a 10% pay rise:
</p>
<pre>update Employees e
set    e.salary = e.salary * 1.10
where  eid in
           (select eid
            from   Departments d, WorksIn w
            where  d.dname = 'Sales' and d.did = w.did
           );
</pre>
<p>
This query requires that we know which department an employee works
for before updating their pay. The only information we have in the
<tt>Employees</tt> relation to help with this is the employee id.
Thus the subquery gives a list of ids for all employees working
in the Sales department.
</p>
</div><p></p>

</li><li>
<p>
Add a constraint to the <tt>CREATE TABLE</tt> statements above
to ensure that every department must have a manager.
</p>
<p><small>[<a id="q4a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q4&#39;)">show answer</a>]</small></p>
<div id="q4" style="color:#000099;display:none">
<pre>   create table Departments (
      did       integer,
      dname     varchar(20),
      budget    real,
      manager   integer not null,
      primary key (did),
      foreign key (manager) references Employees(eid)
   );
</pre>
<p>
Change the definition of <tt>Departments</tt> to ensure that
the foreign key <tt>manager</tt> is not null.
The foreign key constraint already ensures that the value
must be a primary key in the <tt>Employees</tt> relation
but, without the <tt>NOT NULL</tt> declaration, a foreign
key value is allowed to be null.
</p>
</div><p></p>

</li><li>
<p>
Add a constraint to the <tt>CREATE TABLE</tt> statements above
to ensure that no-one is paid less than the minimum wage of $15,000.
</p>
<p><small>[<a id="q5a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q5&#39;)">show answer</a>]</small></p>
<div id="q5" style="color:#000099;display:none">
<p>
This is a straightforward example of a single-attribute constraint.
It is effectively a constraint on the domain of the <tt>salary</tt>
attribute. In fact, it would been sensible to have an initial
constraint to ensure that the <tt>salary</tt> was at least positive.
A similar constraint should probably be applied to the <tt>pct_time</tt>
attribute in the <tt>WorksIn</tt> relation.
</p>
<pre>create table Employees (
   eid       integer,
   ename     varchar(30),
   age       integer,
   salary    real check (salary &gt;= 15000),
   primary key (eid)
);
</pre>
</div><p></p>

</li><li>
<p>
Add a constraint to the <tt>CREATE TABLE</tt> statements above
to ensure that no employee can be committed for more than 100%
of his/her time.
Note that the SQL standard allows queries to be used in constraints,
even though DBMSs don't implement this (for performance reasons).
</p>
<p><small>[<a id="q6a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q6&#39;)">show answer</a>]</small></p>
<div id="q6" style="color:#000099;display:none">
<p>
We have expressed this as a tuple-level constraint, even though
it's really a constraint on the <tt>eid</tt> attribute.
Note the use of scoping in the sub-query: the <tt>eid</tt> refers
to the id of the employee that is being inserted or modified,
while <tt>w.eid</tt> is bound by the tuple variable in the subquery.
The subquery itself computes the total <tt>pct_time</tt> that the
employee <tt>eid</tt> works.
</p>
<p>
This query is valid according to Ullman/Widom's description of the
SQL2 standard.
However, neither PostgreSQL nor Oracle supports subqueries in
<tt>CHECK</tt> conditions.
The condition can only be an expression involving the attributes in
the updated row.
</p>
<pre>create table WorksIn (
   eid         integer,
   did         integer,
   pct_time    real,
   primary key (eid,did),
   foreign key (eid) references Employees(eid),
   foreign key (did) references Departments(did)
   constraint  MaxFullTimeCheck
               check (1.00 &gt;= (select sum(w.pct_time)
                               from   WorksIn w
                               where  w.eid = eid)
                      )
);
</pre>
<p>
In most relational database management systems, the constraint
checking required here would need to be implemented via a trigger.
</p>
</div><p></p>

</li><li>
<p>
Add a constraint to the <tt>CREATE TABLE</tt> statements above
to ensure that a manager works 100% of the time in the department
that he/she manages.
Note that the SQL standard allows queries to be used in constraints,
even though DBMSs don't implement this (for performance reasons).
</p>
<p><small>[<a id="q7a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q7&#39;)">show answer</a>]</small></p>
<div id="q7" style="color:#000099;display:none">
<p>
We have expressed this as a tuple-level constraint, even though
it's really a constraint on the <tt>manager</tt> attribute.
</p>
<pre>create table Departments (
   did         integer,
   dname       varchar(20),
   budget      real,
   manager     integer,
   primary key (did),
   foreign key (manager) references Employees(eid)
   constraint  FullTimeManager
               check (1.0 = (select w.pct_time
                             from   WorksIn w
                             where  w.eid = manager)
                     )
);
</pre>
<p>
As in the previous question, this kind of constraint is allowed by
the SQL standard, but DBMSs typically don't implement cross-table
constraints like this; a trigger is required and the check has to
be programmed in the trigger.
</p>
</div><p></p>

</li><li>
<p>
When an employee is removed from the database, it makes sense to also
delete all of the records that show which departments he/she works for.
Modify the <tt>CREATE TABLE</tt> statements above to ensure that this occurs.
</p>
<p><small>[<a id="q8a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q8&#39;)">show answer</a>]</small></p>
<div id="q8" style="color:#000099;display:none">
<p>
The <tt>ON DELETE CASCADE</tt> clause ensures that
when the <tt>Employees</tt> record for <tt>eid</tt> is removed,
then any <tt>WorksIn</tt> tuples that refer to <tt>eid</tt> are also removed.
</p>
<pre>create table WorksIn (
   eid         integer,
   did         integer,
   pct_time    real,
   primary key (eid,did),
   foreign key (eid) references Employees(eid) on delete cascade,
   foreign key (did) references Departments(did)
);
</pre>
<p>
Of course, this immediately reaises the issue of references to the
<tt>Departments</tt> relation; this is considered in the next question.
</p>
</div><p></p>

</li><li>
<p>
When a manager leaves the company, there may be a period
before a new manager is appointed for a department.
Modify the <tt>CREATE TABLE</tt> statements above to allow for this.
</p>
<p><small>[<a id="q9a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q9&#39;)">show answer</a>]</small></p>
<div id="q9" style="color:#000099;display:none">
<p>
If the department has no manager, we indicate this by putting
a value of <tt>NULL</tt> for the <tt>manager</tt> field.
However, in one of the questions above, we added a NOT NULL
contraint to ensure that every department <em>does</em> have a manager.
To solve this question, we need to remove that constraint.
</p>
<p>
An alternative would be to always appoint a temporary manager,
which could be accomplished via an <tt>UPDATE</tt> statement, e.g.
</p>
<pre>update department set manager = <i>SomeEID</i> where did = <i>OurDeptID</i>;
</pre>
</div><p></p>

</li><li>
<p>
Consider the deletion of a department from a database based on this schema.
What are the options for dealing with referential integrity
between <tt>Departments</tt> and <tt>WorksIn</tt>? For each option,
describe the required behaviour in SQL.
</p>
<p><small>[<a id="q10a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q10&#39;)">show answer</a>]</small></p>
<div id="q10" style="color:#000099;display:none">
Four possible approaches to referential integrity between 
between <tt>Departments</tt> and <tt>WorksIn</tt>:
<ol type="a">
<p></p><li>
Disallow the deletion of a <tt>Departments</tt> tuple if any
<tt>Works</tt> tuple refers to it.
This is the default behaviour, which would result from
the <tt>CREATE TABLE</tt> definition in the previous question.
<p></p></li><li>
When a <tt>Departments</tt> tuple is deleted, also delete all
<tt>WorksIn</tt> tuples that refer to it.
This requires adding an <tt>ON DELETE CASCADE</tt> clause to
the definition of <tt>WorksIn</tt>.
<pre>create table WorksIn (
   eid       integer,
   did       integer,
   pct_time  real,
   primary key (eid,did),
   foreign key (eid) references Employees(eid) on delete cascade,
   foreign key (did) references Departments(did) on delete cascade
);
</pre>
In this solution, we've added the same functionality to the <tt>eid</tt>
field as well (see previous question).
<p></p></li><li>
For every <tt>WorksIn</tt> tuple that refers to the deleted department,
set the <tt>did</tt> field to <tt>NULL</tt>.
This requires adding an <tt>ON DELETE SET NULL</tt> clause to the
definition of <tt>WorksIn</tt>.
<pre>create table WorksIn (
   eid       integer,
   did       integer,
   pct_time  real,
   primary key (eid,did),
   foreign key (eid) references Employees(eid) on delete cascade,
   foreign key (did) references Departments(did) on delete set null
);
</pre>
<p></p></li><li>
For every <tt>WorksIn</tt> tuple that refers to the deleted department,
set the <tt>did</tt> field to the department id of some existing
'default' department.
Unfortunately, Oracle doesn't appear to implement this functionality.
If it did, the definition of <tt>WorksIn</tt> would change to:
<pre>create table WorksIn (
   eid       integer,
   did       integer default 1,
   pct_time  real,
   primary key (eid,did),
   foreign key (eid) references Employees(eid) on delete cascade,
   foreign key (did) references Departments(did) on delete set default
);
</pre>
</li></ol>
<p></p>
</div><p></p>

</li><li>
<p>
For each of the possible cases in the previous question, show how deletion
of the Engineering department would affect the following database:
</p>
<pre>  EID ENAME             AGE     SALARY
----- --------------- ----- ----------
    1 John Smith         26      25000
    2 Jane Doe           40      55000
    3 Jack Jones         55      35000
    4 Superman           35      90000
    5 Jim James          20      20000

  DID DNAME               BUDGET  MANAGER
----- --------------- ---------- --------
    1 Sales               500000        2
    2 Engineering        1000000        4
    3 Service             200000        4

  EID   DID  PCT_TIME
----- ----- ---------
    1     2      1.00
    2     1      1.00
    3     1      0.50
    3     3      0.50
    4     2      0.50
    4     3      0.50
    5     2      0.75

</pre>
<p><small>[<a id="q11a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q11&#39;)">show answer</a>]</small></p>
<div id="q11" style="color:#000099;display:none">
<ol type="a">
<li>
<p>
Disallow ...
The database would not change. The DBMS would print an error message
about referential integrity constraint violation.
</p>
</li><li>
<p>
<tt>ON DELETE CASCADE</tt> ...
All of the tuples in the <tt>WorksIn</tt> relation that have
<tt>did = 2</tt> are removed, giving:
</p>
<pre>  DID DNAME               BUDGET  MANAGER
----- --------------- ---------- --------
    1 Sales               500000        2
    3 Service             200000        4

  EID   DID  PCT_TIME
----- ----- ---------
    2     1      1.00
    3     1      0.50
    3     3      0.50
    4     3      0.50
</pre>
</li><li>
<p>
<tt>ON DELETE SET NULL</tt> ...
All of the tuples in the <tt>WorksIn</tt> relation that have
<tt>did = 2</tt> have that attribute modified to <tt>NULL</tt>, giving:
</p>
<pre>  DID DNAME               BUDGET  MANAGER
----- --------------- ---------- --------
    1 Sales               500000        2
    3 Service             200000        4

  EID   DID  PCT_TIME
----- ----- ---------
    1  NULL      1.00
    2     1      1.00
    3     1      0.50
    3     3      0.50
    4  NULL      0.50
    4     3      0.50
    5  NULL      0.75
</pre>
</li><li>
<p>
<tt>ON DELETE SET DEFAULT</tt> ...
All of the tuples in the <tt>WorksIn</tt> relation that have
<tt>did = 2</tt> have that attribute modified to the default
department (<tt>1</tt>), giving:
</p>
<pre>  DID DNAME               BUDGET  MANAGER
----- --------------- ---------- --------
    1 Sales               500000        2
    3 Service             200000        4

  EID   DID  PCT_TIME
----- ----- ---------
    1     1      1.00
    2     1      1.00
    3     1      0.50
    3     3      0.50
    4     1      0.50
    4     3      0.50
    5     1      0.75
</pre>
</li></ol>
</div><p></p>

</li><li>
<p>
Consider the following data model, not related to the workplace schema above:
</p><p>
</p><center><img src="./19s1 - Exercises 03_files/schema1.png"></center>
<p></p>
<p>
and its associated relational schema:
</p>
<pre>create table R (
        x       integer,
        y       char(1),
	primary key (x),
	foreign key (y) references S(y)
);
create table S (
        y       char(1),
        x       integer,
	primary key (y),
	foreign key (x) references R(x)
);
</pre>
<p>
As it stands, it is not possible to load this schema into PostgreSQL.
While processing the definition of table <tt>R</tt>, PostgreSQL needs
to know about table <tt>S</tt>, which does not yet exist. The standard
behaviour when a referenced object doesn't exist, is to fail, and so
the creation of table <tt>R</tt> fails, which then causes the
subsequent attempt to create table <tt>S</tt> to fail.
</p>
<p>
Describe how might define this schema so that it <em>is</em> possible
to load it into PostgreSQL.
</p>
<p><small>[<a id="q12a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q12&#39;)">show answer</a>]</small></p>
<div id="q12" style="color:#000099;display:none">
<p>
The trick here is to create the tables first without the referential
integrity constraints, and then add them once all the tables exist:
</p><pre>create table R (
        x       integer,
        y       char(1),
	primary key (x)
);
create table S (
        y       char(1),
        x       integer,
	primary key (y)
);
alter table R add foreign key (y) references S(y);
alter table S add foreign key (x) references R(x);
</pre>
</div><p></p>

</li><li>
<p>
Once the above schema is loaded, we want to create
the following two relations:
</p>
<pre>db=# select * from R;
 x | y 
---+---
 1 | a
(1 row)

db=# select * from S;
 y | x 
---+---
 a | 1
(1 row)
</pre>
<p>
The following doesn't work:
</p>
<pre>insert into R values (1,'a');
insert into S values ('a',1);
</pre>
<p>
The first insert fails because there's not yet a tuple in <tt>S</tt>
with a primary key value of <tt>'a'</tt>. The the second insert fails
because the first insert failed and there's no tuple in <tt>R</tt>
with a primary key value of <tt>1</tt>.
Reversing the order of the <tt>insert</tt> statements doesn't solve
the problem.
</p>
<p>
Describe how we can insert these tuples into the database.
</p>
<p><small>[<a id="q13a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q13&#39;)">show answer</a>]</small></p>
<div id="q13" style="color:#000099;display:none">
<p>
One possibility, analogous to the above creation of tables, is to 
create tuples with null foreign key values and then update them to
fill in the foreigh keys:
</p>
<pre>insert into R values (1,null);
insert into S values ('a',null);
update R set y = 'a' where x = 1;
update S set x = 1 where y = 'a';
</pre>
<p>
This works because when we come to assign the foreign keys, the
correpsonding primary key values exist in the database.
This approach relies on us being able to assign <tt>NULL</tt> to
foreign key attributes, which is the default behaviour unless
the foreign key attributes are constrained to be <tt>NOT NULL</tt>.
</p>
</div><p></p>

</li><li>
<p>
Now consider a variation on the above database where the foreign
keys are not permitted to have <tt>NULL</tt> values. Conceptually,
the schema would look like:
</p>
<pre>create table R (
        x       integer,
        y       char(1) not null,
	primary key (x),
	foreign key (y) references S(y)
);
create table S (
        y       char(1),
        x       integer not null,
	primary key (y),
	foreign key (x) references R(x)
);
</pre>
<p>
but as we know from above, this won't load because of the mutual
cross-references between the tables.
</p>
<p>
Describe how you would load the schema and then how you would
insert the same two tuples as above under the new schema.
</p>
<p><small>[<a id="q14a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/03/index.php##" onclick="toggleVisible(&#39;q14&#39;)">show answer</a>]</small></p>
<div id="q14" style="color:#000099;display:none">
<p>
The same technique as above can be used to load the schema:
</p>
<pre>create table R (
        x       integer,
        y       char(1) not null,
	primary key (x)
);
create table S (
        y       char(1),
        x       integer not null,
	primary key (y)
);
alter table R add foreign key (y) references S(y) deferrable;
alter table S add foreign key (x) references R(x) deferrable;
</pre>
<p>
Note, however, that there's an extra keyword attached to
the foreign key definitions: <tt>DEFERRABLE</tt>. Its use
is explained below.
</p>
<p>
The problem with inserting the tuples
is that PostgreSQL's default behaviour for
SQL is to check constraints after every attempt insert or
delete or update a tuple.
What's needed here is to somehow delay the constraint checking
until all of the desired tuples are in the database.
If all the tuples are consistent and have valid foreign keys
once they're all "added", then we can leave them in the database.
Of course, if we discover that one of the tuples really does have
an invalid foreign key, then we can't leave it there, and we have
to delete the invalid tuple. This might make some of the other
"added" tuples also invalid, so what PostgreSQL does is to remove
<i>all</i> of the tuples that were temporarily added before the
constraints were checked.
</p>
<p>
The question is, of course, how to get PostgreSQL to have the
behaviour above: temporarily adding a set of tuples, then
checking the constraints, and then either adding them all
permanently, or removing them all.
This behaviour is provided by transactions, which are
introduced by the <tt>BEGIN</tt> statement and completed
by the <tt>COMMIT</tt> statement.
However, even within a transaction, constraints will be checked
after each statement unless they are explicitly delayed via
the <tt>DEFERRED</tt> keyword.
</p>
<p>
Note that constraint checking cannot be deferred unless the
constraint itself was initially declared as <em>deferrable</em>.
</p>
<p>
This is how it all works in PostgreSQL:
</p>
<pre>begin;   -- start a transaction
set constraints all deferred;
insert into R values (1,'a');
insert into S values ('a',1);
commit;  -- finish the transaction
</pre>
</div><p></p>

</li></ol>


</body></html>