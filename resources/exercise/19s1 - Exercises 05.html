<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0063)https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>COMP3311 19s1 - Exercises 05</title>
<link rel="stylesheet" type="text/css" href="./19s1 - Exercises 05_files/course.css"><script language="JavaScript">
function changeText(el, newText) {
  // Safari work around
  if (el.innerText)
    el.innerText = newText;
  else if (el.firstChild && el.firstChild.nodeValue)
    el.firstChild.nodeValue = newText;
}
function toggleVisible(elid) {
  el1 = document.getElementById(elid);
  el2 = document.getElementById(elid+"a");
  if (el1.style.display == "") {
     el1.style.display = "none";
     changeText(el2,"show answer");
  }
  else {
     el1.style.display = "";
     changeText(el2,"hide answer");
  }
}
</script><script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B站下载助手"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili 哔哩哔哩 B站 下载助手 帮你下载版权受限（能看不能缓存）的 番剧 视频","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili哔哩哔哩下载助手","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"加载中"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"加载中"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${m(t)}) 正在下载`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${m(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${m(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<div align="center">
<table width="100%" border="0">
<tbody><tr valign="top">
<td align="left" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">COMP3311 19s1</a></span>
</td>
<td align="center" width="50%">
  <span class="heading">Exercises 05</span><br>
  <span class="subheading">Stored Functions in SQL and PLpgSQL</span>
</td>
<td align="right" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">Database Systems</a></span>
</td>
</tr></tbody></table>
</div>
<ol>

<li>
<p>
Write a simple PLpgSQL function that returns the square
of its argument value. It is used as follows:
</p>
<pre>mydb=&gt; <b>select sqr(4);</b>
 sqr 
-----
  16
(1 row)

mydb=&gt; <b>select sqr(1000);</b>
   sqr 
---------
 1000000
(1 row)
</pre>
<p>
Could we use this function to square real numbers?
If not, how could we write a function to achieve this?
</p>
<p><small>[<a id="q1a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q1&#39;)">show answer</a>]</small></p>
<div id="q1" style="color:#000099;display:none">
<p></p>
<pre>create or replace function sqr(n integer) returns integer
as $$
declare
	result integer;
begin
	result := n * n;
	return result;
end;
$$ language plpgsql;
</pre>
<p>
OR
</p>
<pre>create or replace function sqr(n integer) returns integer
as $$
begin
	return n * n;
end;
$$ language plpgsql;
</pre>
<p>
This function won't square real numbers, even something like:
</p>
<pre>mydb=&gt; <b>select sqr(3.0);</b>
ERROR:  Function sqr(numeric) does not exist
</pre>
<p>
The types don't match, and PostgreSQL won't automatically convert.
However, by declaring the function to use the generic number type
<code>numeric</code>, it will handle both integers and reals
correctly:
</p>
<pre>create or replace function sqr(n numeric) returns numeric
as $$
begin
	return n * n;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Write two PLpgSQL functions to compute factorial,
one iterative and one recursive.
Both functions take an integer argument and return
an integer result, if the argument is non-negative.
Otherwise, they return <code>NULL</code>.
They would both be used as follows:
</p>
<pre>mydb=&gt; <b>select fac(5);</b>
 fac 
-----
 120
(1 row)

mydb=&gt; <b>select fac(10);</b>
   fac   
---------
 3628800
(1 row)

mydb=&gt; <b>select fac(0);</b>
 fac   
-----
   1
(1 row)

mydb=&gt; <b>select fac(-1);</b>
 fac   
-----
(0 rows)
</pre>
<p>
</p>
<p><small>[<a id="q2a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q2&#39;)">show answer</a>]</small></p>
<div id="q2" style="color:#000099;display:none">
<p></p>
<pre>-- recursive version
create or replace function fac(n integer) returns integer
as $$
begin
	if (n &lt; 0) then
		return null;
	elsif (n = 0) then
		return 1;
	elsif (n = 1) then
		return 1;
	else
		return n * fac(n - 1);
	end if;
end; 
$$ language plpgsql;

-- iterative version
create or replace function fac(n integer) returns integer
as $$
declare
	i integer;
	res integer;
begin
	if (n &lt; 0) then
		return null;
	end if;
	res := 1;
	for i in 1 .. n loop
		res := res * i;
	end loop;
	return res;
end; 
$$ language plpgsql;
</pre>
<p>
</p></div>


</li><li>
<p>
Write a PLpgSQL function that <q>spreads</q> the letters
in some text. It is used as follows:
</p>
<pre>mydb=&gt; <b>select spread('My Text');</b>
     spread
----------------
 M y   T e x t
(1 row)
</pre>
<p>
</p>
<p><small>[<a id="q3a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q3&#39;)">show answer</a>]</small></p>
<div id="q3" style="color:#000099;display:none">
<p></p>
<pre>create or replace function spread(text) returns text
as $$
declare
	result text := '';
	i      integer;
	len    integer;
begin
	i := 1;
	len := length($1);
	while (i &lt;= len) loop
		result := result || substr($1, i, 1) || ' ';
		i := i+1;
	end loop;
	return result;
end;
$$ language plpgsql;
</pre>
<p>
OR
</p>
<pre>create or replace function spread(text) returns text
as $$
declare
	result text := '';
	i      integer;
begin
	i := 1;
	for i in 1..length($1) loop
		result := result || substr($1, i, 1) || ' ';
	end loop;
	return result;
end;
$$ language plpgsql;
</pre>
<p>

Note that if you omit the initial assignment of empty string to
<code>result</code>, then the value of <code>result</code> stays
as <code>NULL</code> throughout the entire function execution,
and <code>NULL</code> is returned (i.e., string concatenation is
a null-preserving operation).
</p></div>


</li><li>
<p>
Write a PLpgSQL function to return a table of the first <i>n</i> positive
integers. You may assume the existence of a tuple type:
</p>
<pre>create type IntValue as ( val integer );
</pre>
<p>
The function is used as follows:
</p>
<pre>mydb=&gt; <b>select * from seq(5);</b>
 val
-----
  1
  2
  3
  4
  5
(5 rows)
</pre>
<p>
and has the following signature:
</p>
<pre>create or replace function seq(int) returns setof IntValue
</pre>
<p>
</p>
<p><small>[<a id="q4a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q4&#39;)">show answer</a>]</small></p>
<div id="q4" style="color:#000099;display:none">
<p></p>
<pre>create or replace
	function seq(int) returns setof IntValue
as $$
declare
	i integer;
	r IntValue%rowtype;
begin
	for i in 1 .. $1
	loop
		r.val = i;
		return next r;
	end loop;
	return;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Generalise the previous function so that it returns a table of
integers, starting from <i>lo</i> up to at most <i>hi</i>, with an
increment of <i>inc</i>. The function should also be able to count
down from <i>lo</i> to <i>hi</i> if the value of <i>inc</i> is
negative. An <i>inc</i> value of 0 should produce an empty table.
Use the following function header:
</p>
<pre>create or replace function seq(int,int,int) returns setof IntValue
</pre>
<p>
and the function would be used as follows:
</p>
<pre>mydb=&gt; select * from seq(2,7,2);
 val
-----
  2
  4
  6
(3 rows)
</pre>
<p>
Some other examples, in a more compact representation:
</p>
<pre>seq(1,5,1)   <i>gives</i>   1  2  3  4  5
seq(5,1,-1)  <i>gives</i>   5  4  3  2  1
seq(9,2,-3)  <i>gives</i>   9  6  3
seq(2,9,-1)  <i>gives</i>   empty
seq(1,5,0)   <i>gives</i>   empty
</pre>
<p>
</p>
<p><small>[<a id="q5a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q5&#39;)">show answer</a>]</small></p>
<div id="q5" style="color:#000099;display:none">
<p></p>
<pre>create or replace function
	seq(lo int, hi int, inc int) returns setof IntValue
as $$
declare
	i integer;
	r IntVal%rowtype;
begin
	i := lo;
	if (inc &gt; 0) then
		while (i &lt;= hi)
		loop
			r.val = i;
			return next r;
			i := i + inc;
		end loop;
	elsif (inc &lt; 0) then
		while (i &gt;= hi)
		loop
			r.val = i;
			return next r;
			i := i + inc;
		end loop;
	end if;
	return;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Re-implement the <code>seq(int)</code> function from above
as an <b>SQL function</b>, and making use of the generic
<code>seq(int,int,int)</code> function defined above.
</p>
<p><small>[<a id="q6a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q6&#39;)">show answer</a>]</small></p>
<div id="q6" style="color:#000099;display:none">
<p></p>
<pre>create or replace function
	seq(n int) returns setof IntValue
as $$
declare
	r IntVal%rowtype;
begin
	for r in select * from seq(1,n,1)
	loop
		return next r;
	end loop;
	return;
end;
$$ language plpgsql;
</pre>
<p>
or, it could be done more simply as an SQL function:
</p>
<pre>create or replace function
	seq(int) returns setof IntValue
as $$
	select * from seq(1,$1,1);
$$
language sql;
</pre>
<p>
</p></div>


</li><li>
<p>
Create a new version of the factorial function based on
the above sequence returning functions.
Implement it as an <b>SQL function</b> (not a PLpgSQL function).
The obvious solution to this problem requires a
<code>product</code> aggregate, analogous to the <code>sum</code>
aggregate.
Since PostgreSQL does not have a built-in product aggregate,
you will need to build your own.
In order to achieve the same behaviour as the above PLpgSQL
function for non-positive numbers, you will need to use the
same function signature as before, i.e.:
</p>
<pre>create or replace function fac(int) returns int
</pre>
<p>
Note that PostgreSQL does <em>not</em> have a product aggregate,
so you will need to build your own.
</p>
<p><small>[<a id="q7a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q7&#39;)">show answer</a>]</small></p>
<div id="q7" style="color:#000099;display:none">
<p></p>
<pre>create function fac(int) returns int
as $$
	select product(val) from seq($1);
$$
language sql;

-- where the product aggregate is defined as follows:
-- basetype = type of the input values
-- stype    = type of intermediate states in computing aggregate
-- sfunc    = function mapping (currentState, nextValue) -&gt; newState
-- initcond = value for starting state
-- The "intermediate state" for computing a product is very simple.
-- It's simply the product accumulated so far. Similarly, the mapping
-- function simply multiplies the current product by the next value.
--
-- For more details on defining aggregates, see ...
--     PostgreSQL Reference Manual, SQL section

create aggregate product(int) (
	sfunc     = multiplyNext,
	stype     = int,
	initcond  = 1
);

create function multiplyNext(int,int) returns int
as $$
begin return $1 * $2; end;
$$ language plpgsql;

-- note that the above definitions need to be given in the reverse
-- order to what they're given here in order for this to work
</pre>
<p>
</p></div>

</li></ol>

<p>
Use the Beers/Bars/Drinkers database
from lectures in answering the following questions.
A summary schema for this database:
</p>
<pre>Beers(<b>name</b>:string, manufacturer:string)
Bars(<b>name</b>:string, address:string, license#:integer)
Drinkers(<b>name</b>:string, address:string, phone:string)
Likes(<b><i>drinker</i></b>:string, <b><i>beer</i></b>:string)
Sells(<b><i>bar</i></b>:string, <b><i>beer</i></b>:string, price:real)
Frequents(<b><i>drinker</i></b>:string, <b><i>bar</i></b>:string)
</pre>
<p>
The examples below assume that the user is connected to a database
called <code>beer</code> containing an instance of the above schema.
</p>

<ol start="8">

<li>
<p>
Write a PLpgSQL function called <tt>hotelsIn()</tt>
that takes a single argument giving the name of a suburb,
and returns the names of all hotels in that suburb,
one per line.
It is used as follows:
</p>
<pre>beer=&gt; <b>select hotelsIn('The Rocks');</b>
              hotelsin             
 -------------------------------
  Australia Hotel
  Lord Nelson
 
 (1 row)
</pre>
<p>
Note that the output from functions returning <code>text</code>
looks much better if you turn off output alignment
(via <code>psql</code>'s <code><b>\a</b></code> command)
and get rid of column headings
(via <code>psql</code>'s <code><b>\t</b></code> command).
</p><p>
Compare the aligned output above to the unaligned output below:
</p>
<pre>beer=&gt; <b>\a</b>
Output format is unaligned.
beer=&gt; <b>\t</b>
Showing only tuples.
beer=&gt; <b>select hotelsIn('The Rocks');</b>
Australia Hotel
Lord Nelson
</pre>
<p>
From now on, sample outputs for functions returning <code>text</code>
will assume that we have used <code><b>\a</b></code> and
<code><b>\t</b></code>.
</p>
<p><small>[<a id="q8a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q8&#39;)">show answer</a>]</small></p>
<div id="q8" style="color:#000099;display:none">
Note that this returns a string and not a list of records.
<p></p>
<pre>create or replace function
	hotelsIn(_addr text) returns text
as $$
declare
	r   record;
	out text := '';
begin
	for r in select * from bars where addr = _addr
	loop
		out := out || r.name || '\n';
	end loop;
	return out;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Write a new PLpgSQL function called <tt>hotelsIn()</tt>
that takes a single argument giving the name of a suburb
and returns the names of all hotels in that suburb.
The hotel names should all appear
on a single line, as in the following examples:
</p>
<pre>beer=&gt; <b>select hotelsIn('The Rocks');</b>
Hotels in The Rocks:  Australia Hotel  Lord Nelson 

beer=&gt; <b>select hotelsIn('Randwick');</b>
Hotels in Randwick:  Royal Hotel 

beer=&gt; <b>select hotelsIn('Rendwick');</b>
Hotels in Rendwick:
</pre>
<p><small>[<a id="q9a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q9&#39;)">show answer</a>]</small></p>
<div id="q9" style="color:#000099;display:none">
<pre>create or replace function
	hotelsIn (_addr text) returns text
as $$
declare 
	pubnames text;
	p record;
begin
	pubnames:= 'Hotels in ' || address || ':';
	for p in select * from Bars where addr = _addr
	loop
		pubnames := pubnames||' '||p.name;
	end loop;
	pubnames := pubnames||'\n';
	return pubnames;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Modify the PLpgSQL function in the previous question so that
it prints a more sensible message if there are no hotels
in the named suburb. It should also display the hotel names
on separate lines and numbers them.
It is used as follows:
</p>
<pre>beer=&gt; <b>select hotelsIn('Rendwick');</b>
There are no hotels in Rendwick

beer=&gt; <b>select hotelsIn('The Rocks');</b>
Hotels in The Rocks:
  1. Australia Hotel
  2. Lord Nelson
</pre>
<p>
Use <code>to_char(i,99)</code> to format the numbers.
</p>
<p><small>[<a id="q10a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q10&#39;)">show answer</a>]</small></p>
<div id="q10" style="color:#000099;display:none">
<p>
This uses "select ... into" to extract a count. 
</p>
<pre>create or replace function
	 hotelsIn(_addr text) returns text
as $$
declare 
	pubnames text;
	p record;
	i integer := 0;
	howmany integer := 0;
begin
	select count(*) into howmany from Bars where addr = _addr;
	if (howmany = 0) then 
		return 'There are no hotels in '|| address ||'\n'; 
	end if;
	pubnames := 'Hotels in ' || address || ':\n';
	for p in select * from Bars where addr = _addr
	loop
		i := i+1;
		pubnames := pubnames|| to_char(i,99) ||'. '||p.name||'\n';
	end loop;
	return pubnames;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li>
<p>
Write a PLpgSQL procedure <code>happyHourPrice</code> that accepts
the name of a hotel, the name of a beer and the number of dollars
to deduct from the price, and returns a new price.
The procedure should check for the following errors:
</p><ul>
<li> non-existent hotel (invalid hotel name)
</li><li> non-existent beer (invalid beer name)
</li><li> beer not available at the specified hotel
</li><li> invalid price reduction (e.g. making reduced price negative)
</li></ul>
Use <code>to_char(price,'$9.99')</code> to format the prices.
<p></p>
<pre>beer=&gt; <b>select happyHourPrice('Oz Hotel','New',0.50);</b>
There is no hotel called 'Oz Hotel'.

beer=&gt; <b>select happyHourPrice('Australia Hotel','Newer',0.50);</b>
There is no beer called 'Newer'.

beer=&gt; <b>select happyHourPrice('Australia Hotel','New',0.50);</b>
The Australia Hotel does not serve New

beer=&gt; <b>select happyHourPrice('Australia Hotel','Burragorang Bock',4.50);</b>
Price reduction is too large; Burragorang Bock only costs $ 3.50

beer=&gt; <b>select happyHourPrice('Australia Hotel','Burragorang Bock',1.50);</b>
Happy hour price for Burragorang Bock at Australia Hotel is $ 2.00
</pre>
<p>
</p>
<p><small>[<a id="q11a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q11&#39;)">show answer</a>]</small></p>
<div id="q11" style="color:#000099;display:none">
<p>
This could be done using either all <code>select count(*)</code> followed
by a check for zero, or by using the <code>FOUND</code> variable (which
is set after each query).
This solution combines both approaches to show the range of possiblities.
</p><p>
In general, you could use <code>count(*)</code> whenever you knew that
you were not interested in collecting any other information from the
table; you'd try to collect the information and use <code>FOUND</code>
in all other circumstances.
</p>
<pre><font color="gray">-- using positional notation for parameters</font>
create or replace function
	happyHourPrice (_hotel text, _beer text, _discount real) returns text
as $$
declare 
	counter integer;
	std_price real;
	new_price real;
begin
	select into counter count(*) from Bars where name = _hotel;
	if (counter = 0) then 
		return 'There is no hotel called '|| _hotel ||'.\n';
	end if;
	select into counter count(*) from Beers where name = _beer;
	if (counter = 0) then
		return 'There is no beer called '|| _beer ||'.\n';
	end if;
	select price into std_price
	from   Sells s
	where  s.beer = _beer and s.bar = _hotel;
	if (not found) then
		return 'The '|| _hotel || ' does not serve '||_beer;
	end if;
	new_price := std_price - _discount;
	if (new_price &lt; 0) then
		return 'Price reduction is too large; '
			   || _beer || ' only costs '
			   || to_char(std_price, '$9.99');
	else	
		return 'Happy hour price for '
			   || _beer || ' at '|| _hotel ||' is '
			   || to_char(new_price, '$9.99');	
	end if;
end;
$$ language plpgsql;
</pre>
</div>

</li><li>
<p>
The <code>hotelsIn</code> function above returns a formatted string
giving details of the bars in a suburb. If we wanted to return a
table of records for the bars in a suburb, we could use a view as
follows:
</p>
<pre>beer=&gt; <b>create or replace view HotelsInTheRocks as</b>
    -&gt; <b>select * from Bars where addr = 'The Rocks';</b>
CREATE VIEW
beer=&gt; <b>select * from HotelsInTheRocks;</b>
      name       |   addr    | license 
-----------------+-----------+---------
 Australia Hotel | The Rocks |  123456
 Lord Nelson     | The Rocks |  123888
(2 rows)
</pre>
<p>
Unfortunately, we need to specify a suburb in the view definition.
It would be more useful if we could define a <q>parameterised view</q>
which we could use to generate a table for any suburb, e.g.
</p>
<pre>beer=&gt; <b>select * from HotelsIn('The Rocks');</b>
      name       |   addr    | license 
-----------------+-----------+---------
 Australia Hotel | The Rocks |  123456
 Lord Nelson     | The Rocks |  123888
(2 rows)
beer=&gt; <b>select * from hotelsIn('Coogee');</b>
       name       |  addr  | license 
------------------+--------+---------
 Coogee Bay Hotel | Coogee |  966500
(1 row)
</pre>
<p>
Such a parameterised view can be implemented via an SQL function,
defined as:
</p>
<pre>create or replace function hotelsIn(text) returns setof Bars
as $$ ... $$ language sql;
</pre>
<p>
Complete the definition of the SQL function.
</p>
<p><small>[<a id="q12a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q12&#39;)">show answer</a>]</small></p>
<div id="q12" style="color:#000099;display:none">
<p></p>
<pre>create or replace function
	hotelsIn(text) returns setof Bars
as $$ 
	select * from Bars where addr = $1;
$$ language sql;
</pre>
<p>
</p></div>

</li><li>
<p>
The function for the previous question can also be implemented in
PLpgSQL. Give the PLpgSQL definition. It would be used in the same
way as the above.
</p>
<p><small>[<a id="q13a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q13&#39;)">show answer</a>]</small></p>
<div id="q13" style="color:#000099;display:none">
<pre>create or replace function
	hotelsIn(_addr text) returns setof Bars
as $$ 
declare
	r record;  <font color="gray">-- could also be declared r Bars%rowtype;</font>
begin
	for r in select * from Bars where addr = _addr
	loop
	   return next r;
	end loop;
	return;
end;
$$ language plpgsql;
</pre>
</div>

</li></ol>

<p>
Use the
<a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/bank/index.html">Bank Database</a>
in answering the following questions.
A summary schema for this database:
</p>
<pre>Branches(<b>location</b>:text, address:text, assets:real)
Accounts(<i><b>holder</b></i>:text, <i><b>branch</b></i>:text, balance:real)
Customers(<b>name</b>:text, address:text)
Employees(<b>id</b>:integer, name:text, salary:real)
</pre>
<p>
The examples below assume that the user is connected to a database
called <code>bank</code> containing an instance of the above schema.
</p>


<ol start="14">

<li>
<p>
For each of the following, write both an SQL and a PLpgSQL
function to return the result:
</p>

<ol type="a">
<li><p>
salary of a specified employee
</p>
<p><small>[<a id="q14a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q14&#39;)">show answer</a>]</small></p>
<div id="q14" style="color:#000099;display:none">
<pre>-- Salary of a specified employee
--   Allows employee to be determined by name or id
--    using overloading on the function name
--   Assume name or id identifies only one employee

create or replace function empSal(text) returns real
as $$
	select salary from employees where name = $1
$$ language sql;

create or replace function empSal(integer) returns real
as $$
	select salary from employees where id = $1
$$ language sql;

create or replace function
	empSal1(_name text) returns real
as $$
declare
	_sal real;
begin
	select salary into _sal
	from employees where name = _name;
	return _sal;
end;
$$ language plpgsql;

create or replace function
	empSal1(_id integer) returns real
as $$
declare
	_sal real;
begin
	select salary into _sal
	from employees where id = _id;
	return _sal;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li><p>
all details of a particular branch
</p>
<p><small>[<a id="q15a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q15&#39;)">show answer</a>]</small></p>
<div id="q15" style="color:#000099;display:none">
<pre>-- All details of a particular branch
--   Example of PLpgSQL function returning a record

create or replace function branchDetails(text) returns Branches
as $$
	select * from Branches where location = $1;
$$ language sql;


create or replace function branchDetails1(_bname text) returns Branches
as $$
declare
	_tup Branches;
begin
	select * into _tup
	from Branches where location = _bname;
	return _tup;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li><p>
names of all employees earning more than $<i>sal</i>
</p>
<p><small>[<a id="q16a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q16&#39;)">show answer</a>]</small></p>
<div id="q16" style="color:#000099;display:none">
<p></p>
<pre>-- Names of all employees earning more than $sal
--   Example of PLpgSQL function returning a set of atomic values

create or replace function empsWithSal(real) returns setof text
as $$
	select name from employees where salary &gt; $1;
$$ language sql;

create type EmpName as ( name text );

create or replace function empsWithSal1(_minSal real) returns setof EmpName
as $$
declare
	_en EmpName;
begin
	for _en in select name
		   from employees where salary &gt; _minSal
	loop
		return next _en;
	end loop;
	return;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>

</li><li><p>
all details of highly-paid employees
</p>
<p><small>[<a id="q17a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q17&#39;)">show answer</a>]</small></p>
<div id="q17" style="color:#000099;display:none">
<p></p>
<pre>-- All details of highly-paid employees 
--   Example of PLpgSQL function returning a set of atomic values

create or replace function richEmps(real) returns setof Employees
as $$
	select * from employees where salary &gt; $1;
$$ language sql;

create or replace function emps1(_minSal real) returns setof Employees
as $$
declare
	_e Employee;
begin
	for _e in select *
	          from employees where salary &gt; _minSal
	loop
		return next _e;
	end loop;
	return;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>
</li></ol>

</li><li>
<p>
Write a PLpgSQL function to produce a report giving
details of branches:
</p><ul>
<li> name and address of branch
</li><li> list of customers who hold accounts at that branch
</li><li> total amount in accounts held at that branch
</li></ul>
Use the following format for each branch:
<p></p>
<pre>Branch: Clovelly, Clovelly Rd.
Customers:  Chuck Ian James
Total deposits: $   8860.00
</pre>
<p>
</p>
<p><small>[<a id="q18a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q18&#39;)">show answer</a>]</small></p>
<div id="q18" style="color:#000099;display:none">
<p></p>
<pre>create or replace function branchList() returns text
as $$
declare
	a   record;
	b   record;
	tot integer;
	qry text;
	out text := '\n';
begin
	for b in select * from Branches
	loop
		out := out || 'Branch: ' || b.location || ', ';
		out := out || b.address || E'\\n' || 'Customers: ';
		tot := 0;
		for a in select * from Accounts where branch=b.location
		loop
			out := out || ' ' || a.holder;
			tot := tot + a.balance;
		end loop;
		select sum(balance) into tot
		from Accounts where branch=b.location;
		out := out || E'\\nTotal deposits: ';
		out := out || to_char(tot,'$999999.99');
		out := out || E'\\n---\\n';
	end loop;
	return out;
end;
$$ language plpgsql;
</pre>
<p>
It's also possible to implement this more efficiently using just one SQL
query (rather than nested-loop queries). The more efficient solution
invloves ordering the Accounts tuples by branch, and keeping track of
when the current branch changes to a new one.
</p></div>

</li></ol>

<p>
Use the
<a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/unswsis/index.html">UNSWSIS Database</a>
in answering the following questions.
Note that the UNSWSIS schema is very similar to <em>but not the same as</em>
the MyMyUNSW schema (in fact, UNSWSIS is an older version of MyMyUNSW).
The schema is too large to give a complete summary here, but we provide
some details for some tables:
</p>
<pre>Person(<b>id</b>:integer, ..., name:text, ...)
Student(<i><b>id</b></i>:integer, sid:integer, stype:('local','intl'))
Staff(<i><b>id</b></i>:integer, sid:integer, <i>office</i>:integer, ...)
Term(<b>id</b>:integer, year:integer, session:('S1','S2','X1','X2'), ...)
Subject(<b>id</b>:integer, code:text, ..., name:text, ... uoc:integer, ...)
Course(<b>id</b>:integer, <i>subject</i>:integer, <i>term</i>:integer, <i>lic</i>:integer, ...)
</pre>
<p>
The examples below assume that the user is connected to a database
called <code>unswsis</code> containing an instance of the above schema.
</p>

<ol start="16">

<li>
<p>
Write a PLpgSQL function to produce the complete name of an
OrgUnit:
</p>
<pre>function unitName(_ouid integer) returns text
</pre>
<p>
The function returns the complete name using the rules:
</p><ul>
<li> the university is denoted by UNSW
</li><li> a faculty is denoted using its base name <small>(not all faculty names start with Faculty)</small>
</li><li> a school is denoted School of XYZ
</li><li> a department is denoted Department of XYZ
</li><li> a centre is denoted Centre for XYZ
</li><li> an institute is denoted Institute of XYZ
</li><li> other kinds of OrgUnits are treated as having no name (i.e. return null)
</li></ul>
<p></p>
<p><small>[<a id="q19a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q19&#39;)">show answer</a>]</small></p>
<div id="q19" style="color:#000099;display:none">
<p></p>
<pre>create or replace function unitName(_ouid integer) returns text
as $$
declare
	_outype text;
	_ouname text;
begin
	-- check whether the orgunit ID is valid
	select * from OrgUnit where id = _ouid;
	if (not found) then
		raise exception 'No such unit: %',_ouid;
	end if;

	select t.name,u.longname into _outype,_ouname
	from   OrgUnitType t, OrgUnit u
	where  u.id = _ouid and u.utype = t.id;

	-- debugging output
	-- raise notice 'Type:%, Name:%',_outype,_ouname;

	if (_outype = 'UNSW') then
		return 'UNSW';
	elsif (_outype = 'Faculty') then
		return _ouname;
	elsif (_outype = 'School') then
		return 'School of '||_ouname;
	elsif (_outype = 'Department') then
		return 'Department of '||_ouname;
	elsif (_outype = 'Centre') then
		return 'Centre for '||_ouname;
	elsif (_outype = 'Institute') then
		return 'Institute of '||_ouname;
	else
		return null;
	end if;
end;
$$ language plpgsql;
</pre>
<p>
An alternative, using an SQL <tt>CASE</tt> expression:
</p>
<pre>create or replace function unitName(_ouid integer) returns text
as $$
declare
	_ouname text;
begin
	-- check whether the orgunit ID is valid
	select * from OrgUnit where id = _ouid;
	if (not found) then
		raise exception 'No such unit: %',_ouid;
	end if;

	select case
	       when t.name = 'UNSW' then 'UNSW'
	       when t.name = 'Faculty' then t.longname
	       when t.name = 'School' then 'School of '||t.longname
	       when t.name = 'Department' then 'Department of '||t.longname
	       when t.name = 'Centre' then 'Centre for '||t.longname
	       when t.name = 'Institute' then 'Institute of '||t.longname
	       else null
	       end into _ouname
	from   OrgUnitType t, OrgUnit u
	where  u.id = _ouid and u.utype = t.id;
	return _ouname;
end;
$$ language plpgsql;
</pre>
<p>
If you didn't care about error-checking on the OrgUnit ID, then
this could be done as an SQL function.
</p>
</div>

</li><li>
<p>
Write a PLpgSQL function to produce a transcript as a
set of <tt>TranscriptEntry</tt> tuples, where the tuple
type is defined as:
</p>
<pre>create type TranscriptEntry as (
   course  text,      -- e.g. 'COMP1911 06s1 Computing 1'
   mark    integer,   -- e.g. 50
   grade   char(2),   -- e.g. 'PS'
   uoc     integer    -- e.g. 6
);
</pre>
<p>
</p><p>
As well as producing the standard <tt>TranscriptEntry</tt> tuples,
this function should also produce a <q>special</q>
<tt>TranscriptEntry</tt> tuple at the end of each run of courses
from a given session, where:
</p>
<ul>
<li> the <tt>course</tt> field holds the string <tt>'WAM for YYsN'</tt>
</li><li> the <tt>mark</tt> field holds the WAM for that session
</li><li> all other attributes are NULL
</li></ul>
<p>
The WAM (weighted average mark) is an important summary of a student's
achievement at UNSW. Let us assume that WAMs are computed according to
the following:
</p>
<ul>
<li> each course for which a mark is available is counted,
        all other courses are ignored<br>
	(e.g. courses graded SY/FL have no mark
	and are thus not included)
</li><li> General Education is counted as a normal course for
	computing the WAM
</li><li> substitutions or advanced standing subjects are counted
	as normal courses<br>for computing the WAM, provided
	that they are based on UNSW subjects
</li><li> courses with marks available are denoted c1, c2, c3, ...
</li><li> the units of credit for course c1 are denoted uoc(c1)
</li><li> weighted_sum = mark(c1)*uoc(c1) + mark(c2)*uoc(c2) + ...
</li><li> WAM = weighted_sum / (uoc(c1) + uoc(c2) + ...)
</li></ul>
<p></p>
<p>
The WAM should be computed while the course result tuples
are being read; it should not be computed by invoking a
new query.
</p>
<p></p>
<p><small>[<a id="q20a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q20&#39;)">show answer</a>]</small></p>
<div id="q20" style="color:#000099;display:none">
<p></p>
<pre>-- result tuples for internal ts() function

create type TranscriptRecord as (
	code	char(8),
	title   text,
	term    integer,
	year	integer,
	sess	char(2),
	tstart  date,
	mark	integer,
	grade	char(2),
	uoc	integer
);

-- ts() returns a list of Transcript tuples for one student

create or replace function
	ts(integer) returns setof TranscriptRecord
as $$
select s.code,s.name as title,
	t.id as term,t.year,t.sess,t.startdate as tstart,
	e.mark,e.grade,s.uoc
from   Subject s, Course c, Term t,
	CourseEnrolment e, Student stu
where  stu.sid = $1 and stu.id = e.student
	and e.course = c.id and c.term = t.id
	and c.subject = s.id
$$
language sql;


--  result tuples for transcript() function

create type TranscriptEntry as (
	course  text,      -- e.g. 'COMP1911 06s1 Computing 1'
	mark    integer,   -- e.g. 50
	grade   char(2),   -- e.g. 'PS'
	uoc     integer    -- e.g. 6

-- builds contents of special TranscriptEntry for term WAM

create or replace function
	termRec(_tr TranscriptRecord, _weighted numeric, _sumUoC integer)
	returns TranscriptEntry
as $$
declare
	_te  TranscriptEntry;
begin
	_te := (null,null,null,null);
	_te.course := 'WAM for ' ||termName(_tr.year,_tr.sess);
	if (_sumUoC = 0) then
		_te.course = 'No '||_te.course;
	else
		_te.mark = (_weighted/_sumUoC)::integer;
	end if;
	_te.course := '=== '||_te.course;
	return _te;
end;
$$ language plpgsql;

-- main transcript() function that drives everything else

create or replace function
	transcript(_sid integer) returns setof TranscriptEntry
as $$
declare
	_stu          Student;
	_termWeighted numeric := 0;
	_termSumUoC   integer := 0;
	_tr           TranscriptRecord;
	_prev         TranscriptRecord;
	_te           TranscriptEntry;
begin
	select * into _stu from Student where sid = _sid;
	if (not found) then
		raise exception 'No such student: %',_sid;
	end if;

	-- foreach transcript record, in the correct order

	for _tr in select * from ts(_sid) order by tstart,code
	loop
		if (_prev.term &lt;&gt; _tr.term) then
			-- transition from one term to next
			-- summarise any existing term info
			if (_prev.term is not null) then
				_te := termRec(_prev,_termWeighted,_termSumUoC);
				return next _te;
			end if;
			-- set up to compute wam for next term
			_termWeighted := 0;
			_termSumUoc := 0;
		end if;
		_te.course := _tr.code||' '||termName(_tr.year,_tr.sess)
				||' '||_tr.title;
		_te.mark   := _tr.mark;
		_te.grade  := _tr.grade;
		_te.uoc    := _tr.uoc;
		return next _te;
		if (_tr.mark is not null) then
			_termWeighted := _termWeighted + (_tr.mark * _tr.uoc);
			_termSumUoC := _termSumUoC + _tr.uoc;
		end if;
		_prev := _tr;
	end loop;
	if (_prev.term is not null) then
		_te := termRec(_prev,_termWeighted,_termSumUoC);
		return next _te;
	end if;
	return;
end;
$$ language plpgsql;
</pre>
<p>
</p></div>


</li><li>
<p>
Write a PLpgSQL function which takes the numeric identifier of
a given OrgUnit and returns the numeric identifier of the parent
faculty for the specified OrgUnit:
</p>
<pre>function facultyOf(_ouid integer) returns integer
</pre>
<p>
Note that a faculty is treated as its own parent. Note also that
some OrgUnits don't belong to any faculty; such OrgUnits should
return a null result from the function.
</p>
<p><small>[<a id="q21a" href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/exercises/05/index.php##" onclick="toggleVisible(&#39;q21&#39;)">show answer</a>]</small></p>
<div id="q21" style="color:#000099;display:none">
<p></p>
<pre>create or replace function facultyOf(_ouid integer) returns integer
as $$
declare
	_count integer;
	_tname text;
	_parent integer;
begin
	select count(*) into _count
	from orgUnit where id = _ouid;
	if (_count = 0) then
		raise exception 'No such unit: %',_ouid;
	end if;

	select t.name into _tname
	from OrgUnit u, OrgUnitType t
	where u.id = _ouid and u.utype = t.id;

	if (_tname is null) then
		return null;
	elsif (_tname = 'University') then
		return null;
	elsif (_tname = 'Faculty') then
		return _ouid;
	else
		select owner into _parent
		from UnitGroups where member = _ouid;
		return facultyOf(_parent);
	end if;
end;
$$ language plpgsql;
</pre>
<p>
An alternative way of checking the existence of the specified
organisational unit would be:
</p>
<pre>	select * from OrgUnit where id = _ouid;
	if (not found) then
		raise exception 'No such unit: %',_ouid;
	end if;
</pre>
</div>




</li></ol></body></html>