<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0060)https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/04b/index.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>COMP3311 19s1 - Prac Exercise 04b</title>
<link rel="stylesheet" type="text/css" href="./19s1 - Prac Exercise 04b_files/course.css"><script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B站下载助手"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili 哔哩哔哩 B站 下载助手 帮你下载版权受限（能看不能缓存）的 番剧 视频","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili哔哩哔哩下载助手","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"加载中"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"加载中"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${m(t)}) 正在下载`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${m(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${m(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<div align="center">
<table width="100%" border="0">
<tbody><tr valign="top">
<td align="left" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">COMP3311 19s1</a></span>
</td>
<td align="center" width="50%">
  <span class="heading">Prac Exercise 04b</span><br>
  <span class="subheading">SQL Queries, Views, and Aggregates (ii)</span>
</td>
<td align="right" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">Database Systems</a></span>
</td>
</tr></tbody></table>
</div><!--
<div style="text-align:center;font-size:80%;color:#555555;margin-top:5px;">
Last updated: <b>Monday 11th March 7:03pm</b> <br>
Most recent changes are shown in <span class="red">red</span> ...
older changes are shown in <span class="brown">brown</span>. <br>
</div>-->

<h3>Aims</h3>

This exercise aims to give you practice in:
<ul>
<li> asking SQL queries on a relatively simple schema
</li><li> using SQL aggregation and grouping operators
</li><li> writing SQL view definitions
</li><li> porting SQL across multiple database management systems
</li></ul>
This exercise will <b>not</b> explain how
to do everything in fine detail. Part of the aim of the exercise is that you
explore how to use the PostgreSQL and SQLite systems.
The documentation for these systems contains much useful information:
<a href="https://www.postgresql.org/docs/current/static/index.html">PostgreSQL Manual</a>,
<a href="http://www.sqlite.org/docs.html">SQLite Manual</a>.
You should become familiar with where to find useful information in
the documentation ASAP; you will need to know how to use PostgreSQL for
the assignments and how to use SQLite for the exam.

<h3>Background</h3>
<p>
In lectures, we used a simple database about beers, bars and drinkers to
illustrate aspects of querying in SQL.
The database was designed to simplify queries by using symbolic primary
keys (e.g., <tt>Beers.name</tt>).
In practice, we don't use symbolic primary keys because: (a) they typically
occupy more space than a numeric key, (b) symbolic names have an annoying
tendency to change over time (e.g., you might change your email, and
having email as a primary key creates a multitude of update problems).
Therefore, we have designed a (slightly) more realistic schema for representing
the same information:
</p>
<center>
<img src="./19s1 - Prac Exercise 04b_files/beer-v2-schema.png">
</center>
<p>
The SQL schema will obviously be different to the schema used in lectures,
and is available in the file:
</p>
<pre>/home/cs3311/web/19s1/pracs/04b/schema.sql
</pre>
<p>
This schema is written in portable SQL and so should load into both
PostgreSQL and SQLite without errors.
</p>
<p>
If you're working on your laptop (and not via <tt>putty</tt>), you can
grab copies of all files used in this Prac in the ZIP archive:
</p>
<pre><a href="https://www.cse.unsw.edu.au/~cs3311/19s1/pracs/04b/prac.zip">/home/cs3311/web/19s1/pracs/04b/prac.zip</a>
</pre>

<h3> Setting up the PostgreSQL Database</h3>
<p>
Login to a machine with a PostgreSQL server running.
If you already have a <tt>beer2</tt> database and you want to replace it,
you will, of course, need to drop it first:
</p>
<pre>$ <b>dropdb beer2</b>
</pre>
<p>
Then do the following:
</p>
<pre>$ <b>createdb beer2</b>
<comment>... make a new empty database ...</comment>
$ <b>psql beers -f schema.sql</b>
<comment>... load the schema ... produces CREATE TABLE, etc. messages ...</comment>
$ <b>psql beers -f data.sql</b>
<comment>... load the tuples ... poduces INSERT messages ...</comment>
</pre>
<p>
You now have a database that you can use via:
</p>
<pre>$ <b>psql beer2</b>
<comment>... run SQL commands ...</comment>
</pre>

<h3>Setting up the SQLite Database</h3>
<p>
Login to a machine with SQLite installed and do the following:
</p>
<pre>% <b>sqlite3 beer2.db</b>
SQLite version 3.8.7.1 2014-10-29 13:59:56
Enter ".help" for usage hints.
sqlite&gt; <b>.read /home/cs3311/web/19s1/pracs/04b/schema.sql</b>
sqlite&gt; <b>.read /home/cs3311/web/19s1/pracs/04b/data.sql</b>
sqlite&gt; <b>.quit</b>
% 
</pre>
<p>
This will create a file called <tt>beer2.db</tt> in the current directory.
You now have a database that you can use via:
</p>
<pre>$ <b>sqlite3 beer2.db</b>
<comment>... run SQL commands ...</comment>
</pre>

<h3>Exercises</h3>
<p>
Use the two databases you created above to do the exercises below.
The same view definitions should work in both databases.
Perhaps you could alternate between developing and testing the
view first in PostgreSQL and then testing it in SQLite, and vice
versa.
The aim is to get practice in building queries in both databases.
</p>
<p>
In the questions below, you are required to produce SQL queries
to solve a range of data retrieval problems on this schema.
For each problem, create a view called <tt>Q</tt><i>n</i>
which holds the <q>top-level</q> SQL statement that produces
the answer (this SQL statement may make use of any views defined
earlier in the Prac Exercise). 
In producing a solution for each problem, you may define as many
auxiliary views as you like.
</p>
<p>
To simplify the process of producing these views, a template
file (<a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/04b/queries.sql"><tt>queries.sql</tt></a>) is available.
While you're developing your views, you might find it convenient
to edit the views in one window (i.e. edit the <tt>queries.sql</tt>
file containing the views) and copy-and-paste the view definitions
into another window running <tt>psql</tt> or <tt>sqlite3</tt>.
</p>
<p>
Note that the order of tuples in the results does not matter.
As long as you have the same set of tuples, your view is correct.
Remember that, in theory, the output from an SQL query is a set.
Some test queries use an explicit ordering, but that should not
be included in the view definition.
</p>
<p>
Note also that the sample outputs typically use column names
that are different to the column names in the table.
You should use the column names given in the sample output;
treat them as part of description of the question.
</p>
<p>
Once you have completed each of the view definitions, you can
test it simply by typing:
</p>
<pre>beer2=# <b>select * from Q<i>n</i>;</b>
</pre>
<p>
and observing whether the result matches the expected result
given below.
Note that I'll give all the results in PostgreSQL format;
the SQLite tuples don't look precisely the same, but it
should be clear enough that it <i>is</i> the same set of
tuples.
</p>

<h3>Queries on Beer Database v2</h3>
<p>
Write an SQL view to answer each of the following queries.
Note that <em>none</em> of your queries should contain internal <tt>id</tt>
values; all references to entities in queries should be via their name.
</p>
<ol>
<li>
<p>
<b><i>What beers are made by Toohey's?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q1;</b>
    beer     
-------------
 New
 Old
 Red
 Sheaf Stout
(4 rows)
</pre>
</li>
<li>
<p>
<b><i>Show beers with headings "Beer", "Brewer".</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q2;</b>
           Beer           |       Brewer        
--------------------------+---------------------
 80/-                     | Caledonian
 Amber Ale                | James Squire
 Bigfoot Barley Wine      | Sierra Nevada
 Burragorang Bock         | George IV Inn
 Chestnut Lager           | Bridge Road Brewers
 Crown Lager              | Carlton
 Fosters Lager            | Carlton
 India Pale Ale           | James Squire
 Invalid Stout            | Carlton
 Melbourne Bitter         | Carlton
 New                      | Toohey's
 Nirvana Pale Ale         | Murray's
 Old                      | Toohey's
 Old Admiral              | Lord Nelson
 Pale Ale                 | Sierra Nevada
 Pilsener                 | James Squire
 Porter                   | James Squire
 Premium Lager            | Cascade
 Red                      | Toohey's
 Sink the Bismarck        | Brew Dog
 Sheaf Stout              | Toohey's
 Sparkling Ale            | Cooper's
 Stout                    | Cooper's
 Tactical Nuclear Penguin | Brew Dog
 Three Sheets             | Lord Nelson
 Victoria Bitter          | Carlton
(26 rows)
</pre>
</li>
<li>
<p>
<b><i>Find the brewers whose beers John likes.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q3;</b>
    brewer     
---------------
 Brew Dog
 James Squire
 Lord Nelson
 Sierra Nevada
 Caledonian
(5 rows)
</pre>
</li>
<li>
<p>
<b><i>How many different beers are there?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q4;</b>
 #beers 
--------
     26
(1 row)
</pre>
</li>
<li>
<p>
<b><i>How many different brewers are there?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q5;</b>
 #brewers 
----------
       12
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Find pairs of beers by the same manufacturer</i></b> (but no (a,b) and (b,a) pairs, or (a,a))
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q6;</b>
        beer1        |          beer2           
---------------------+--------------------------
 Amber Ale           | Porter
 Amber Ale           | Pilsener
 Amber Ale           | India Pale Ale
 Bigfoot Barley Wine | Pale Ale
 Crown Lager         | Victoria Bitter
 Crown Lager         | Melbourne Bitter
 Crown Lager         | Invalid Stout
 Crown Lager         | Fosters Lager
 Fosters Lager       | Victoria Bitter
 Fosters Lager       | Melbourne Bitter
 Fosters Lager       | Invalid Stout
 India Pale Ale      | Porter
 India Pale Ale      | Pilsener
 Invalid Stout       | Victoria Bitter
 Invalid Stout       | Melbourne Bitter
 Melbourne Bitter    | Victoria Bitter
 New                 | Sheaf Stout
 New                 | Red
 New                 | Old
 Old                 | Sheaf Stout
 Old                 | Red
 Old Admiral         | Three Sheets
 Pilsener            | Porter
 Red                 | Sheaf Stout
 Sink the Bismarck   | Tactical Nuclear Penguin
 Sparkling Ale       | Stout
(26 rows)
</pre>
</li>
<li>
<p>
<b><i>How many beers does each brewer make?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q7 order by brewer;</b>
       brewer        | nbeers 
---------------------+--------
 Brew Dog            |      2
 Bridge Road Brewers |      1
 Caledonian          |      1
 Carlton             |      5
 Cascade             |      1
 Cooper's            |      2
 George IV Inn       |      1
 James Squire        |      4
 Lord Nelson         |      2
 Murray's            |      1
 Sierra Nevada       |      2
 Toohey's            |      4
(12 rows)
</pre>
</li>
<li>
<p>
<b><i>Which brewer makes the most beers?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q8;</b>
 brewer  
---------
 Carlton
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Beers that are the only one by their brewer.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q9;</b>
       beer       
------------------
 80/-
 Burragorang Bock
 Chestnut Lager
 Nirvana Pale Ale
 Premium Lager
(5 rows)
</pre>
</li>
<li>
<p>
<b><i>Beers sold at bars where John drinks.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q10 order by beer;</b>
       beer        
-------------------
 Burragorang Bock
 New
 Old
 Old Admiral
 Pale Ale
 Sink the Bismarck
 Sparkling Ale
 Three Sheets
 Victoria Bitter
(9 rows)
</pre>
<p>
You might like to consider a variation on this query to find
just the beers that John likes that are sold in the bars where
he drinks. The solution is given in the solutions file.
</p>
</li>
<li>
<p>
<b><i>Bars where either Gernot or John drink.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q11 order by bar;</b>
      bar 
------------------
 Australia Hotel
 Coogee Bay Hotel
 Local Taphouse
 Lord Nelson
 Royal Hotel
(5 rows)
</pre>
</li>
<li>
<p>
<b><i>Bars where both Gernot and John drink.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q12;</b>
     bar     
-------------
 Lord Nelson
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Bars where John drinks but Gernot doesn't</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q13;</b>
       bar        
------------------
 Australia Hotel
 Local Taphouse
 Coogee Bay Hotel
(3 rows)
</pre>
</li>
<li>
<p>
<b><i>What is the most expensive beer?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q14;</b>
       beer        
-------------------
 Sink the Bismarck
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Find bars that serve New at the same price as the Coogee Bay Hotel charges for VB.</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q15;</b>
     bar     
-------------
 Royal Hotel
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Find the average price of common beers</i></b> (where "common" = served in more than two hotels)
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q16;</b>
      beer       | AvgPrice 
-----------------+----------
 Victoria Bitter |     2.40
 New             |     2.59
 Old             |     2.68
(3 rows)
</pre>
</li>
<li>
<p>
<b><i>Which bar sells 'New' cheapest?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q17;</b>
     bar      
--------------
 Regent Hotel
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Which bar is most popular?</i></b> (Most drinkers)
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q18;</b>
       bar        
------------------
 Coogee Bay Hotel
 Lord Nelson
(2 rows)
</pre>
</li>
<li>
<p>
<b><i>Which bar is least popular?</i></b> (May have no drinkers)
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q19;</b>
       bar       
-----------------
 Local Taphouse
 Marble Bar
 Regent Hotel
 Australia Hotel
 Royal Hotel
(5 rows)
</pre>
</li>
<li>
<p>
<b><i>Which bar is most expensive?</i></b> (Highest average price)
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q20;</b>
      bar       
----------------
 Local Taphouse
(1 row)
</pre>
</li>
<li>
<p>
<b><i>Which beers are sold at all bars?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q21;</b>
 beer 
------
(0 rows)
</pre>
<p>
i.e. no beers are sold at all bars.
</p>
</li>
<li>
<p>
<b><i>Price of cheapest beer at each bar?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q22;</b>
       bar        | min_price 
------------------+-----------
 Coogee Bay Hotel |      2.25
 Local Taphouse   |      7.50
 Royal Hotel      |      2.30
 Australia Hotel  |      3.00
 Regent Hotel     |      2.20
 Marble Bar       |      2.80
 Lord Nelson      |      3.00
(7 rows)
</pre>
</li>
<li>
<p>
<b><i>Name of cheapest beer at each bar?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q23;</b>
       bar        |      beer       
------------------+-----------------
 Australia Hotel  | New
 Coogee Bay Hotel | New
 Lord Nelson      | New
 Marble Bar       | New
 Marble Bar       | Victoria Bitter
 Regent Hotel     | New
 Regent Hotel     | Victoria Bitter
 Royal Hotel      | Victoria Bitter
 Royal Hotel      | New
 Local Taphouse   | Pale Ale
(10 rows)
</pre>
</li>
<li>
<p>
<b><i>How many drinkers are in each suburb?</i></b>
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q24;</b>
   addr   | count 
----------+-------
 Randwick |     1
 Mosman   |     1
 Newtown  |     1
 Clovelly |     1
(4 rows)
</pre>
</li>
<li>
<p>
<b><i>How many bars in suburbs where drinkers live?</i></b> (must include suburbs with no bars)
</p>
<p>
In PostgreSQL, the results should look like:
</p>
<pre>beer2=# <b>select * from Q25;</b>
   addr   | #bars 
----------+-------
 Randwick |     1
 Mosman   |     0
 Newtown  |     0
 Clovelly |     0
(4 rows)
</pre>
</li>


</ol>

<p>
You should attempt the above exercises before looking at the
<a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/04b/soln1.sql">PostgreSQL sample solutions</a>.
</p>

<h3>Queries in SQLite</h3>
<p>
Now that you've attempted the above exercises in PostgreSQL,
let's consider how things would work in SQLite.
This provides an interesting exercise in SQL portability,
since both databases support "standard SQL".
</p><p>
</p><p>
Make a copy of your <tt>queries.sql</tt> file and start testing
the views that you created for PostgreSQL for SQLite.
If you want to make the query results from SQLite look more like
those from PostgreSQL, run the following commands at the start
of your SQLite session:
</p>
<pre>$ <b>sqlite3 beer2.db</b>
SQLite version 3.8.7.1 2014-10-29 13:59:56
Enter ".help" for usage hints.
sqlite&gt; <b>.headers on</b>
sqlite&gt; <b>.mode column</b>
sqlite&gt; <b>.width 20 20 20 20</b>
sqlite&gt; <comment>... continue with your SQL queries ... </comment>
</pre>
<p>
Note that SQLite is not quite as smart as PostgreSQL when it comes to choosing
column widths. All columns will be 20 characters wide if you use the above
settings. Note that any values that are wider than 20 characters will be truncated.
If you can't be bothered typing these commands each time, put them in a file
called <tt>.sqliterc</tt> in your home directory and they'll be executed each
time you run <tt>sqlite3</tt>.
</p>
<p>
As we noticed in the <a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/04/index.php">previous Prac Exercise</a>,
SQLite doesn't support the definition of views via:
</p>
<pre>create or replace view <i>ViewName</i> as ...
</pre>
<p>
The fix for this is simple enough. Change all of the view definitions
to something like:
</p>
<pre>drop view if exists <i>ViewName</i>;
create view <i>ViewName</i> as ...
</pre>
<p>
Note that this approach would cause problems in PostgreSQL, which records
which views depend on which other views.
Inevitably, you would try to drop a view defined early in the SQL file
that is used by view later in the file.
In PostgreSQL, you can add the keyword <tt>cascade</tt> to ensure that
you not only drop the view you asked to drop, but also all the views that
make use of it.
SQLite doesn't do this dependency checking, and will allow you to drop
a view, even if other views use it. You won't notice until you try to use
one of the remaining views and will then be told that the view you dropped
is undefined. If you redefine the view straight away (as in the above),
then the dependency problem never arises.
</p>
<p>
If you're a <tt>vim</tt> user, the following command will convert all of
the current <tt>create view</tt> statements into an appropriate form.
If you're not a <tt>vim</tt> user, read and weep ... or post the equivalent
for your editor of choice.
</p>
<pre>:s/^create or replace view \([^ ]*\)/drop view if exists \1;<span style="color:#0000DD">^M</span>create view \1/
</pre>
<p>
Note: the <span style="color:#0000DD"><tt>^M</tt></span> is achieved
by typing the two-character sequence control-V control-M.
Also, if you attempt this in <tt>vim</tt> and mess it up, you can undo the
effects simply by typing the character <tt>u</tt>.
</p>
<p>
To avoid the fact that SQLite doesn't support view definitions of the form:
</p>
<pre>create view <i>ViewName</i>(<i>attr<sub>1</sub></i>, <i>attr<sub>2</sub></i>, ...)
as
select <i>expr<sub>1</sub></i>, <i>expr<sub>2</sub></i>, ...
</pre>
<p>
simply use the equivalent form:
</p>
<pre>create view <i>ViewName</i>
as
select <i>expr<sub>1</sub></i> as <i>attr<sub>1</sub></i>, <i>expr<sub>2</sub></i> as <i>attr<sub>2</sub></i>, ...
</pre>
<p>
Once you've made the above changes, many of the views will work
correctly in both PostgreSQL and SQLite.
</p>
<p>
One "problem" is that SQLite doesn't have quite the same formatting
options for result values.
PostgreSQL allows you to cast to a <tt>numeric</tt> value to control
the number of decimal places in real number values; unfrotunately,
SQLite doesn't quite allow the same. Don't worry if your real results
don't look the same in SQLite.
</p>
You should attempt the above exercises before looking at the
<a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/04b/soln2.sql">SQLite sample solutions</a>.
<p></p>


</body></html>