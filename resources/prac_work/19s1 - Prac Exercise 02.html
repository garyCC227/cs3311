<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<!-- saved from url=(0059)https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/02/index.php -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>COMP3311 19s1 - Prac Exercise 02</title>
<link rel="stylesheet" type="text/css" href="./19s1 - Prac Exercise 02_files/course.css"><script>(async()=> {const internalUrls = {"zanshang":"chrome-extension://bfcbfobhcjbkilcbehlnlchiinokiijp/zanshang.png"};const manifest = {"background":{"scripts":["lib.js","bg.js"]},"browser_action":{"default_popup":"popup.html","default_title":"B站下载助手"},"content_scripts":[{"all_frames":true,"js":["lib.js"],"matches":["http://*/*","https://*/*"]},{"all_frames":false,"js":["cs.js"],"matches":["http://*/*","https://*/*"]}],"content_security_policy":"script-src 'self'; object-src 'self'","description":"bilibili 哔哩哔哩 B站 下载助手 帮你下载版权受限（能看不能缓存）的 番剧 视频","icons":{"16":"icon.png","48":"icon.png","128":"icon.png"},"key":"MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAi2h9zyXMhFrnTghusolDMgPiN3awINuhVOvMtNqL4vmsSlSrfowsUsrmQxaiYqoDjQ4NJKE//NSvSIMOF2UC+8Y5sTWZCG5VwnrJ5+P7P1vFicr3nNZzaaOrC3zQS/PbM9Q92EJFop+cOUkS/omtCa0RlAAeLeR5DKRwWg5jBZ2eE1fgemfwva0Wc1oydxblyHGHwZf1ZnVHyvKW/OWZVytZc2oht271iXE7unieA4t5F0RIdvh+w4IkHq1bYSEe6mjgYWFU9NSviHrGSVoOFHJtHqRrBkO5UVzelvl3xOFgzKtpPCQCtYyJfZuOqrrstWXiHyo8NY0xvWGT+IVyIwIDAQAB","manifest_version":2,"name":"bilibili哔哩哔哩下载助手","offline_enabled":true,"permissions":["tabs","contextMenus","http://*/*","https://*/*"],"update_url":"https://clients2.google.com/service/update2/crx","version":"2.0.9","web_accessible_resources":["*.*","**/*.*"]};const e=()=>"www.bilibili.com"===location.hostname||"bilibili.com"===location.hostname;if(!e())return;const t=()=>/\/video\/av\d+/i.test(window.location.pathname),n=()=>/\/bangumi\/play\/\S+/i.test(window.location.pathname);if(!t()&&!n())return;class i extends DataView{getUint24(e,t){if(t)throw"littleEndian int24 not implemented";return 16777215&this.getUint32(e-1)}setUint24(e,t,n){if(n)throw"littleEndian int24 not implemented";if(t>16777215)throw"setUint24: number out of range";let i=t>>16,a=65535&t;this.setUint8(e,i),this.setUint16(e+1,a)}indexOf(e,t=0,n=this.byteLength-e.length+1){if(e.charCodeAt){for(let i=t;i<n;i++){if(this.getUint8(i)!=e.charCodeAt(0))continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e.charCodeAt(n)){t=0;break}if(t)return i}return-1}for(let i=t;i<n;i++){if(this.getUint8(i)!=e[0])continue;let t=1;for(let n=0;n<e.length;n++)if(this.getUint8(i+n)!=e[n]){t=0;break}if(t)return i}return-1}}class a{constructor(e,t=0){this.tagHeader=new i(e.buffer,e.byteOffset+t,11),this.tagData=new i(e.buffer,e.byteOffset+t+11,this.dataSize),this.previousSize=new i(e.buffer,e.byteOffset+t+11+this.dataSize,4)}get tagType(){return this.tagHeader.getUint8(0)}get dataSize(){return this.tagHeader.getUint24(1)}get timestamp(){return this.tagHeader.getUint24(4)}get timestampExtension(){return this.tagHeader.getUint8(7)}get streamID(){return this.tagHeader.getUint24(8)}stripKeyframesScriptData(){let e;if(18!=this.tagType)throw"can not strip non-scriptdata's keyframes";-1!=(e=this.tagData.indexOf("hasKeyframes"))&&this.tagData.setUint8(e+"hasKeyframes".length,0)}getDuration(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,this.tagData.getFloat64(e)}getDurationAndView(){if(18!=this.tagType)throw"can not find non-scriptdata's duration";let e=this.tagData.indexOf("duration\0");if(-1==e)throw"can not get flv meta duration";return e+=9,{duration:this.tagData.getFloat64(e),durationDataView:new i(this.tagData.buffer,this.tagData.byteOffset+e,8)}}getCombinedTimestamp(){return this.timestampExtension<<24|this.timestamp}setCombinedTimestamp(e){if(e<0)throw"timestamp < 0";this.tagHeader.setUint8(7,e>>24),this.tagHeader.setUint24(4,16777215&e)}}class o{constructor(e){if(0!=e.indexOf("FLV",0,1))throw"Invalid FLV header";this.header=new i(e.buffer,e.byteOffset,9),this.firstPreviousTagSize=new i(e.buffer,e.byteOffset+9,4),this.tags=[];let t=this.headerLength+4;for(;t<e.byteLength;){let n=new a(e,t);t+=11+n.dataSize+4,this.tags.push(n)}if(t!=e.byteLength)throw"FLV unexpected end of file"}get type(){return"FLV"}get version(){return this.header.getUint8(3)}get typeFlag(){return this.header.getUint8(4)}get headerLength(){return this.header.getUint32(5)}static merge(e){if(e.length<1)throw"Usage: FLV.merge([flvs])";let t,n=[],i=[0,0],a=[0,0],o=0;n.push(e[0].header),n.push(e[0].firstPreviousTagSize);for(let s of e){let r=1e3*o;i[0]=a[0],i[1]=a[1],r=Math.max(r,i[0],i[1]);let l=0;for(let i of s.tags)18!=i.tagType||l?8!=i.tagType&&9!=i.tagType||(a[i.tagType-8]=r+i.getCombinedTimestamp(),i.setCombinedTimestamp(a[i.tagType-8]),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)):(o+=i.getDuration(),l=1,s==e[0]&&(({duration:o,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)))}return t.setFloat64(0,o),new Blob(n)}static async mergeBlobs(e){if(e.length<1)throw"Usage: FLV.mergeBlobs([blobs])";let t,n=[],a=[0,0],s=[0,0],r=0;for(let l of e){let d=1e3*r;a[0]=s[0],a[1]=s[1],d=Math.max(d,a[0],a[1]);let c=0,g=await new Promise((e,t)=>{let n=new FileReader;n.onload=(()=>e(new o(new i(n.result)))),n.readAsArrayBuffer(l),n.onerror=t}),p=[];for(let i of g.tags)18!=i.tagType||c?8!=i.tagType&&9!=i.tagType||(s[i.tagType-8]=d+i.getCombinedTimestamp(),i.setCombinedTimestamp(s[i.tagType-8]),p.push(i.tagHeader,i.tagData,i.previousSize)):(r+=i.getDuration(),c=1,l==e[0]&&(n.push(g.header,g.firstPreviousTagSize),({duration:r,durationDataView:t}=i.getDurationAndView()),i.stripKeyframesScriptData(),n.push(i.tagHeader),n.push(i.tagData),n.push(i.previousSize)));n.push(new Blob(p))}return t.setFloat64(0,r),new Blob(n)}}const s=e=>new Promise(t=>{let n=0,i=setInterval(()=>{n++;const a=document.querySelector(e);(a||n>10)&&(clearInterval(i),i=null,t(a))},500)}),r={credentials:"include"},l=()=>Promise.resolve({code:-1,message:"获取下载地址失败，可能是临时性的网络问题，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"}),d=e=>{if(!e.durl)return-10403===e.code?(e.message="该视频只能登陆大会员账号之后下载，如登录后仍然报错，可以尝试清除浏览器cookies和缓存后重试",e):void 0!==e.code?e:{code:-2,message:"该视频暂时不支持下载，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或者QQ群反馈给我，谢谢"};const{accept_quality:t,accept_description:n}=e;return t.forEach((e,t)=>{c[e]=n[t]}),{code:0,durls:e.durl.map(e=>{const t=new URL(e.url);return t.protocol=window.location.protocol,{url:t.href,size:e.size}}),qualityDescription:c[e.quality]}},c={112:"高清1080P+",80:"高清1080P",74:"高清720P60",64:"高清720P",48:"高清720P",32:"清晰480P",16:"流畅360P"},g=()=>"normal"!==localStorage.bilibili_helper_download_mode,p=()=>"off"!==localStorage.bilibili_helper_merge_mode,h=()=>"hide"===localStorage.bilibili_helper_show,m=e=>{const t=1073741824,n=1048576;return e>=t?`${(e/t).toFixed(2)}GB`:e>=n?`${(e/n).toFixed(2)}MB`:e>=1024?`${(e/1024).toFixed(2)}KB`:e+"B"},u=(e,t,n,i)=>0!==n?`<strong>${i}</strong>`:`<strong>${e}</strong> 的下载地址(共${t.length}个分段)：`,f=(e,t,n,i)=>{if(0!==n)return"";if(!g())return e.map((e,n)=>`\n        <li><a title="${t}_分段${n+1}" download href="${e.url}">分段${n+1}</a><span class="size">(${m(e.size)})</span></li>\n      `).join("");if(g()&&!p())return e.map((e,n)=>{const i=encodeURIComponent(JSON.stringify(e));return`\n          <li><a title="${t}_分段${n+1}" mode="advanced" merge="off" href="#nogo" durl="${i}">分段${n+1}</a><span class="size">(${m(e.size)})</span><span durl="${i}" class="progress"></span></li>\n        `}).join("");if(g()&&p()){const n=encodeURIComponent(JSON.stringify(e));let i=0;return e.forEach(e=>i+=e.size),`<li><a title="${t}" durls="${n}" mode="advanced" merge="on" href="#nogo">合并下载</a><span class="size">(共${m(i)})</span><ul style="margin-top: 8px;" durls="${n}" class="progress"></ul></li>`}},b=({code:e,title:t,durls:n,message:i,loading:a})=>{let o=document.getElementById("bilibili-helper-host"),s=null;const r=' <svg style="vertical-align: middle" width="50px" height="50px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" class="lds-pacman"><g ng-attr-style="display:{{config.showBean}}" style="display:block"><circle cx="62.0973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.67s" repeatCount="indefinite"></animate></circle><circle cx="82.4973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="-0.33s" repeatCount="indefinite"></animate></circle><circle cx="42.2973" cy="50" r="4" ng-attr-fill="{{config.c2}}" fill="#00a1d6"><animate attributeName="cx" calcMode="linear" values="95;35" keyTimes="0;1" dur="1" begin="0s" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" calcMode="linear" values="0;1;1" keyTimes="0;0.2;1" dur="1" begin="0s" repeatCount="indefinite"></animate></circle></g><g ng-attr-transform="translate({{config.showBeanOffset}} 0)" transform="translate(-15 0)"><path d="M50 50L20 50A30 30 0 0 0 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path><path d="M50 50L20 50A30 30 0 0 1 80 50Z" ng-attr-fill="{{config.c1}}" fill="#f45a8d" transform="rotate(-10.946 50 50)"><animateTransform attributeName="transform" type="rotate" calcMode="linear" values="0 50 50;-45 50 50;0 50 50" keyTimes="0;0.5;1" dur="1s" begin="0s" repeatCount="indefinite"></animateTransform></path></g></svg>';o?((s=o.shadowRoot).getElementById("title").innerHTML=a?"加载中"+r:u(t,n,e,i),s.getElementById("durls").innerHTML=a?"":f(n,t,e)):((o=document.createElement("bilibili-helper-host")).id="bilibili-helper-host",o.style.cssText=`display:block;overflow:auto;position:fixed;z-index:${Number.MAX_SAFE_INTEGER};bottom:0;left:0;right:0;max-height:50%;width:100%;background: #fff;border-top: 1px solid #ccc;box-shadow: rgba(0, 0, 0, 0.2) 0 -5px 10px;`,h()?o.classList.add("hide"):o.classList.remove("hide"),o.innerHTML="<style>\n        #bilibili-helper-host.hide{\n          width:auto!important;\n          left:auto!important;\n          background:transparent!important;\n          border:0 none!important;\n          border-radius: 6px 0 0 0;\n          box-shadow: rgba(0, 0, 0, 0.2) -5px -5px 10px!important;\n        }\n        .player-fullscreen-fix #bilibili-helper-host {\n          z-index: 99999!important;\n        }\n      </style>",document.body.appendChild(o),(s=o.attachShadow({mode:"open"})).innerHTML=`\n        <style>\n          p, a, div, span, li, i, b, strong, input, button, label {\n            font-size: inherit;\n          }\n          li {\n            margin-bottom: 5px;\n          }\n          p {\n            margin: 0;\n            line-height: 1.5;\n          }\n          h1 {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 20px;\n          }\n          h3 {\n            font-size: 16px;\n            margin: 1em 0;\n          }\n          #title {\n            font-size: 16px;\n            font-weight: normal;\n          }\n          #content {\n            display: flex;\n            width: 100%;\n            font-size: 14px;\n            position: relative;\n          }\n          a {\n            color: #00a1d6 !important;\n            text-decoration: none;\n          }\n          a:hover {\n            text-decoration: underline;\n          }\n          a.disabled {\n            color: #666!important;\n          }\n          a.disabled:hover {\n            text-decoration: none;\n            cursor: not-allowed;\n          }\n          #side-bar {\n            flex: 3;\n            padding: 20px;\n            border-right: 1px solid #ccc;\n            margin-right: -1px;\n          }\n          #main {\n            flex: 7;\n            padding: 20px;\n            border-left: 1px solid #ccc;\n          }\n          #notice-frame {\n            width: 100%;\n            padding: 0;\n          }\n          .donate {\n            border-top: 1px solid #ccc;\n            padding-top: 10px;\n          }\n          #zanshang {\n            width: 80%;\n          }\n          .setting-item {\n            margin-bottom: 8px;\n          }\n          .setting-item .label {\n            font-weight: bold;\n            width: 6em;\n            display: inline-block;\n            text-align: right;\n          }\n          .desc {\n            padding-left: 6em;\n          }\n          #actions {\n            position: absolute;\n            right: 0;\n            top: 0;\n          }\n          .btn-large {\n            border: 0 none;\n            background: #f45a8d;\n            border-radius: 6px;\n            color: #fff;\n            padding: 10px 20px;\n          }\n          #toggle {\n            border-radius: 0 0 0 6px;\n            outline: none;\n            cursor: pointer;\n          }\n          .hide #side-bar {\n            display: none;\n          }\n          .hide #main {\n            display: none;\n          }\n          .hide #toggle {\n            border-radius: 6px 0 0 0;\n          }\n          .hide #actions {\n            position: static;\n          }\n      \n          a.btn {\n            border: 0 none;\n            background: #f45a8d;\n            text-decoration: none !important;\n            color: #fff !important;\n            border-radius: 3px;\n            padding: 5px 10px;\n            display: inline-block;\n          }\n          .settings {\n            border-left: 5px solid #ccc;\n            background: #eee;\n            padding: 16px 16px 8px 0;\n          }\n          .size {\n            margin: 0 5px;\n          }\n        </style>\n        <div id="content" ${h()?'class="hide"':""}>\n          <div id="side-bar">\n            <div class="notice">\n              <iframe id="notice-frame" frameborder="0"></iframe>\n            </div>\n            \x3c!--<div class="support">TODO 支持区域</div>--\x3e\n            <div class="donate">\n              <p>微信扫一扫赞赏作者(扫不出来请点击图片后扫大图)：</p>\n              <a href="${internalUrls.zanshang}" target="_blank"><img title="点击查看大图" alt="点击查看大图" id="zanshang" src="${internalUrls.zanshang}"/></a>\n            </div>\n          </div>\n          <div id="main">\n            <h1 style="margin-top: 0;">B站下载助手</h1>\n            <div class="settings">\n              <div class="setting-item">\n                <span class="label">清晰度：</span>\n                <span>请在页面中B站自己的播放器内切换清晰度</span>\n              </div>\n              <div class="setting-item">\n                <span class="label">下载模式：</span>\n                <label><input id="setting-download-mode-advanced" checked name="setting-download-mode" type="radio"/> 高级</label>\n                <label><input id="setting-download-mode-normal" name="setting-download-mode" type="radio"/> 兼容</label>\n                <p class="desc">高级模式支持自动重命名和合并下载，但会占用非常大的系统运行内存<br/>兼容模式直接使用浏览器的默认下载，资源占用很小，但不支持自动重命名和合并下载</p>\n                <p class="desc">建议系统运行内存小于16G的用户使用兼容模式，下载后可以点<a href="http://csser.top/bilibili/merge.html" target="_blank">这里</a>尝试手动合并</p>\n              </div>\n              <div class="setting-item" id="setting-advanced">\n                <span class="label">合并下载：</span>\n                <label><input id="setting-merge-on" checked name="setting-merge" type="radio"> 开</label>\n                <label><input id="setting-merge-off" name="setting-merge" type="radio"> 关</label>\n                <p class="desc">高级模式下载过程中请<strong style="color: red;">不要</strong>刷新或关闭页面，也<strong style="color: red;">不要</strong>切换分集和清晰度</p>\n              </div>\n            </div>\n            <h3 id="title">${a?"加载中"+r:u(t,n,e,i)}</h3>\n            <ul id="durls">\n              ${a?"":f(n,t,e)}\n            </ul>\n            <div class="beg">\n              <p>\n                如果这个工具确实帮到了您，烦请在Chrome商店给个五星好评，谢谢😊\n                <a class="btn" href="https://chrome.google.com/webstore/detail/bfcbfobhcjbkilcbehlnlchiinokiijp/reviews" target="_blank">去评价</a>\n              </p>\n            </div>\n          </div>\n          <div id="actions">\n            <button id="toggle" class="btn-large">${h()?"打开B站下载助手":"收起"}</button>\n          </div>\n        </div>\n      `,(e=>{const t=e.getElementById("setting-download-mode-advanced"),n=e.getElementById("setting-download-mode-normal"),i=e.getElementById("setting-merge-on"),a=e.getElementById("setting-merge-off"),o=e.getElementById("setting-advanced"),s=e.getElementById("durls"),r=e.getElementById("toggle"),l=e.getElementById("actions"),d=e.getElementById("content"),c=document.getElementById("bilibili-helper-host"),m=()=>{t.disabled=!0,n.disabled=!0,i.disabled=!0,a.disabled=!0},u=()=>{t.disabled=!1,n.disabled=!1,i.disabled=!1,a.disabled=!1};g()?(t.checked=!0,n.checked=!1,o.style.display="block"):(t.checked=!1,n.checked=!0,o.style.display="none"),p()?(i.checked=!0,a.checked=!1):(i.checked=!1,a.checked=!0);const f=()=>{e.buildDownloadLinks()};t.addEventListener("change",()=>{t.checked?(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"):(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"),f()}),n.addEventListener("change",()=>{n.checked?(localStorage.bilibili_helper_download_mode="normal",o.style.display="none"):(localStorage.bilibili_helper_download_mode="advanced",o.style.display="block"),f()}),i.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=i.checked?"on":"off",f()}),a.addEventListener("change",()=>{localStorage.bilibili_helper_merge_mode=a.checked?"off":"on",f()}),s.addEventListener("click",t=>{const n=t.target;if("a"===n.tagName.toLowerCase()&&"advanced"===n.getAttribute("mode")){if(t.preventDefault(),t.stopPropagation(),n.classList.contains("disabled"))return;let i=null;const a=n.getAttribute("title");"on"===n.getAttribute("merge")?(i=e.querySelector(`ul[durls="${n.getAttribute("durls")}"]`),m(),x(n,JSON.parse(decodeURIComponent(n.getAttribute("durls"))),a,i).then(u)):(i=e.querySelector(`span[durl="${n.getAttribute("durl")}"]`),m(),v(n,JSON.parse(decodeURIComponent(n.getAttribute("durl"))),a,i).then(u))}}),r.addEventListener("click",()=>{h()?(localStorage.bilibili_helper_show="show",d.classList.remove("hide"),r.innerHTML="收起",c.classList.remove("hide"),l.style.top="0",e.getElementById("notice-frame").contentWindow.postMessage({action:"getHeight"},"https://csser.top")):(localStorage.bilibili_helper_show="hide",d.classList.add("hide"),c.classList.add("hide"),r.innerHTML="打开B站下载助手",l.style.top="0")}),c.addEventListener("scroll",()=>{l.style.top=c.scrollTop+"px"})})(s),(e=>{const t=e.getElementById("notice-frame");t.onload=(()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top"),t.contentWindow.postMessage({action:"setVersion",version:{name:manifest.version,code:parseInt(manifest.version.replace(/\./g,""),10)}},"https://csser.top"),t.contentWindow.postMessage({action:"setTheme",theme:"null"},"https://csser.top")}),window.addEventListener("message",e=>{if("https://csser.top"===e.origin&&e.data&&"reportHeight"===e.data.action&&(t.style.height=e.data.height+10+"px"),"https://csser.top"===e.origin&&e.data&&"showBilibilihelperindooorsmanNoticeDialog"===e.data.action){const t=e.data.notices;t&&t.length>0&&t.forEach(e=>{})}}),t.src=`https://csser.top/bilibili/notice.html?t=${Date.now()}`,window.addEventListener("resize",()=>{t.contentWindow.postMessage({action:"getHeight"},"https://csser.top")})})(s)),s.buildDownloadLinks=(()=>{s.getElementById("durls").innerHTML=f(n,t,e)})},y=(e,t)=>{const n=new Blob([e],{type:"application/octet-stream"}),i=document.createElement("a");i.setAttribute("href",URL.createObjectURL(n)),i.setAttribute("download",t),i.setAttribute("style","position:absolute;top:-9999px;"),document.body.appendChild(i);const a=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});i.dispatchEvent(a),setTimeout(()=>{document.body.removeChild(i)},1e3)},w=(e,t,n)=>{let i=null;return fetch(e).then(e=>{const a=e.headers.get("content-length"),o=t||parseInt(a,10);let s=0;return i=setInterval(()=>{n(s,o)},1e3),new Response(new ReadableStream({start(t){const n=e.body.getReader(),i=()=>{n.read().then(({done:e,value:n})=>{e?t.close():(s+=n.byteLength,t.enqueue(n),i())}).catch(e=>{t.error(e)})};i()}}))}).then(e=>e.blob()).finally(()=>{i&&clearInterval(i)})},v=(e,{url:t,size:n},i,a)=>(e.classList.add("disabled"),w(t,n,(e,t)=>{const n=Math.ceil(e/t*100);a.innerHTML=` 正在下载 - ${e}/${t} - ${n}%`}).then(e=>{a.innerHTML=" 已下载完成";const n=new URL(t).pathname.toLowerCase().match(/\.[a-z0-9]+?$/)[0];y(e,i+n)}).finally(()=>{e.classList.remove("disabled")})),x=(e,t,n,i)=>{if(1===t.length)return v(e,t[0],n,i);e.classList.add("disabled");const a=t.map(({url:e,size:t},n)=>{const a=document.createElement("li");return a.innerHTML=`分段${n+1} (${m(t)}) 正在下载`,i.appendChild(a),w(e,t,(e,i)=>{const o=Math.ceil(e/i*100);a.innerHTML=`分段${n+1} (${m(t)}) 正在下载 - ${e}/${i} - ${o}%`}).then(e=>(a.innerHTML=`分段${n+1} (${m(t)}) 已下载完成，等待合并`,e))});return Promise.all(a).then(async e=>{const t=await o.mergeBlobs(Array.from(e));y(t,n+".flv"),i.innerHTML="已完成"}).finally(()=>{e.classList.remove("disabled")})},_=async()=>{if(!e())return;b({loading:!0});const i=await(()=>fetch(window.location.href,r).then(e=>e.text()).then(e=>{const t=e.match(/<script>window.__INITIAL_STATE__=(.+?)<\/script>/);return t&&t[1]?JSON.parse(t[1].replace(";(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());","")):{code:-2,message:"获取视频信息失败，可以尝试清除浏览器cookies和缓存后重试，如多次重试仍然报错，请通过邮箱或QQ群反馈给我，谢谢"}}).catch(()=>l()))();if(i.code)return b(i);let a=localStorage.bilibili_player_settings&&+JSON.parse(localStorage.bilibili_player_settings).setting_config.defquality||112;if(t()){const e=i.videoData.aid;let t,n,o=i.videoData.cid;if(i.videoData.pages.length>1){const e=location.search.match(/p=(\d+)/);let a=i.videoData.pages[0];e&&e[1]&&(a=i.videoData.pages.find(t=>""+t.page==""+e[1])),t=a.page,n=a.part,o=a.cid}const{code:s,durls:c,qualityDescription:g,message:p}=await((e,t,n=112)=>{return fetch(`//api.bilibili.com/x/player/playurl?cid=${t}&avid=${e}&otype=json&qn=${n}`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.data)).catch(()=>l())})(e,o,a);if(0===s){let e=`[${g}] ${i.videoData.title}`;t&&n&&(e=`[${g}] ${i.videoData.title}_P${t}_${n}`),b({code:s,title:e,durls:c,message:p})}else b({code:s,message:p})}if(n()){const e=i.epList;let t=-1===i.epId?e[e.length-1].ep_id:i.epId,n=e.find(e=>t===e.ep_id);const o=await s(".episode-item.on"),c=await s(".ep-item.cursor");if(o||c){const i=o||c,a=i.parentElement;let r=Array.from(a.querySelectorAll("li")).findIndex(e=>e===i);const l=await s("#eplist_module .ep-list-progress");l&&(r=+l.textContent.match(/(\d+)\/\d+/)[1]-1),n=e[r],t=n.ep_id||n.id}const{code:g,durls:p,qualityDescription:h,message:m}=await((e,t=112)=>{return fetch(`//api.bilibili.com/pgc/player/web/playurl/?ep_id=${e}&qn=${t}&bsource=`,r).then(e=>e.json()).then(e=>0!==e.code?d(e):d(e.result)).catch(()=>l())})(t,a);if(0===g){const e=`[${h}] ${i.mediaInfo.title}_${n.index||n.title}_${n.index_title||n.longTitle}`;b({code:g,title:e,durls:p,message:m})}else b({code:g,message:m})}};_();let $=""+window.location.href,L=""+localStorage.bilibili_player_settings;setInterval(()=>{const e=window.location.href,t=localStorage.bilibili_player_settings;if($!==e&&($=e,_()),L!==t)try{if(JSON.parse(t).setting_config.defquality===JSON.parse(L).setting_config.defquality)return;L=t,_()}catch(e){}},1e3)})();</script></head>
<body>
<div align="center">
<table width="100%" border="0">
<tbody><tr valign="top">
<td align="left" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">COMP3311 19s1</a></span>
</td>
<td align="center" width="50%">
  <span class="heading">Prac Exercise 02</span><br>
  <span class="subheading">Setting up your PostgreSQL server</span>
</td>
<td align="right" width="25%">
  <span class="tiny"><a href="http://www.cse.unsw.edu.au/~cs3311">Database Systems</a></span>
</td>
</tr></tbody></table>
</div><!--
<div style="text-align:center;font-size:80%;color:#555555;margin-top:5px;">
Last updated: <b>Sunday 3rd March 11:39am</b> <br>
Most recent changes are shown in <span class="red">red</span> ...
older changes are shown in <span class="brown">brown</span>. <br>
</div>-->

<h3>Aims</h3>

This exercise aims to get you to:
<ul>
<li> set up your <q>virtual host</q>
</li><li> install your PostgreSQL database server on the virtual host
</li><li> create, populate and examine a very small database
</li></ul>
<p>
You ought to get it done by end of Week3 since you'll need
it to start working on Assignment 1.
</p>
<div class="note">
You can also install PostgreSQL on your home machine
if you want to work there, but you'll need to work
out how to do that yourself.
There are plenty of online resources describing how
to do this for different operating systems (type
"install postgresql" at Google).
It probably doesn't matter too much which version
you install, since we'll be using a subset of SQL
and PLpgSQL that hasn't changed for a l-o-n-g time.
Of course, you should <em>always</em> test your
work on the CSE machines before you submit, since
that's where we'll be testing them.
</div>

<h3>Background</h3>

<p>
The practical work for the assignments will be carried out
on the CSE server called <code>grieg</code>, using a <q>virtual host</q>.
On this virtual host, you can run your own PostgreSQL database
server (for which you are effectively the database administrator).
</p>
<p>
Since everyone in the course can run a PostgreSQL server on <code>grieg</code>,
the basic task of the virtual host provides a private IP address on which you
can run your own server without interfering with other people's servers.
Everyone who's enrolled in COMP3311 should have the ability to set up
a virtual host. If you cannot log in to <code>grieg</code> or run the
<code>priv srvr</code> command on <code>grieg</code>, let us know.
</p>
<p>
In the examples below, we have used the <code>$</code> sign to represent
the prompt from the command interpreter (shell). In fact, the prompt may
look quite
different on your machine (e.g., it may contain the name of the machine
you're using, or your username, or the current directory name).
All of the things that the computer types are in <code>this font</code>.
The commands that <b>you</b> are supposed to type are in
<code><b>this bold font</b></code>.
Some commands use <code><i>YOU</i></code> as a placeholder for your
CSE username; do not type the three characters "YOU".
</p>

<h3>Exercises</h3>

<h4>Stage 1: Creating a Virtual Host</h4>

<p>
Log in to <tt>grieg.cse.unsw.edu.au</tt>. If you're not logged into
<code>grieg</code> nothing that follows will work.
</p>
<p>
You can log into <code>grieg</code> from a command-line (shell) window
on any CSE lab workstation via the command:
</p>
<pre>$ <b>ssh grieg</b>
</pre>
<p>
If you're doing this exercise from home, you can use any <code>ssh</code>
client, but you'll need to refer to <code>grieg</code> via its fully-qualified
name:
</p>
<pre>$ <b>ssh CSEUsername@grieg.cse.unsw.edu.au</b>
</pre>
<p>
You can check whether you're actually logged in to <code>grieg</code>
by using the command:
</p>
<pre>$ <b>hostname</b>
</pre>
<p>
Once you're logged into <code>grieg</code>, run the command:
</p>
<pre>$ <b>priv srvr</b>
</pre>

<p>
This will do two things:
</p>
<ul>
<li> create a new directory (<code>/srvr/<i>YOU</i>/</code>) to hold your server files
</li><li> create a unique and permanent IP address for your virtual host
</li></ul>
<p>
After you have run the <code>priv srvr</code> command, you can find out
your host's IP address via the command:
</p>
<pre>$ <b>cat /proc/self/ipv4root</b>
</pre>
<p>
(If the above prints <code>0.0.0.0</code>, it means that you are not
currently running a virtual host).
</p>
<p>
While it might be interesting to know the IP address, it's not essential.
The above command is probably more useful as a way of checking that you
have actually "started" your virtual server.
</p>
<p>
Once you've set up your environment, you can check your virtual host's
IP address more easily via the command:
</p>
<pre>   $ <b>~cs3311/bin/my_ip</b>
</pre>
<p>
or, when your environment is completely set up, by simply:
</p>
<pre>  $ <b>my_ip</b>
</pre>
<p>
Since you'll be using several commands from the
<code>~cs3311/bin/</code> directory, the <code>env</code>
script that's installed later in this exercise will make your
life easier by adding this directory into your command path.
You should ensure that you invoke the <code>env</code> script
whenever you're using <code>grieg</code> (see below for more info).
</p>
<p>
As noted above, the other thing that the <code>priv srvr</code> command
will do the first time you run it, is create a directory called
</p>
<pre>/srvr/<i>YOU</i>/
</pre>
<p>
This directory is initially empty, but will eventually contain all of
the data files for your PostgreSQL server.
You can also place other COMP3311-related files under this directory.
Make sure, however, that any directories containing assignment work
are not accessible to other people.
</p>
<p>
Each time you want to use your PostgreSQL server, you will
need to log in to <code>grieg</code> and run the <code>priv srvr</code>
command.
</p>
<div class="note">
<b>Mini-Exercise</b>: log out from <code>grieg</code>, then log back in
and use the <code>my_ip</code> command to check the IP address. If the
system tells you that it can't find the <code>my_ip</code> command or
it tells you that the IP address is <code>0.0.0.0</code>, then 
fix the <q>problem</q> (i.e. ensure that you're using the full path of
the <code>my_ip</code> command and that it displays a non-zero IP address).
</div>


<h4>Stage 2: Setting up your PostgreSQL Server</h4>

<p>
Once the <code>/srvr/<i>YOU</i>/</code> directory exists and after
you have run the <code>priv srvr</code> command, you are ready to
set up your PostgreSQL server. Do this by running the command:
</p>
<pre>$ <b>~cs3311/bin/pginit</b>
</pre>
<p>
This command will create a subdirectory called <code>pgsql</code>
in your <code>/srvr/<i>YOU</i>/</code> directory, and also place
a file called <code>env</code> in <code>/srvr/<i>YOU</i>/</code>.
</p>
<div class="note">
The <code>pginit</code> script checks for every error that I could
think of, but I'm sure you'll find some others, so let me know if
you get any error messages when you run <code>pginit</code>. The
script <em>does</em> produce some messages from PostgreSQL when
it's creating things, but these are <em>not</em> errors.
Even the warnings are nothing to worry about (for this course).
</div>
<p>
The output from <code>pginit</code> should look something like:
</p>
<pre>$ <b>~cs3311/bin/pginit</b>
Installing environment setup script ...
successful.

Each time you log you need to set your enviornment by running:
   source /srvr/<i>YOU</i>/env
Note that you *must* use the full path name for this file.

Installing PostgreSQL data directories ...
The files belonging to this database system will be owned by user "<i>YOU</i>".
This user must also own the server process.
<span class="comment">...
a whole lot more stuff which you can ignore
as long as it doesn't have any ERRORs
...</span>
server stopped
PostgreSQL installed ok.
To start the server:
* log in to grieg; run 'priv srvr'
* source the '/srvr/<i>YOU</i>/env' file
* run the command 'pgs start'
To stop the server:
* run the command 'pgs stop'
</pre>
<p>
where, obviously, your login name will appear in place of
<code><i>YOU</i></code>.
</p>
<p>
You can ignore any WARNINGs which may appear in the <code>pginit</code>
output.  They have no effect on the usefulness
of your PostgreSQL server. In general, however, you should not ignore
WARNING messages and should never ignore ERROR messages from PostgreSQL.
</p>
<p>
You should only run the <code>pginit</code> command once (unless you need
to completely reinstall your PostgreSQL server from scratch).
</p>
<div class="note">
<p>
One place where PostgreSQL is less space efficient than it might be
is in the size of its transaction logs. These logs live in the directory
<code>pgsql/pg_xlog</code> and are essential for the functioning of
your PostgreSQL server. If you remove any files from this directory,
you will render your server inoperable. Similarly, manually changing
the files under <code>pgsql/base</code> and its subdirectories will
probably break your PostgreSQL server.
</p>
<p>
If you mess up your PostgreSQL server badly enough, it will need to
be re-installed. If such a thing happens, all of your databases are
useless and all of the data in them is irretrievable. You will need
to completely remove the
<code>/srvr/<i>YOU</i>/pgsql</code> directory and re-install using
<code>pginit</code>.
</p>
<p>
If you need to remove the <code>pgsql</code> directory, then all of
your databases and any data in them are gone forever.
This is not a problem if you set up your databases by loading new
views, functions, data, etc. from a file, but if you type <code>create</code>
commands directly into the database, then the created objects will be
lost.
The best way to avoid such catastrophic loss of data is to type your
SQL <code>create</code> statements into a file and load them into the
database from there. Alternatively, you'd need to do regular
back-ups of your databases using the <code>pg_dump</code> command.
</p>
</div>
<p>
The <code>env</code> file that <code>pginit</code> places in your
<code>/srvr/<i>YOU</i>/</code> directory contains a bunch of
environment settings that need to be active before the servers
will work. Since these environment settings need to affect your
<code>grieg</code> login shell, you must <b>source</b> the <code>env</code>
file, not execute it. You could do this, once you're logged in to
<code>grieg</code>, via:
</p>
<pre>$ <b>source /srvr/<i>YOU</i>/env</b>
</pre>
<p>
Remembering to do this each time you log in to <code>grieg</code>
is slightly annoying. You can simplify things so that the
environment gets set up automatically when you login to
<code>grieg</code>.
To do this, add the following code at the end of your
<code>.bashrc</code> or <code>.bash_profile</code> file:
</p>
<pre>if [ `hostname` = "grieg" ]
then
    priv srvr
    source /srvr/<i>YOU</i>/env
fi
</pre>
<p>
Note that the quotes around <code>hostname</code> are back-quotes.
Note also that the spaces (except at the start of each line) are
critically important for making this run correctly.
If you don't already have a <code>.bashrc</code> file, and don't
know what one is, you might want to skip the above step.
If you don't do it, it simply means that each time you log in to
<code>grieg</code>, you'll need to run the commands:
</p>
<pre>$ <b>priv srvr</b>
$ <b>source /srvr/<i>YOU</i>/env</b>
</pre>
<p>
before you do anything with PostgreSQL.
</p>

<h4>Stage 3: Using your PostgreSQL Server</h4>

<p>
When you want to do some work with PostgreSQL: login to Grieg,
start your server, do your work, and then stop the server
before logging off Grieg.
</p>
<p>
<span class="red"><b>Do not leave your PostgreSQL server running
while you are not using it.</b></span>
</p>
<p>
The command for controlling your PostgreSQL
server is:
</p>
<pre>$ <b>~/cs3311/bin/pgs</b>
</pre>
<p>
Once you've set up your environment properly, you should be able to
invoke this command simply by typing <code>pgs</code>.
</p>
<p>
Each time you want to use your PostgreSQL server, you'll need to do
the following:
</p>
<pre>$ <b>ssh grieg</b>                <i>log in to grieg</i>
<span class="comment">... starts a new login session on Grieg ... </span>
$ <b>priv srvr</b>                <i>start your virtual host</i>
$ <b>source /srvr/<i>YOU</i>/env</b>     <i>set up your environment</i>
$ <b>pgs start</b>                <i>start the PostgreSQL server</i>
</pre>
<p>
Remember to do all of the above each time you login to the CSE
machines to do some work with PostgreSQL.
</p>
<div class="note">
<p>
If you ever get an error message like this:
</p>
<pre>$ <b>pgs start</b>
-bash: pgs: command not found
</pre>
<p>
then you probably haven't set up your shell <code>PATH</code>
properly.
</p><p>
If you see the above, you need to <code>source</code> your <code>env</code>
file.
</p>
</div>

<p>
You can check whether your server is running via the command:
</p>
<pre>$ <b>pgs status</b>
</pre>
<p>
If you do have a server running, this command will give you output from
the Unix <code>ps</code> command showing the PostgreSQL processes that
you currently have running. There should be one process that looks like:
</p>
<pre>bin/postgres
</pre>
<p>
and a couple of PostgreSQL <code>writer</code> processes.
If this does not show at least one <code>postgres</code> process,
then your PostgreSQL server is not running.
</p>
<p>
You can stop your server via the command:
</p>
<pre>$ <b>pgs stop</b>
</pre>
<p>
Try checking, stopping, and starting the server a few times.
</p>
<p>
Things occasionally go wrong, and knowing how to deal with them will save
you lots of time. There's a discussion of common problems at the end of
this document; make sure that you read and understand it.
</p>
<p>
Once your PostgreSQL server is running, you can access your PostgreSQL
databases via the <code>psql</code> command.
You normally invoke this command by specifying the name of a database,
e.g.
</p>
<pre>$ <b>psql <i>MyDatabase</i></b>
</pre>
<p>
If you type <code>psql</code> command without any arguments, it assumes
that you are trying to access a database with the same name as your login
name. Since you probably won't have created such a database, you're likely
to get a message like:
</p>
<pre>psql: FATAL:  database "<i>YOU</i>" does not exist
</pre>
<p>
You will get a message like this any time that you try to access a
database that does not exist.
</p>
<p>
If you're not sure what databases you have created, <code>psql</code>
can tell you via the <code>-l</code> option
(that's lower-case 'L' not the digit '1' (one)), e.g.
</p>
<pre>$ <b>psql -l</b>
</pre>
<p>
If you run this command now, you ought to see output that looks like:
</p>
<pre>                             List of databases
   Name    | Owner | Encoding |  Collate   |   Ctype    | Access privileges 
-----------+-------+----------+------------+------------+-------------------
 postgres  | <i>YOU</i>   | LATIN1   | C          | en_AU      | 
 template0 | <i>YOU</i>   | LATIN1   | C          | en_AU      | =c/<i>YOU</i>           +
           |       |          |            |            | <i>YOU</i>=CTc/<i>YOU</i>
 template1 | <i>YOU</i>   | UTF8     | en_US.utf8 | en_US.utf8 | 
(3 rows)
</pre>
<p>
Note that PostgreSQL commands like <code>psql</code> and <tt>createdb</tt>
are a lot noisier than normal Linux commands.
In particular, they all seem to be printing <code>SET</code> when they
run; you can ignore this.
Similarly, if you see output like <nobr><code>INSERT 0 1</code></nobr>,
you can ignore that as well.
</p>
<p>
These three databases are created for use by the PostgreSQL server;
you should not modify them.
At this stage, you don't need to worry about the contents of the other
columns in the output.
As long as you see at least three databases when you run the
<code>psql -l</code> command, it means that your PostgreSQL
server is up and running ok.
</p>
<p>
The way we have set up the PostgreSQL servers on <code>grieg</code>,
each student is the administrator for their own server.
This means that you can create as many databases as
you like (until you run out of disk quota), and make any other
changes that you want to the server configuration.
</p>
<p>
From within <code>psql</code>, the fact that you are an administrator
is indicated by a prompt that looks like
</p>
<pre><i>dbName</i>=#
</pre>
<p>
rather than the prompt for database users
</p>
<pre><i>dbName</i>=&gt;
</pre>
<p>
which you may have seen in textbooks or notes.
</p>
<p>
Note that you can only access databases while you're logged into your
virtual host on <code>grieg</code>.
In other words, you must run the <code>psql</code>
command under your virtual host on <code>grieg</code>.
</p>
<p>
Note that the <b>only</b> commands that you should run on
<code>grieg</code> are the <code>pgs</code> command (to start and stop
the server), the <code>psql</code> command to start an interactive
session with a database, and the other PostgreSQL clients such as
<code>createdb</code>.
Do not run other processes such as web
browsers, drawing programs or editors on <code>grieg</code>. If you
do, <code>grieg</code> will eventually be overwhelmed and you'll
effectively be a contributor to a Denial of Service attack.
</p>
<p>
If you need to edit files while you're using your PostgreSQL server,
run another terminal window on the local machine (not Grieg), and do
the editing there. You don't need to login to Grieg to access files
in the <code>/srvr/<i>YOU</i>/</code> directory, so you can run your
terminal session on the local machine and still access your files on
Grieg.
</p>
<p>
All of the PostgreSQL client applications are documented in the
<a href="http://www.postgresql.org/docs/">PostgreSQL manual</a>.
While there are quite a few of them,
<code>psql</code> will be the one that you will mostly use.
</p>
<div class="note">
<p>
<b>Mini-Exercise:</b> a quick way to check whether your PostgreSQL server
is running is to try the command:
</p>
<pre>$ <b>psql -l</b>
</pre>
<p>
Try this command now.
</p>
<p>
If you get a response like:
</p>
<pre>psql: command not found
</pre>
<p>
then you haven't set up your environment properly; <code>source</code> the
<code>env</code> file.
</p>
<p>
If you get a response like:
</p>
<pre>psql: could not connect to server: No such file or directory
        Is the server running locally and accepting
        connections on Unix domain socket "....s.PGSQL.5432"?
</pre>
then the server isn't running.
<p></p>
<p>
If you get a list of databases, like the example above, then this
means your server is running ok and ready for use.
</p>
</div>

<h4>Cleaning up</h4>

<p>
After you've finished a session with PostgreSQL,
it's essential that you shut your PostgreSql  server down
(to prevent overloading <code>grieg</code>).
You can do this via the command:
</p>
<pre>$ <b>pgs stop</b>
</pre>
<p>
which must be run on your virtual host (i.e. after you've
logged into <code>grieg</code> and run <code>priv srvr</code>).
</p>
<p>
PostgreSQL generates log files that can potentially
grow quite large. If you start your server using
<code>pgs</code>, the log file is called
</p>
<pre>/srvr/<i>YOU</i>/pgsql/Log
</pre>
<p>
It would be worth checking every so often to see how large
it has become.
To clean up the log, simply stop the server and remove the file.
Note: if you remove the logfile while the server is running, you
may not remove it at all; it's link in the filesystem will be gone,
but the disk space will continue to be used and grow until the
server stops.
</p>
<div class="note">
<p>
<b>Mini-Exercise:</b>
Try starting and stopping the server a few times, and running
<code>psql</code> both when the server is running and when it's
not, just to see the kinds of messages you'll get.
</p>
</div>


<h4>Summary</h4>

<p>
A typical session with your virtual host and your
PostgreSQL server would be something like:
</p>
<pre>... <i>on any CSE workstation</i> ...
$ <b>ssh grieg</b>
<span class="comment">... <i>grieg login stuff</i> ...</span>
<span class="comment">... <i>the following are all on grieg</i> ...</span>
$ <b>priv srvr</b>
$ <b>source /srvr/<i>YOU</i>/env</b>
$ <b>pgs start</b>
$ <b>psql <i>MyDatabase</i></b>
... <i>use another xterm for editting</i> ...
$ <b>pgs stop</b>
$ <b>logout</b>
<span class="comment">... <i>back to your original workstation</i> ...</span>
</pre>


<h4>Exercise #1: Making a database</h4>

<p>
Once the PostgreSQL server is running, try creating a database by
running the command:
</p>
<pre>$ <b>createdb mydb</b>
</pre>
<p>
which will create the database, or give an error message if it
can't create it for some reason. (A typical reason for failure would be
that your PostgreSQL server is not running.)
</p><p>
Now use the <code>psql -l</code> command to check that the new database exists.
</p>
<p>
You can access the database by running the command:
</p>
<pre>$ <b>psql mydb</b>
</pre>
<p>
which should give you a message like
</p>
<pre>SET
psql (9.4.6)
Type "help" for help.

mydb=# 
</pre>
<p>
Note that <code>psql</code> lets you execute two kinds of commands:
SQL queries and updates, and <code>psql</code> <q>meta</q>-commands.
The <code>psql</code> <q>meta</q>-commands allow you to examine the
database schema, and control various aspects of <code>psql</code>
itself, such as where it writes its output and how it formats tables.
</p>
<p>
Getting back to the <code>psql</code> session that you just started,
the <code>mydb</code> database is empty, so there's not much you can do
with it.
The <code>\d</code> (describe) command allows you to check what's in
the database.
If you type it now, you get the unsurprising response
</p>
<pre>mydb=# <b>\d</b>
No relations found.
</pre>
<p>
About the only useful thing you can do at the moment
is to quit from <code>psql</code> via the <code>\q</code> command.
</p>
<pre>mydb=# <b>\q</b>
$ ... <i>now waiting for you to type Linux commands</i> ...
</pre>
<p>
Note: it is common to forget which prompt you're looking at and sometimes
type Linux commands to <code>psql</code> or to type SQL queries to the
Linux command interpreter. It usually becomes apparent fairly quickly
what you've done wrong, but can initially be confusing when you think that
the command/query is not behaving as it should.
Here are examples of making the above two mistakes:
</p>
<pre>$ ... <i>Linux command interpreter</i> ...
$ <b>select * from table;</b>
-bash: syntax error near unexpected token `from'
$ <b>psql mydb</b>
... <i>change context to PostgreSQL</i> ...
mydb=# <b>ls -l</b>
mydb-# ... <i>PostgreSQL waits for you to complete what it thinks is an SQL query</i> ...
mydb-# <b>;</b>    ... <i>because semi-colon finishes an SQL query</i> ...
ERROR:  syntax error at or near "ls" at character 1
LINE 1: ls -l
        ^
mydb=# <b>\q</b>
$ ... <i>back to Linux command interpreter</i> ...
</pre>

<h4>Exercise #2: Populating a database</h4>

<p>
Once the <code>mydb</code> database exists, the following command
will create the schemas (tables) and populate them with tuples:
</p>
<pre>$ <b>psql mydb -f /home/cs3311/web/19s1/pracs/02/mydb.sql</b>
</pre>
<p>
Note that this command produces quite a bit of output, telling you
what changes it's making to the database. The output should look like:
</p>
<pre>SET
CREATE TABLE
INSERT 0 1
INSERT 0 1
INSERT 0 1
CREATE TABLE
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
CREATE TABLE
INSERT 0 1
INSERT 0 1
INSERT 0 1
CREATE TABLE
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
INSERT 0 1
</pre>
<p>
The lines containing <code>CREATE TABLE</code> are, obviously, related
to PostgreSQL creating new database tables (there are four of them).
The lines containing <code>INSERT</code> are related to PostgreSQL
 adding new tuples into those tables.
</p>
<p>
Clearly, if we were adding hundreds of tuples to the tables, the output
would be very long. You can get PostgreSQL to stop giving you the
<code>INSERT</code> messages by using the <code>-q</code> option to
the <code>psql</code> command.
</p>
<p>
PostgreSQL's output can be verbose during database loading. If you want
to ignore everything <em>except</em> error messages, you could use a
command like:
</p>
<pre>$ <b>( psql mydb -f /home/cs3311/web/19s1/pracs/02/mydb.sql 2&gt;&amp;1 ) | grep ERROR</b>
</pre>
<p>
If you don't understand the fine details of the above, take a look at the
documentation for the Unix shell.
</p>
<p>
The <code>-f</code> option to <code>psql</code> tells it to read its input
from a file, rather than from standard input (normally, the keyboard).
If you look in the <a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/02/mydb.sql"><code>mydb.sql</code></a> file, you'll find a mix of table
(relation) definitions and statements to insert tuples into the database.
We don't expect you to understand the contents of the file at this stage.
</p>
<p>
If you try to run the above command again, you will generate a heap of
error messages, because you're trying to insert the same collection of
tables and tuples into the database, when they've already been inserted.
</p>
<p>
Note that the tables and tuples are now permanently stored on disk.
If you switch your PostgreSQL server off, when you restart it
the contents of the <code>mydb</code> database will be available,
in whatever state you left them from the last time you used the database.
</p>


<h4>Exercise #3: Examining a database</h4>

<p>
One simple way to manipulate PostgreSQL databases
is to use the <code>psql</code> command (which is a shell
like the <tt>sqlite3</tt> command in the first prac exercise).
A useful way to start exploring a database is to find out what
tables it has. We saw before that you can do this with the
\d (describe) command. Let's try that on the
newly-populated <code>mydb</code> database.
</p>
<pre>mydb=# <b>\d</b>
         List of relations
 Schema |   Name    | Type  | Owner 
--------+-----------+-------+-------
 public | courses   | table | <i>YOU</i>
 public | enrolment | table | <i>YOU</i>
 public | staff     | table | <i>YOU</i>
 public | students  | table | <i>YOU</i>
(4 rows)
</pre>
<p>
You can ignore the <code>Schema</code> column for the time being.
The <code>Name</code> column tells you the names of all tables
(relations) in the current database instance. The <code>Type</code>
column is obvious, and, you may think, unnecessary. It's there because
<code>\d</code> will list all objects in the database, not just tables;
it just happens that there are only tables in this simple database.
The <code>Owner</code> should be your username, for all tables.
</p>
<p>
One thing to notice is that the table names are all in lower-case,
whereas in the <a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/02/mydb.sql"><code>mydb.sql</code></a> file, they had an initial
upper-case letter.
The SQL standard says that case does not matter in identifiers
and so <code>Staff</code> and <code>staff</code> and <code>STAFF</code>
and even <code>StAfF</code> are all equivalent.
To deal with this, PostgreSQL simply maps <em>identifiers</em>
into all lower case internally. You can still use <code>Staff</code>
when you're typing in SQL commands; it will be mapped automatically
before use.
</p>
<div class="note">
<p>
There are, however, advantages to using all lower case whenever
you're dealing with <code>psql</code>. For one thing, it means
that you don't have to keep looking for the shift-key. More
importantly, <code>psql</code> provides table name and field name
completion (you type an initial part of a table name, then type
the TAB key, and <code>psql</code> completes the name for you if
it has sufficient context to determine this unambiguously),
but it only works when you type everything in lower case.
The <code>psql</code> interface has a number of other features
(e.g. history, command line editing) that make it very nice to
use.
</p>
</div>
<p> 
If you want to find out more details about an individual table,
you can use:
</p>
<pre>mydb=# <b>\d Staff</b>
             Table "public.staff"
  Column  |         Type          | Modifiers 
----------+-----------------------+-----------
 userid   | character varying(10) | not null
 name     | character varying(30) | 
 position | character varying(20) | 
 phone    | integer               | 
Indexes:
    "staff_pkey" PRIMARY KEY, btree (userid)
Referenced by:
    TABLE "courses" CONSTRAINT "courses_lecturer_fkey" FOREIGN KEY (lecturer) REFERENCES staff(userid)
</pre>
<p>
As you can see, the complete name of the table is <code>public.staff</code>,
which includes the schema name. PostgreSQL has the notion of a <q>current
schema</q> (which is the schema called <code>public</code>, by default), and
you can abbreviate table names by omitting the current schema name, which is
what we normally do.
The types of each column look slightly different to what's in the
<code>mydb.sql</code> file; these are just PostgreSQL's internal
names for the standard SQL types in the schema file.
You can also see that the <code>userid</code> field is not allowed to be
null; this is because it's the primary key (as you can see from the index
description) and primary keys may not contain null values.
The index description also tells you that PostgreSQL has built a B-tree
index on the <code>userid</code> field.
</p>
<p>
The final line in the output tells you that one of the other tables in
the database (<code>Courses</code>) has a foreign key that refers to the
primary key of the <code>Staff</code> table, which you can easily see
by looking at the <a href="https://cgi.cse.unsw.edu.au/~cs3311/19s1/pracs/02/mydb.sql"><code>mydb.sql</code></a> file.
This is slightly useful for a small database, but becomes extremely
useful for larger databases with many tables.
</p>
<p>
The next thing we want to find out is what data is actually contained in
the tables.
This requires us to use the SQL query language, which you may not know
yet, so we'll briefly explain the SQL statements that we're using, as
we do them.
</p>
<p>
We could find out all the details of staff members as follows:
</p>
<pre>mydb=# <b>select * from Staff;</b>
  userid  |     name      |    position     | phone 
----------+---------------+-----------------+-------
 jingling | Jingling Xue  | Professor       | 54889
 jas      | John Shepherd | Senior Lecturer | 56494
 andrewt  | Andrew Taylor | Senior Lecturer | 55525
(3 rows)
</pre>
<p>
The SQL statement says, more or less, <q>tell me everything (*)
about the contents of the <code>Staff</code> table</q>.
Each row in the output below the heading represents a tuple
in the table.
</p>
<p>
Note that the SQL statement ends with a semi-colon.
The meta-commands that we've seen previously didn't require this,
but SQL statements can be quite large, and so, to allow you to
type them over several lines, the system requires you to type a
semi-colon to mark the end of the SQL statement.
</p>
<p>
If you forget to put a semi-colon, the prompt changes subtly:
</p>
<pre>mydb=# <b>select * from Staff</b>
mydb-# 
</pre>
<p>
This is PostgreSQL's way of telling you that you're in the middle
of an SQL statement and that you'll eventually need to type a semi-colon.
If you then simply type a semi-colon to the second prompt, the
SQL statement will execute as above.
</p>
<div class="note">
<b>Mini-Exercise</b>: find out the contents of the other tables.
<p>
Here are some other SQL statements for you to try out. You don't need
to understand their structure yet, but they'll give you an idea of
the kind of capabilities that the SQL language offers.
</p>
<ul>
<li> Which students are studying for a CS degree (3978)?
<pre>select * from Students where degree=3978;
</pre>
</li><li> How many students are studying for a CS degree?
<pre>select count(*) from Students where degree=3978;
</pre>
</li><li> Who are the professors?
<pre>select * from Staff where position ilike '%professor%';
</pre>
</li><li> How many students are enrolled in each course?
<pre>select course,count(*) from Enrolment group by course;
</pre>
</li><li> Which courses is Andrew Taylor teaching?
<pre>select c.code, c.title
from   Courses c, Staff s
where  s.name='Andrew Taylor' and c.lecturer=s.userid;
</pre>
</li></ul>
<p>
The last query is laid out as we normally lay out more complex
SQL statements: with a keyword starting each line, and each
clause of the SQL statement starting on a separate line.
</p>
<p>
Try experimenting with variations of the above queries.
</p>
</div>


<h3>Sorting out Problems</h3>

<p>
It is very difficult to diagnose problems with software over email,
unless you give sufficient details about the problem.
An email that's as vague as <q>My PostgreSQL server isn't
working. What should I do?</q>, is basically useless.
Any email about problems with software should contain details of
</p>
<ul>
<li> what you were attempting to do
</li><li> precisely what commands you used
</li><li> exactly what output you got 
</li></ul>
<p>
One way to achieve this is to copy-and-paste the last few commands
and responses into your email.
</p>
<p>
Alternatively, you should come to a consultation where we can work
through the problem on a workstation (which is usually very quick).
</p>

<h4>Can't shut server down?</h4>
<p>
When you use <code>pgs stop</code> to shut down your PostgreSQL server,
you'll observe something like:
</p>
<pre>$ <b>pgs stop</b>
Using server in /srvr/<i>YOU</i>/pgsql
waiting for server to shut down....
</pre>
<p>
Dots will keep coming until the server is finally shut down, at which
point you will see:
</p>
<pre>$ <b>pgs stop</b>
Using server in /srvr/<i>YOU</i>/pgsql
waiting for server to shut down........ done
server stopped
</pre>
<p>
Sometimes, you'll end up waiting for a long time and the server still
doesn't shut down. This is typically because you have an <code>psql</code>
session running in some other window (the PostgreSQL server won't shut
down until all clients have disconnected from the server).
The way to fix this is to find the <code>psql</code> session and end it.
If you can find the window where it's running, simply use <code>\q</code>
to quit from <code>psql</code>.
If you can't find the window, or it's running from a different machine
(e.g. you're in the lab and find that you left a <code>psql</code> running
at home), then use <code>ps</code> to find the process id of the
<code>psql</code> session and stop it using the Linux <code>kill</code>
command.
</p>

<h4>Can't restart server?</h4>
<p>
Occasionally, you'll find that 
your PostgreSQL server was not shut down cleanly the last time you
used it and you cannot re-start it next time you try to use it.
We'll discuss how to solve that here ...
</p>
<p>
The typical symptoms of this problem are that you log in to
<code>grieg</code>, set up your environment, try to start
your PostgreSQL server and you get the message:
</p>
<pre>PGDATA=/srvr/<i>YOU</i>/pgsql
pg_ctl: another server may be running; trying to start server anyway
server starting   <span class="comment">... this really means "I'm trying to start the server"</span>
!!!
The PostgreSQL server may not have started correctly.
First try the 'psql -l' command to see if it is actually working.
If it's not, then check at the end of the log file for more details.
The log file is called: /srvr/<i>YOU</i>/pgsql/Log
</pre>
<p>
If you actually go and check the log file, you'll probably find,
right at the end, something like:
</p>
<pre>$ <b>tail -2 /srvr/<i>YOU</i>/logfile</b>
FATAL:  lock file "postmaster.pid" already exists
HINT:  Is another postmaster (PID <i>NNNN</i>) running in data directory "/srvr/<i>YOU</i>/pgsql"?
</pre>
<p>
where <code><i>NNNN</i></code> is a number.
</p>
<p>
There are two possible causes for this: the server is already running,
or the server did not terminate properly after the last time you used it.
You can check whether the server is currently running by the command
<code>psql -l</code>. If that gives you a list of your databases, then
you simply forgot to shut the server down last time you used it and it's
ready for you to use again. If <code>psql -l</code> tells you that
there's no server running, then you'll need to do some cleaning up
before you can restart the server ...
</p>
<p>
When the PostgreSQL server is run, it keeps a record of the Unix process
that it's running as in a file called:
</p>
<pre>/srvr/<i>YOU</i>/pgsql/postmaster.pid
</pre>
<p>
Normally when your PostgreSQL server process terminates (e.g. via
<code>pgs stop</code>), this file will be removed. If your PostgreSQL
server stops, and this file persists, then <code>pgs</code> becomes
confused and thinks that there is still a PostgreSQL server running
even though there isn't.
</p>
The first step in cleaning up is to remove this file:
<pre>$ <b>rm /srvr/<i>YOU</i>/pgsql/postmaster.pid</b>
</pre>
<p>
You should also clean up the socket files used by the PostgreSQL
server. You can do this via the command:
</p>
<pre>$ <b>rm /srvr/<i>YOU</i>/pgsql/.s*</b>
</pre>
<p>
Once you've cleaned all of this up, then the <code>pgs</code>
command ought to allow you to start your PostgreSQL server ok.
</p>
</body></html>